name: BV APK Sync from Source Repository

on:
  schedule:
    - cron: '0 */24 * * *'  # æ¯24å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config pull.rebase true  # é…ç½®rebaseç­–ç•¥
        # æå‰è®¾ç½®å¸¦è®¤è¯çš„è¿œç¨‹URL
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        
    # æ·»åŠ ä»“åº“é”æœºåˆ¶é˜²æ­¢å¹¶å‘æ›´æ–°
    - name: Acquire Repository Lock ğŸ”’
      uses: softprops/turnstyle@v1
      with:
        same-branch-only: true
        poll-interval-seconds: 30
        abort-after-seconds: 1200  # 20åˆ†é’Ÿè¶…æ—¶

    - name: Run APK sync script
      env:
        SOURCE_REPO: "aaa1115910/bv"
        TARGET_REPO: "${{ github.repository }}"
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
        STABLE_APK_PATTERN: "release_default_universal.apk"  # ç¨³å®šç‰ˆåŒ¹é…æ¨¡å¼
        PRE_RELEASE_APK_PATTERN: "alpha_default_universal.apk"  # é¢„å‘è¡Œç‰ˆåŒ¹é…æ¨¡å¼
        STABLE_KEY_NAME: "bv.apk"
        PRE_RELEASE_KEY_NAME: "bv-beta.apk"
      run: |
        set -euo pipefail  # ä¸¥æ ¼é”™è¯¯å¤„ç†
        
        # ä»ç¯å¢ƒå˜é‡è·å–é…ç½®
        STABLE_TARGET_FILENAME="apk/$STABLE_KEY_NAME"
        PRE_RELEASE_TARGET_FILENAME="apk/$PRE_RELEASE_KEY_NAME"
        
        # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
        WORK_DIR=$(mktemp -d)
        echo "åˆ›å»ºä¸´æ—¶ç›®å½•: $WORK_DIR"
        trap 'rm -rf "$WORK_DIR"; echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."' EXIT

        # éªŒè¯ä»¤ç‰Œè®¿é—®æƒé™
        echo "éªŒè¯GitHubä»¤ç‰Œæƒé™..."
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $TOKEN" \
                  "https://api.github.com/repos/$TARGET_REPO")
        if [ "$RESPONSE" != "200" ]; then
          echo "é”™è¯¯: ä»¤ç‰Œæ— æ•ˆ (HTTP $RESPONSE)"
          echo "è¯·æ£€æŸ¥å·¥ä½œæµæƒé™è®¾ç½®"
          exit 1
        fi

        # è·å–æœ€æ–°å‘å¸ƒçš„APKä¸‹è½½é“¾æ¥
        echo "è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬ä¿¡æ¯..."

        # è·å–æ‰€æœ‰å‘å¸ƒï¼ˆåŒ…æ‹¬é¢„å‘è¡Œç‰ˆï¼‰
        RELEASES_JSON=$(curl -sL "https://api.github.com/repos/$SOURCE_REPO/releases")
        if [ $? -ne 0 ]; then
          echo "é”™è¯¯: æ— æ³•è·å–å‘å¸ƒä¿¡æ¯"
          exit 1
        fi
        
        # è°ƒè¯•ï¼šè¾“å‡ºAPIå“åº”
        echo "APIå“åº”:"
        echo "$RELEASES_JSON" | jq . > "$WORK_DIR/releases.json"
        head -n 50 "$WORK_DIR/releases.json"

        # æå–æœ€æ–°ç¨³å®šç‰ˆ - å¢å¼ºé”™è¯¯å¤„ç†
        SYNC_STABLE=true
        LATEST_STABLE_RELEASE=$(echo "$RELEASES_JSON" | jq -r 'map(select(.prerelease == false)) | sort_by(.published_at) | reverse | .[0]')
        if [ -z "$LATEST_STABLE_RELEASE" ] || [ "$LATEST_STABLE_RELEASE" = "null" ]; then
          echo "è­¦å‘Š: æ— æ³•æå–ç¨³å®šç‰ˆå‘å¸ƒä¿¡æ¯ï¼Œè·³è¿‡ç¨³å®šç‰ˆåŒæ­¥"
          SYNC_STABLE=false
        else
          # æ”¹è¿›ç‰ˆæœ¬æå–é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨æ ‡ç­¾(tag_name)ï¼Œå¦‚æœä¸å®Œæ•´åˆ™ä½¿ç”¨æ ‡é¢˜(name)
          TAG_VERSION=$(echo "$LATEST_STABLE_RELEASE" | jq -r '.tag_name // ""')
          TITLE_VERSION=$(echo "$LATEST_STABLE_RELEASE" | jq -r '.name // ""')
          
          # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·ï¼ˆæ”¯æŒvå‰ç¼€ï¼‰
          if [[ "$TAG_VERSION" =~ v?([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            STABLE_VERSION="v${BASH_REMATCH[1]}"
            echo "ä»æ ‡ç­¾æå–ç¨³å®šç‰ˆ: $STABLE_VERSION"
          # å¦‚æœæ ‡ç­¾ä¸å®Œæ•´ï¼Œå°è¯•ä»æ ‡é¢˜ä¸­æå–
          elif [[ "$TITLE_VERSION" =~ ([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            STABLE_VERSION="v${BASH_REMATCH[1]}"
            echo "ä»æ ‡é¢˜æå–ç¨³å®šç‰ˆ: $STABLE_VERSION"
          else
            # å¦‚æœéƒ½æ— æ³•æå–ï¼Œä½¿ç”¨åŸå§‹æ ‡ç­¾
            STABLE_VERSION="$TAG_VERSION"
            echo "ä½¿ç”¨åŸå§‹æ ‡ç­¾ä½œä¸ºç¨³å®šç‰ˆ: $STABLE_VERSION"
          fi
          
          STABLE_PUBLISHED_AT=$(echo "$LATEST_STABLE_RELEASE" | jq -r '.published_at')
          # è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´å¹¶æ ¼å¼åŒ–ä¸º YYYY-MM-DD
          STABLE_DATE_UTC8=$(TZ=UTC date -d "$STABLE_PUBLISHED_AT" +'%Y-%m-%d')
          echo "æºä»“åº“æœ€æ–°ç¨³å®šç‰ˆ: $STABLE_VERSION (å‘å¸ƒäº: $STABLE_DATE_UTC8)"
        fi

        # æå–æœ€æ–°é¢„å‘è¡Œç‰ˆ
        SYNC_PRE_RELEASE=true
        LATEST_PRE_RELEASE=$(echo "$RELEASES_JSON" | jq -r 'map(select(.prerelease == true)) | sort_by(.published_at) | reverse | .[0]')
        if [ -z "$LATEST_PRE_RELEASE" ] || [ "$LATEST_PRE_RELEASE" = "null" ]; then
          echo "è­¦å‘Š: æ— æ³•æå–é¢„å‘è¡Œç‰ˆå‘å¸ƒä¿¡æ¯ï¼Œè·³è¿‡é¢„å‘è¡Œç‰ˆåŒæ­¥"
          SYNC_PRE_RELEASE=false
        else
          # æ”¹è¿›é¢„å‘å¸ƒç‰ˆæœ¬æå–é€»è¾‘
          TAG_VERSION=$(echo "$LATEST_PRE_RELEASE" | jq -r '.tag_name // ""')
          TITLE_VERSION=$(echo "$LATEST_PRE_RELEASE" | jq -r '.name // ""')
          
          # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·
          if [[ "$TAG_VERSION" =~ v?([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            PRE_RELEASE_VERSION="v${BASH_REMATCH[1]}"
            echo "ä»æ ‡ç­¾æå–é¢„å‘è¡Œç‰ˆ: $PRE_RELEASE_VERSION"
          # å¦‚æœæ ‡ç­¾ä¸å®Œæ•´ï¼Œå°è¯•ä»æ ‡é¢˜ä¸­æå–
          elif [[ "$TITLE_VERSION" =~ ([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            PRE_RELEASE_VERSION="v${BASH_REMATCH[1]}"
            echo "ä»æ ‡é¢˜æå–é¢„å‘è¡Œç‰ˆ: $PRE_RELEASE_VERSION"
          else
            # å¦‚æœéƒ½æ— æ³•æå–ï¼Œä½¿ç”¨åŸå§‹æ ‡ç­¾
            PRE_RELEASE_VERSION="$TAG_VERSION"
            echo "ä½¿ç”¨åŸå§‹æ ‡ç­¾ä½œä¸ºé¢„å‘è¡Œç‰ˆ: $PRE_RELEASE_VERSION"
          fi
          
          PRE_RELEASE_PUBLISHED_AT=$(echo "$LATEST_PRE_RELEASE" | jq -r '.published_at')
          # è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´å¹¶æ ¼å¼åŒ–ä¸º YYYY-MM-DD
          PRE_RELEASE_DATE_UTC8=$(TZ=UTC date -d "$PRE_RELEASE_PUBLISHED_AT" +'%Y-%m-%d')
          echo "æºä»“åº“æœ€æ–°é¢„å‘è¡Œç‰ˆ: $PRE_RELEASE_VERSION (å‘å¸ƒäº: $PRE_RELEASE_DATE_UTC8)"
        fi

        # è·å–ç›®æ ‡ä»“åº“å½“å‰ç‰ˆæœ¬æ–‡ä»¶
        echo "è·å–ç›®æ ‡ä»“åº“å½“å‰ç‰ˆæœ¬æ–‡ä»¶..."
        TARGET_VERSION_JSON=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$TARGET_REPO/contents/version.txt")

        # æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ "$(echo "$TARGET_VERSION_JSON" | jq -r '.message')" != "Not Found" ]; then
          # æå–å†…å®¹å¹¶è§£ç 
          VERSION_CONTENT=$(echo "$TARGET_VERSION_JSON" | jq -r '.content' | base64 -d)
          echo "ç‰ˆæœ¬æ–‡ä»¶å†…å®¹:"
          echo "$VERSION_CONTENT"
          
          # å°è¯•è§£æJSON
          if ! CURRENT_VERSION_DATA=$(echo "$VERSION_CONTENT" | jq .); then
            echo "è­¦å‘Š: ç‰ˆæœ¬æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œé‡ç½®ä¸ºJSONæ ¼å¼"
            CURRENT_VERSION_DATA="{}"
            CURRENT_STABLE_VERSION=""
            CURRENT_STABLE_DATE=""
            CURRENT_PRE_RELEASE_VERSION=""
            CURRENT_PRE_RELEASE_DATE=""
          else
            # è·å–å½“å‰ç¨³å®šç‰ˆç‰ˆæœ¬å’Œæ—¥æœŸ
            STABLE_FULL_VALUE=$(echo "$VERSION_CONTENT" | jq -r ".\"$STABLE_KEY_NAME\"")
            if [ "$STABLE_FULL_VALUE" != "null" ] && [[ "$STABLE_FULL_VALUE" == *,* ]]; then
              CURRENT_STABLE_VERSION=$(echo "$STABLE_FULL_VALUE" | cut -d, -f1)
              CURRENT_STABLE_DATE=$(echo "$STABLE_FULL_VALUE" | cut -d, -f2)
            else
              CURRENT_STABLE_VERSION=""
              CURRENT_STABLE_DATE=""
            fi
            echo "ç›®æ ‡ä»“åº“å½“å‰ç¨³å®šç‰ˆç‰ˆæœ¬: $CURRENT_STABLE_VERSION (æ—¥æœŸ: $CURRENT_STABLE_DATE)"
            
            # è·å–å½“å‰é¢„å‘è¡Œç‰ˆç‰ˆæœ¬å’Œæ—¥æœŸ
            PRE_RELEASE_FULL_VALUE=$(echo "$VERSION_CONTENT" | jq -r ".\"$PRE_RELEASE_KEY_NAME\"")
            if [ "$PRE_RELEASE_FULL_VALUE" != "null" ] && [[ "$PRE_RELEASE_FULL_VALUE" == *,* ]]; then
              CURRENT_PRE_RELEASE_VERSION=$(echo "$PRE_RELEASE_FULL_VALUE" | cut -d, -f1)
              CURRENT_PRE_RELEASE_DATE=$(echo "$PRE_RELEASE_FULL_VALUE" | cut -d, -f2)
            else
              CURRENT_PRE_RELEASE_VERSION=""
              CURRENT_PRE_RELEASE_DATE=""
            fi
            echo "ç›®æ ‡ä»“åº“å½“å‰é¢„å‘è¡Œç‰ˆç‰ˆæœ¬: $CURRENT_PRE_RELEASE_VERSION (æ—¥æœŸ: $CURRENT_PRE_RELEASE_DATE)"
          fi
        else
          echo "ç›®æ ‡ä»“åº“æ— ç‰ˆæœ¬æ–‡ä»¶"
          CURRENT_VERSION_DATA="{}"
          CURRENT_STABLE_VERSION=""
          CURRENT_STABLE_DATE=""
          CURRENT_PRE_RELEASE_VERSION=""
          CURRENT_PRE_RELEASE_DATE=""
        fi

        # å‡½æ•°ï¼šæ£€æŸ¥å¹¶ä¸‹è½½APK
        check_and_download_apk() {
          local release_json="$1"
          local target_filename="$2"
          local key_name="$3"
          local current_version="$4"
          local apk_pattern="$5"
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
          local latest_version=$(echo "$release_json" | jq -r '.tag_name')
          
          # æ£€æŸ¥ç›®æ ‡ä»“åº“ä¸­APKæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "æ£€æŸ¥ç›®æ ‡ä»“åº“ä¸­APKæ–‡ä»¶æ˜¯å¦å­˜åœ¨: $target_filename..."
          local APK_EXIST_RESPONSE
          APK_EXIST_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$TARGET_REPO/contents/$target_filename")
          
          local apk_exists=false
          if [ "$APK_EXIST_RESPONSE" -eq 200 ]; then
            echo "ç›®æ ‡ä»“åº“ä¸­å­˜åœ¨APKæ–‡ä»¶: $target_filename"
            apk_exists=true
          else
            echo "ç›®æ ‡ä»“åº“ä¸­ä¸å­˜åœ¨APKæ–‡ä»¶: $target_filename (HTTP $APK_EXIST_RESPONSE)"
          fi
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
          local need_update=false
          
          # æƒ…å†µ1: ç‰ˆæœ¬å·ä¸åŒ¹é…
          if [ "$latest_version" != "$current_version" ]; then
            echo "å‘ç°æ–°ç‰ˆæœ¬: $latest_version (å½“å‰: $current_version)"
            need_update=true
          # æƒ…å†µ2: ç‰ˆæœ¬å·åŒ¹é…ä½†æ–‡ä»¶ä¸å­˜åœ¨
          elif [ "$apk_exists" = false ]; then
            echo "ç‰ˆæœ¬å·åŒ¹é…ä½†APKæ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ "
            need_update=true
          # æƒ…å†µ3: ç‰ˆæœ¬å·åŒ¹é…ä½†ç‰ˆæœ¬æ–‡ä»¶æ— æ•ˆ
          elif [ -z "$current_version" ]; then
            echo "ç‰ˆæœ¬æ–‡ä»¶æ— æ•ˆï¼Œéœ€è¦æ›´æ–°"
            need_update=true
          else
            echo "ç‰ˆæœ¬ç›¸åŒ ($latest_version) ä¸”APKæ–‡ä»¶å­˜åœ¨ï¼Œæ— éœ€æ›´æ–°"
          fi
          
          # å¦‚æœéœ€è¦æ›´æ–°ï¼Œå°è¯•ä¸‹è½½APK
          if [ "$need_update" = true ]; then
            # æŸ¥æ‰¾åŒ¹é…çš„APKæ–‡ä»¶
            local download_url
            download_url=$(echo "$release_json" | jq -r '.assets[] | select(.name | contains("'"$apk_pattern"'")) | .browser_download_url' | head -1)
            
            if [ -z "$download_url" ] || [ "$download_url" = "null" ]; then
              echo "è­¦å‘Š: æºä»“åº“é™„ä»¶æ’¤å›ï¼Œæ— æ³•æ‰¾åˆ°åŒ¹é…çš„APKæ–‡ä»¶ (åŒ¹é…æ¨¡å¼: $apk_pattern)"
              return 0
            fi
            
            local source_apk_name=$(basename "$download_url")
            echo "ä¸‹è½½APK: $source_apk_name (åŒ¹é…æ¨¡å¼: $apk_pattern)"
            curl -sL "$download_url" -o "$WORK_DIR/$source_apk_name"
            if [ ! -f "$WORK_DIR/$source_apk_name" ]; then
              echo "é”™è¯¯: APKä¸‹è½½å¤±è´¥"
              return 1
            fi
            
            local simple_target_filename=$(basename "$target_filename")
            mv "$WORK_DIR/$source_apk_name" "$WORK_DIR/$simple_target_filename"
            echo "æ–‡ä»¶å·²é‡å‘½åä¸º: $simple_target_filename"
            
            return 0
          else
            return 0
          fi
        }

        # å‡½æ•°ï¼šä¸Šä¼ APKæ–‡ä»¶
        upload_apk() {
          local target_filename="$1"
          local latest_version="$2"
          local is_prerelease="$3"
          
          echo "ä¸Šä¼ APKæ–‡ä»¶: $target_filename..."
          
          # è·å–ä»“åº“å½“å‰å†…å®¹
          local CONTENT_JSON
          CONTENT_JSON=$(curl -s -H "Authorization: token $TOKEN" \
                          "https://api.github.com/repos/$TARGET_REPO/contents/$target_filename")
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          local sha=""
          if [ "$(echo "$CONTENT_JSON" | jq -r '.message')" != "Not Found" ]; then
            sha=$(echo "$CONTENT_JSON" | jq -r '.sha')
          fi
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          local commit_msg="æ›´æ–°APK: $target_filename åˆ°ç‰ˆæœ¬: $latest_version"
          if [ "$is_prerelease" = "true" ]; then
            commit_msg="$commit_msg (é¢„å‘è¡Œç‰ˆ)"
          fi
          
          # è·å–ç®€å•æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰
          local simple_target_filename=$(basename "$target_filename")
          
          # åˆ›å»ºJSONè¯·æ±‚æ–‡ä»¶
          local json_file="$WORK_DIR/request_$simple_target_filename.json"
          
          # æ‰‹åŠ¨æ„å»ºJSONæ–‡ä»¶ï¼Œé¿å…å¤§æ–‡ä»¶å‚æ•°é—®é¢˜
          {
            echo '{'
            echo "  \"message\": \"$commit_msg\","
            echo -n '  "content": "'
            base64 -w0 "$WORK_DIR/$simple_target_filename" | tr -d '\n'
            echo '",'
            echo "  \"sha\": \"$sha\""
            echo '}'
          } > "$json_file"
          
          # ä½¿ç”¨--data-binaryä¸Šä¼ ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†å¤§æ–‡ä»¶
          local RESPONSE_JSON
          RESPONSE_JSON=$(curl -s \
                -X PUT \
                -H "Authorization: token $TOKEN" \
                -H "Content-Type: application/json" \
                --data-binary "@$json_file" \
                "https://api.github.com/repos/$TARGET_REPO/contents/$target_filename")
          
          # æ£€æŸ¥é”™è¯¯
          local error_message=$(echo "$RESPONSE_JSON" | jq -r '.message')
          if [ "$error_message" != "null" ] && [ ! -z "$error_message" ]; then
            echo "é”™è¯¯: æ–‡ä»¶ä¸Šä¼ å¤±è´¥ - $error_message"
            echo "å®Œæ•´å“åº”:"
            echo "$RESPONSE_JSON"
            return 1
          else
            echo "ä¸Šä¼ æˆåŠŸ: $target_filename ($latest_version)"
            return 0
          fi
        }

        # å¤„ç†ç¨³å®šç‰ˆï¼ˆä½¿ç”¨STABLE_APK_PATTERNï¼‰
        STABLE_NEED_UPDATE=false
        if [ "$SYNC_STABLE" = true ]; then
          echo "===== å¤„ç†ç¨³å®šç‰ˆ ====="
          check_and_download_apk "$LATEST_STABLE_RELEASE" "$STABLE_TARGET_FILENAME" "$STABLE_KEY_NAME" "$CURRENT_STABLE_VERSION" "$STABLE_APK_PATTERN"
          STABLE_RESULT=$?
          if [ $STABLE_RESULT -eq 0 ]; then
            # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆé€šè¿‡æ–‡ä»¶å†…å®¹åˆ¤æ–­ï¼‰
            if [ -f "$WORK_DIR/$STABLE_KEY_NAME" ]; then
              STABLE_NEED_UPDATE=true
              NEW_STABLE_VERSION="$STABLE_VERSION"
              NEW_STABLE_DATE="$STABLE_DATE_UTC8"
              echo "ç¨³å®šç‰ˆéœ€è¦æ›´æ–°"
            else
              NEW_STABLE_VERSION="$CURRENT_STABLE_VERSION"
              NEW_STABLE_DATE="$CURRENT_STABLE_DATE"
              echo "ç¨³å®šç‰ˆæ— éœ€æ›´æ–°"
            fi
          else
            echo "é”™è¯¯: ç¨³å®šç‰ˆå¤„ç†å¤±è´¥"
            exit 1
          fi
        else
          NEW_STABLE_VERSION="$CURRENT_STABLE_VERSION"
          NEW_STABLE_DATE="$CURRENT_STABLE_DATE"
          echo "è·³è¿‡ç¨³å®šç‰ˆå¤„ç†"
        fi

        # å¤„ç†é¢„å‘è¡Œç‰ˆï¼ˆä½¿ç”¨PRE_RELEASE_APK_PATTERNï¼‰
        PRE_RELEASE_NEED_UPDATE=false
        if [ "$SYNC_PRE_RELEASE" = true ]; then
          echo "===== å¤„ç†é¢„å‘è¡Œç‰ˆ ====="
          check_and_download_apk "$LATEST_PRE_RELEASE" "$PRE_RELEASE_TARGET_FILENAME" "$PRE_RELEASE_KEY_NAME" "$CURRENT_PRE_RELEASE_VERSION" "$PRE_RELEASE_APK_PATTERN"
          PRE_RELEASE_RESULT=$?
          if [ $PRE_RELEASE_RESULT -eq 0 ]; then
            if [ -f "$WORK_DIR/$PRE_RELEASE_KEY_NAME" ]; then
              PRE_RELEASE_NEED_UPDATE=true
              NEW_PRE_RELEASE_VERSION="$PRE_RELEASE_VERSION"
              NEW_PRE_RELEASE_DATE="$PRE_RELEASE_DATE_UTC8"
              echo "é¢„å‘è¡Œç‰ˆéœ€è¦æ›´æ–°"
            else
              NEW_PRE_RELEASE_VERSION="$CURRENT_PRE_RELEASE_VERSION"
              NEW_PRE_RELEASE_DATE="$CURRENT_PRE_RELEASE_DATE"
              echo "é¢„å‘è¡Œç‰ˆæ— éœ€æ›´æ–°"
            fi
          else
            echo "é”™è¯¯: é¢„å‘è¡Œç‰ˆå¤„ç†å¤±è´¥"
            exit 1
          fi
        else
          NEW_PRE_RELEASE_VERSION="$CURRENT_PRE_RELEASE_VERSION"
          NEW_PRE_RELEASE_DATE="$CURRENT_PRE_RELEASE_DATE"
          echo "è·³è¿‡é¢„å‘è¡Œç‰ˆå¤„ç†"
        fi

        # æ›´æ–°ç‰ˆæœ¬æ•°æ®ï¼ˆæ ¼å¼ï¼šç‰ˆæœ¬å·,æ—¥æœŸï¼‰
        NEW_VERSION_DATA=$(echo "$CURRENT_VERSION_DATA" | jq \
            --arg stable_key "$STABLE_KEY_NAME" \
            --arg stable_value "$NEW_STABLE_VERSION,$NEW_STABLE_DATE" \
            --arg pre_key "$PRE_RELEASE_KEY_NAME" \
            --arg pre_value "$NEW_PRE_RELEASE_VERSION,$NEW_PRE_RELEASE_DATE" \
            '.[$stable_key] = $stable_value | .[$pre_key] = $pre_value')
            
        NEW_VERSION_CONTENT=$(echo "$NEW_VERSION_DATA" | jq -r .)

        echo "æ›´æ–°åçš„ç‰ˆæœ¬æ–‡ä»¶å†…å®¹:"
        echo "$NEW_VERSION_CONTENT"

        # ä¸Šä¼ ç‰ˆæœ¬æ–‡ä»¶
        echo "æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶..."
        VERSION_JSON=$(curl -s -H "Authorization: token $TOKEN" \
                        "https://api.github.com/repos/$TARGET_REPO/contents/version.txt")

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        SHA_VERSION=""
        if [ "$(echo "$VERSION_JSON" | jq -r '.message')" != "Not Found" ]; then
          SHA_VERSION=$(echo "$VERSION_JSON" | jq -r '.sha')
        fi

        # Base64ç¼–ç ç‰ˆæœ¬æ–‡ä»¶
        VERSION_BASE64=$(echo -n "$NEW_VERSION_CONTENT" | base64 -w0)

        # åˆ›å»ºJSONæ•°æ®
        JSON_VERSION=$(jq -n \
            --arg msg "æ›´æ–°ç‰ˆæœ¬å·: ç¨³å®šç‰ˆ=$NEW_STABLE_VERSION, é¢„å‘è¡Œç‰ˆ=$NEW_PRE_RELEASE_VERSION" \
            --arg content "$VERSION_BASE64" \
            --arg sha "$SHA_VERSION" \
            '{message: $msg, content: $content, sha: $sha}')

        # ä¸Šä¼ ç‰ˆæœ¬æ–‡ä»¶
        echo "ä¸Šä¼ ç‰ˆæœ¬æ–‡ä»¶..."
        VERSION_RESPONSE=$(curl -s \
                  -X PUT \
                  -H "Authorization: token $TOKEN" \
                  -H "Content-Type: application/json" \
                  -d "$JSON_VERSION" \
                  "https://api.github.com/repos/$TARGET_REPO/contents/version.txt")

        # æ£€æŸ¥é”™è¯¯
        ERROR_MESSAGE_VERSION=$(echo "$VERSION_RESPONSE" | jq -r '.message')
        if [ "$ERROR_MESSAGE_VERSION" != "null" ]; then
          echo "é”™è¯¯: ç‰ˆæœ¬æ–‡ä»¶ä¸Šä¼ å¤±è´¥ - $ERROR_MESSAGE_VERSION"
          exit 1
        fi

        # ä¸Šä¼ ç¨³å®šç‰ˆAPKï¼ˆå¦‚æœéœ€è¦ï¼‰
        if [ "$STABLE_NEED_UPDATE" = true ]; then
          upload_apk "$STABLE_TARGET_FILENAME" "$STABLE_VERSION" "false"
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯: ç¨³å®šç‰ˆAPKä¸Šä¼ å¤±è´¥"
            exit 1
          fi
        fi

        # ä¸Šä¼ é¢„å‘è¡Œç‰ˆAPKï¼ˆå¦‚æœéœ€è¦ï¼‰
        if [ "$PRE_RELEASE_NEED_UPDATE" = true ]; then
          upload_apk "$PRE_RELEASE_TARGET_FILENAME" "$PRE_RELEASE_VERSION" "true"
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯: é¢„å‘è¡Œç‰ˆAPKä¸Šä¼ å¤±è´¥"
            exit 1
          fi
        fi

        echo "åŒæ­¥å®Œæˆ! çŠ¶æ€: æˆåŠŸ"
        echo "ç¨³å®šç‰ˆ: $STABLE_TARGET_FILENAME ($NEW_STABLE_VERSION, $NEW_STABLE_DATE)"
        if [ "$SYNC_PRE_RELEASE" = true ]; then
          echo "é¢„å‘è¡Œç‰ˆ: $PRE_RELEASE_TARGET_FILENAME ($NEW_PRE_RELEASE_VERSION, $NEW_PRE_RELEASE_DATE)"
        fi
        
        # æ€»æ˜¯ä»¥æˆåŠŸçŠ¶æ€é€€å‡º
        exit 0

    # ========== æäº¤å‰æ‹‰å–æœ€æ–°æ›´æ”¹ ==========
    - name: Pull latest changes before commit
      run: |
        echo "æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
        git pull --rebase origin main
        echo "å·²åŒæ­¥è¿œç¨‹æœ€æ–°æ›´æ”¹"

    - name: Commit and Push Changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git diff-index --quiet HEAD --; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          exit 0
        fi

        # æ·»åŠ å˜æ›´å¹¶æäº¤
        git add apk/ version.txt
        git commit -m "åŒæ­¥BV APKæ›´æ–° [${{ github.run_id }}]"
        
        # å®‰å…¨å¼ºåˆ¶æ¨é€
        echo "æ¨é€æ›´æ”¹..."
        git push --force-with-lease origin HEAD:${{ github.ref }}
        echo "æ¨é€æˆåŠŸ"
        
    # ç¡®ä¿è§£é”ä»“åº“
    - name: Release Repository Lock ğŸ”“
      if: always()  # æ— è®ºå‰é¢æ­¥éª¤æˆåŠŸä¸å¦éƒ½æ‰§è¡Œ
      uses: softprops/turnstyle@v1
      with:
        continue-on-error: true  # å³ä½¿è§£é”å¤±è´¥ä¹Ÿä¸ä¸­æ–­å·¥ä½œæµ
        action: unlock  # æŒ‡å®šè§£é”æ“ä½œ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup_self:
    name: Cleanup Self Workflow History
    runs-on: ubuntu-latest
    needs: sync
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "BV APK Sync from Source Repository"
          repository: ${{ github.repository }}