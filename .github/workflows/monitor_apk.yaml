name: APK Update Monitor

on:
  push:
    paths:
      - 'apk/**'
  workflow_dispatch:

jobs:
  detect-and-notify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # å…³é”®ä¿®å¤ï¼šè·å–æœ€è¿‘2ä¸ªæäº¤ç”¨äºå·®å¼‚æ¯”è¾ƒ

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libgit2-dev
        pip install telethon pygit2

    - name: Run detection script
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        cat << 'EOF' > detect_apk_changes.py
        import os
        import re
        import pygit2
        from datetime import datetime
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        def extract_version(filename):
            """ç›´æ¥ä»APKæ–‡ä»¶åä¸­æå–ç‰ˆæœ¬å·ï¼ˆæ›´å¯é ï¼‰"""
            patterns = [
                r'(\d+\.\d+\.\d+)',  # v1.2.3
                r'(\d+\.\d+)',       # v1.2
                r'[^\d]*(\d+)'       # v123
            ]
            for pattern in patterns:
                match = re.search(pattern, filename)
                if match:
                    return match.group(1)
            return "unknown"
        
        def main():
            repo = pygit2.Repository('.')
            head = repo.head
            if len(head.peel().parents) < 1:
                print("Initial commit - no previous version")
                return
            
            # è·å–å½“å‰å’Œä¸Šä¸€ä¸ªæäº¤
            new_commit = head.peel()
            old_commit = new_commit.parents[0]
            
            # è®¡ç®—å·®å¼‚
            diff = repo.diff(old_commit, new_commit)
            changed_apks = []
            
            for delta in diff.deltas:
                file_path = delta.new_file.path if delta.new_file.path else delta.old_file.path
                
                # ä¿®æ­£è·¯å¾„æ£€æµ‹ï¼šå…¼å®¹GitHubå·¥ä½œç©ºé—´ç»“æ„
                if not re.match(r'^(apk/|.*/apk/)', file_path):
                    continue
                    
                if delta.status in (pygit2.GIT_DELTA_ADDED, pygit2.GIT_DELTA_MODIFIED):
                    # ç›´æ¥ä»æ–‡ä»¶åæå–ç‰ˆæœ¬
                    version = extract_version(os.path.basename(file_path))
                    
                    # è·å–æ–‡ä»¶æäº¤æ—¶é—´ï¼ˆä½¿ç”¨å½“å‰æäº¤æ—¶é—´ï¼‰
                    commit_time = datetime.fromtimestamp(new_commit.commit_time).strftime('%Y-%m-%d')
                    
                    # æ„å»ºä¸‹è½½URL
                    raw_url = f"https://raw.githubusercontent.com/{os.getenv('GITHUB_REPOSITORY')}/{new_commit.id}/{file_path}"
                    
                    changed_apks.append({
                        "name": os.path.basename(file_path),
                        "version": version,
                        "date": commit_time,
                        "url": raw_url
                    })
            
            if not changed_apks:
                print("No APK changes detected.")
                return
            
            # æ„å»ºTelegramæ¶ˆæ¯
            message = "ğŸ“± *APK æ›´æ–°é€šçŸ¥*\n\n"
            for apk in changed_apks:
                message += f"ğŸ”¹ [{apk['name']}]({apk['url']})\n"
                message += f"   ç‰ˆæœ¬: `{apk['version']}` | æ—¥æœŸ: `{apk['date']}`\n\n"
            
            # å‘é€åˆ°Telegram
            client = TelegramClient(
                StringSession(os.getenv("TELEGRAM_SESSION")),
                int(os.getenv("TELEGRAM_API_ID")),
                os.getenv("TELEGRAM_API_HASH")
            )
            
            async def send_message():
                await client.send_message(
                    entity=os.getenv("TELEGRAM_CHANNEL"),
                    message=message,
                    parse_mode='markdown',
                    link_preview=False
                )
            
            with client:
                client.loop.run_until_complete(send_message())
            print("Telegram notification sent successfully.")
        
        if __name__ == "__main__":
            main()
        EOF
        
        python detect_apk_changes.py