name: APK Update Monitor

on:
  push:
    paths:
      - 'apk/**'

jobs:
  detect-and-notify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´æäº¤åŽ†å²

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libgit2-dev
        python -m pip install --upgrade pip
        pip install telethon pygit2

    - name: Run detection script
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        mkdir -p .github/scripts
        cat > .github/scripts/detect_apk_changes.py << 'EOF'
        import os
        import re
        import pygit2
        from datetime import datetime
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        def get_file_latest_commit(repo, file_path):
            """èŽ·å–æ–‡ä»¶çš„æœ€æ–°æäº¤ä¿¡æ¯"""
            try:
                # æŸ¥æ‰¾æ–‡ä»¶çš„æœ€æ–°æäº¤
                walker = repo.walk(repo.head.target, pygit2.GIT_SORT_TIME)
                for commit in walker:
                    try:
                        if file_path in commit.tree:
                            return commit
                    except KeyError:
                        continue
                return None
            except Exception as e:
                print(f"Error getting commit for {file_path}: {str(e)}")
                return None
        
        def extract_version_from_commit(commit):
            """ä»Žæäº¤æ¶ˆæ¯ä¸­æå–ç‰ˆæœ¬å·"""
            if not commit:
                return "unknown"
            
            # å°è¯•ä»Žæäº¤æ¶ˆæ¯ä¸­æå–ç‰ˆæœ¬å·
            version_match = re.search(r'v?(\d+\.\d+\.\d+)', commit.message)
            if version_match:
                return version_match.group(1)
            
            version_match = re.search(r'v?(\d+\.\d+)', commit.message)
            if version_match:
                return version_match.group(1)
            
            # ä½¿ç”¨çŸ­æäº¤IDä½œä¸ºç‰ˆæœ¬æ ‡è¯†
            return str(commit.id)[:7]
        
        def main():
            # åˆå§‹åŒ–Gitä»“åº“
            repo_path = pygit2.discover_repository(os.getcwd())
            if not repo_path:
                print("Not a git repository!")
                return
            repo = pygit2.Repository(repo_path)
            current_commit = repo[repo.head.target]
            
            # èŽ·å–ä¸Šä¸€ä¸ªæäº¤
            try:
                last_commit = current_commit.parents[0]
            except IndexError:
                last_commit = None
            
            # æ£€æµ‹å˜æ›´çš„APKæ–‡ä»¶
            changed_apks = []
            apk_dir = "apk"
            
            # æ¯”è¾ƒå·®å¼‚
            if last_commit:
                diff = repo.diff(last_commit, current_commit)
            else:
                # åˆå§‹æäº¤çš„æƒ…å†µ
                empty_tree = repo.TreeBuilder().write()
                diff = repo.diff(empty_tree, current_commit.tree)
            
            # åˆ†æžå·®å¼‚
            for delta in diff.deltas:
                file_path = delta.new_file.path if delta.new_file.path else delta.old_file.path
                
                # åªå¤„ç†apkç›®å½•ä¸‹çš„æ–‡ä»¶
                if not file_path.startswith(apk_dir):
                    continue
                    
                # æ³¨æ„ï¼šä½¿ç”¨pygit2çš„å¸¸é‡
                if delta.status not in (pygit2.GIT_DELTA_ADDED, pygit2.GIT_DELTA_MODIFIED):
                    continue
                
                # èŽ·å–æ–‡ä»¶æœ€æ–°æäº¤ä¿¡æ¯
                file_commit = get_file_latest_commit(repo, file_path)
                
                # æå–ç‰ˆæœ¬ä¿¡æ¯
                version = extract_version_from_commit(file_commit)
                
                # èŽ·å–æ›´æ–°æ—¥æœŸ
                update_date = datetime.fromtimestamp(file_commit.commit_time).strftime('%Y-%m-%d') if file_commit else "unknown"
                
                # æž„å»ºä¸‹è½½URL
                raw_url = f"https://raw.githubusercontent.com/{os.getenv('GITHUB_REPOSITORY')}/{current_commit.id}/{file_path}"
                
                changed_apks.append({
                    "name": os.path.basename(file_path),
                    "version": version,
                    "date": update_date,
                    "url": raw_url
                })
            
            if not changed_apks:
                print("No APK changes detected.")
                return
            
            # å‡†å¤‡Telegramæ¶ˆæ¯ - ç®€æ´æ ¼å¼
            message = "ðŸ“± *APK æ›´æ–°é€šçŸ¥*\n\n"
            for apk in changed_apks:
                # å°†æ–‡ä»¶åä½œä¸ºä¸‹è½½é“¾æŽ¥
                message += f"ðŸ”¹ [{apk['name']}]({apk['url']})\n"
                message += f"   ç‰ˆæœ¬: `{apk['version']}` | æ—¥æœŸ: `{apk['date']}`\n\n"
            
            # å‘é€åˆ°Telegram
            client = TelegramClient(
                StringSession(os.getenv("TELEGRAM_SESSION")),
                int(os.getenv("TELEGRAM_API_ID")),
                os.getenv("TELEGRAM_API_HASH")
            )
            
            async def send_message():
                await client.send_message(
                    entity=os.getenv("TELEGRAM_CHANNEL"),
                    message=message,
                    parse_mode='markdown',
                    link_preview=False
                )
            
            with client:
                client.loop.run_until_complete(send_message())
            print("Update notification sent to Telegram.")
        
        if __name__ == "__main__":
            main()
        EOF
        python .github/scripts/detect_apk_changes.py