name: APK Update Monitor

on:
  push:
    paths:
      - 'apk/**'

jobs:
  detect-and-notify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´æäº¤åŽ†å²

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install telethon python-dotenv pygit2

    - name: Run detection script
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        mkdir -p .github/scripts
        cat > .github/scripts/detect_apk_changes.py << 'EOF'
        # ä¸‹é¢æ˜¯å®Œæ•´çš„Pythonè„šæœ¬
        import os
        import re
        import pygit2
        from datetime import datetime
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        from dotenv import load_dotenv
        
        load_dotenv()
        
        def get_file_history_info(repo, file_path):
            """èŽ·å–æ–‡ä»¶çš„æäº¤åŽ†å²å’Œç‰ˆæœ¬ä¿¡æ¯"""
            try:
                # èŽ·å–æ–‡ä»¶çš„æ‰€æœ‰æäº¤åŽ†å²
                walker = repo.walk(repo.head.target)
                walker.set_sorting(pygit2.GIT_SORT_TIME)
                
                commits = []
                for commit in walker:
                    try:
                        # æ£€æŸ¥æ–‡ä»¶åœ¨è¯¥æäº¤ä¸­æ˜¯å¦å­˜åœ¨
                        if file_path in commit.tree:
                            commits.append({
                                "id": str(commit.id),
                                "short_id": str(commit.id)[:7],
                                "message": commit.message.strip(),
                                "date": datetime.fromtimestamp(commit.commit_time).strftime('%Y-%m-%d'),
                                "author": commit.author.name
                            })
                    except KeyError:
                        continue
                
                # æå–ç‰ˆæœ¬å·ï¼ˆä»Žæœ€æ–°æäº¤æ¶ˆæ¯ä¸­æŸ¥æ‰¾ï¼‰
                latest_commit = commits[0] if commits else None
                version = "unknown"
                if latest_commit:
                    # å°è¯•ä»Žæäº¤æ¶ˆæ¯ä¸­æå–ç‰ˆæœ¬å·
                    version_match = re.search(r'v?(\d+\.\d+\.\d+)', latest_commit["message"])
                    if version_match:
                        version = version_match.group(1)
                    else:
                        # ä½¿ç”¨çŸ­æäº¤IDä½œä¸ºç‰ˆæœ¬æ ‡è¯†
                        version = latest_commit["short_id"]
                
                return {
                    "version": version,
                    "update_date": latest_commit["date"] if latest_commit else "",
                    "commit_history": commits
                }
            except Exception as e:
                print(f"Error getting history for {file_path}: {str(e)}")
                return {
                    "version": "unknown",
                    "update_date": "",
                    "commit_history": []
                }
        
        def main():
            repo_path = pygit2.discover_repository(os.getcwd())
            repo = pygit2.Repository(repo_path)
            
            # èŽ·å–å½“å‰æäº¤
            current_commit = repo[repo.head.target]
            
            # èŽ·å–å‰ä¸€ä¸ªæäº¤
            try:
                last_commit = current_commit.parents[0]
            except IndexError:
                # åˆå§‹æäº¤æ²¡æœ‰çˆ¶æäº¤
                last_commit = None
            
            # æ£€æµ‹å˜æ›´çš„APKæ–‡ä»¶
            changed_apks = []
            apk_dir = "apk"
            
            if last_commit:
                # æ¯”è¾ƒå·®å¼‚
                diff = repo.diff(last_commit, current_commit)
            else:
                # åˆå§‹æäº¤ï¼Œä¸Žç©ºæ ‘æ¯”è¾ƒ
                diff = current_commit.tree.diff_to_tree()
            
            for delta in diff.deltas:
                file_path = delta.new_file.path if delta.new_file.path else delta.old_file.path
                
                # åªå¤„ç†apkç›®å½•ä¸‹çš„æ–‡ä»¶
                if file_path.startswith(apk_dir) and delta.status in ('added', 'modified'):
                    # èŽ·å–æ–‡ä»¶åŽ†å²ä¿¡æ¯
                    history_info = get_file_history_info(repo, file_path)
                    
                    # æž„å»ºä¸‹è½½URL
                    raw_url = f"https://raw.githubusercontent.com/{os.getenv('GITHUB_REPOSITORY')}/{current_commit.id}/{file_path}"
                    
                    changed_apks.append({
                        "name": os.path.basename(file_path),
                        "version": history_info["version"],
                        "update_date": history_info["update_date"],
                        "url": raw_url,
                        "commit_count": len(history_info["commit_history"])
                    })
            
            if not changed_apks:
                print("No APK changes detected.")
                return
            
            # å‡†å¤‡Telegramæ¶ˆæ¯
            message = "ðŸ“± APK æ›´æ–°é€šçŸ¥\n\n"
            for apk in changed_apks:
                message += (
                    f"ðŸ”¹ æ–‡ä»¶: {apk['name']}\n"
                    f"âžœ ç‰ˆæœ¬: {apk['version']} (åŸºäºŽ{apk['commit_count']}æ¬¡æäº¤)\n"
                    f"ðŸ“… æ›´æ–°æ—¥æœŸ: {apk['update_date']}\n"
                    f"â¬‡ï¸ ä¸‹è½½: [ç‚¹å‡»è¿™é‡Œ]({apk['url']})\n\n"
                )
            
            # å‘é€åˆ°Telegram
            client = TelegramClient(
                StringSession(os.getenv("TELEGRAM_SESSION")),
                int(os.getenv("TELEGRAM_API_ID")),
                os.getenv("TELEGRAM_API_HASH")
            )
            
            async def send_message():
                await client.send_message(
                    entity=os.getenv("TELEGRAM_CHANNEL"),
                    message=message,
                    link_preview=False
                )
            
            with client:
                client.loop.run_until_complete(send_message())
            print("Update notification sent to Telegram.")
        
        if __name__ == "__main__":
            main()
        EOF
        python .github/scripts/detect_apk_changes.py