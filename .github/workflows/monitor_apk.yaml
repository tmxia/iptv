name: Real-time APK Directory Monitor

on:
  push:
    paths:
      - 'apk/**'  # ç›‘æ§apkç›®å½•åŠå…¶å­ç›®å½•çš„æ‰€æœ‰å˜åŒ–
    branches: [ main ]  # æŒ‡å®šç›‘æ§çš„åˆ†æ”¯

jobs:
  detect-and-notify:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
        ref: ${{ github.ref }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libgit2-dev
        pip install pygit2 httpx python-dotenv

    - name: Run detection script
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        cat << 'EOF' > apk_monitor.py
        import os
        import re
        import pygit2
        import json
        import httpx
        from datetime import datetime
        from dotenv import load_dotenv
        
        # åŠ è½½ç¯å¢ƒå˜é‡
        load_dotenv()
        
        def extract_version(filename):
            """æ”¹è¿›ç‰ˆç‰ˆæœ¬å·æå–ï¼Œæ”¯æŒæ›´å¤šæ ¼å¼"""
            patterns = [
                r'[vV]?(\d+\.\d+\.\d+)(?:[-_](beta|alpha|rc)\d*)?',  # v1.2.3_beta
                r'[vV]?(\d+\.\d+)(?:[-_](beta|alpha|rc)\d*)?',      # v1.2_beta
                r'[vV]?(\d+)(?:[-_](beta|alpha|rc)\d*)?',           # v123_beta
                r'(?<![a-zA-Z0-9])(\d+\.\d+\.\d+)(?![a-zA-Z0-9])',  # 1.2.3
                r'(?<![a-zA-Z0-9])(\d+\.\d+)(?![a-zA-Z0-9])',       # 1.2
                r'(?<![a-zA-Z0-9])(\d+)(?![a-zA-Z0-9])'             # 123
            ]
            
            for pattern in patterns:
                match = re.search(pattern, filename)
                if match:
                    version = match.group(1)
                    suffix = f"-{match.group(2)}" if match.groups() > 1 else ""
                    return version + suffix
            return "unknown"
        
        def get_file_metadata(repo, file_path, commit_id):
            """è·å–æ–‡ä»¶å…ƒæ•°æ®ï¼ˆå¤§å°ã€æäº¤æ—¶é—´ï¼‰"""
            try:
                commit = repo.revparse_single(commit_id)
                entry = commit.tree[file_path]
                blob = repo[entry.id]
                size = len(blob.data)
                
                # è½¬æ¢ä¸ºMB/KB
                if size > 1024 * 1024:
                    size_str = f"{size/(1024*1024):.2f} MB"
                elif size > 1024:
                    size_str = f"{size/1024:.2f} KB"
                else:
                    size_str = f"{size} bytes"
                
                commit_time = datetime.utcfromtimestamp(commit.commit_time).strftime('%Y-%m-%d %H:%M UTC')
                return size_str, commit_time
            except:
                return "N/A", "N/A"
        
        def send_telegram_message(files):
            """é€šè¿‡Telegram Bot APIå‘é€æ¶ˆæ¯"""
            bot_token = os.getenv("TELEGRAM_BOT_TOKEN")
            channel_id = os.getenv("TELEGRAM_CHANNEL_ID")
            
            if not bot_token or not channel_id:
                print("Telegramå‡­æ®æœªé…ç½®!")
                return False
            
            message = "ğŸ“± *APKç›®å½•æ›´æ–°é€šçŸ¥*\n\n"
            message += f"ä»“åº“: `{os.getenv('GITHUB_REPOSITORY')}`\n"
            message += f"æäº¤: [{os.getenv('GITHUB_SHA')[:7]}](https://github.com/{os.getenv('GITHUB_REPOSITORY')}/commit/{os.getenv('GITHUB_SHA')})\n\n"
            message += f"æ£€æµ‹åˆ° {len(files)} ä¸ªæ–‡ä»¶æ›´æ–°:\n\n"
            
            for file in files:
                message += f"ğŸ“¦ *{file['name']}*\n"
                message += f"  - ç±»å‹: `{file['type']}`\n"
                message += f"  - ç‰ˆæœ¬: `{file['version']}`\n"
                message += f"  - å¤§å°: `{file['size']}`\n"
                message += f"  - æ›´æ–°æ—¶é—´: `{file['date']}`\n"
                message += f"  - [ä¸‹è½½æ–‡ä»¶]({file['url']})\n\n"
            
            message += f"ğŸ”” [æŸ¥çœ‹ä»“åº“](https://github.com/{os.getenv('GITHUB_REPOSITORY')}/tree/main/apk)"
            
            api_url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
            payload = {
                "chat_id": channel_id,
                "text": message,
                "parse_mode": "Markdown",
                "disable_web_page_preview": True
            }
            
            try:
                with httpx.Client(timeout=10.0) as client:
                    response = client.post(api_url, json=payload)
                    if response.status_code == 200:
                        print("Telegramé€šçŸ¥å‘é€æˆåŠŸ!")
                        return True
                    else:
                        print(f"Telegramå‘é€å¤±è´¥: {response.status_code} - {response.text}")
            except Exception as e:
                print(f"è¯·æ±‚å¼‚å¸¸: {str(e)}")
            
            return False
        
        def main():
            print("Starting APK directory monitoring...")
            repo_path = os.getcwd()
            repo = pygit2.Repository(repo_path)
            
            # è·å–å½“å‰æäº¤
            try:
                new_commit = repo.revparse_single('HEAD')
                print(f"Current commit: {new_commit.id}")
            except KeyError:
                print("é”™è¯¯: æ— æ³•æ‰¾åˆ°HEADæäº¤")
                return
            
            # è·å–ä¸Šä¸€ä¸ªæäº¤ (ä½¿ç”¨åˆ†æ”¯å¼•ç”¨è€Œä¸æ˜¯HEAD~1)
            try:
                old_commit = repo.revparse_single('HEAD~1')
                print(f"Previous commit: {old_commit.id}")
            except (KeyError, TypeError):
                print("åˆå§‹æäº¤ - æ— å‰ä¸€ç‰ˆæœ¬")
                return
            
            # è®¡ç®—å·®å¼‚
            diff = repo.diff(old_commit, new_commit)
            changed_files = []
            
            for delta in diff.deltas:
                file_path = delta.new_file.path if delta.new_file.path else delta.old_file.path
                
                # åªå¤„ç†apk/ç›®å½•ä¸‹çš„æ–‡ä»¶
                if not file_path.startswith('apk/'):
                    continue
                
                # æ£€æŸ¥æ–‡ä»¶çŠ¶æ€
                if delta.status in (pygit2.GIT_DELTA_ADDED, pygit2.GIT_DELTA_MODIFIED):
                    filename = os.path.basename(file_path)
                    version = extract_version(filename)
                    
                    # è·å–æ–‡ä»¶å…ƒæ•°æ®
                    size, commit_time = get_file_metadata(repo, file_path, new_commit.id)
                    
                    # æ„å»ºä¸‹è½½URL
                    raw_url = f"https://raw.githubusercontent.com/{os.getenv('GITHUB_REPOSITORY')}/main/{file_path}"
                    
                    # è·å–æ–‡ä»¶æ‰©å±•å
                    file_ext = os.path.splitext(filename)[1][1:].upper() if '.' in filename else "æ–‡ä»¶"
                    
                    changed_files.append({
                        "name": filename,
                        "path": file_path,
                        "type": file_ext,
                        "version": version,
                        "size": size,
                        "date": commit_time,
                        "url": raw_url
                    })
            
            if not changed_files:
                print("æœªæ£€æµ‹åˆ°APKæ–‡ä»¶å˜åŒ–ã€‚")
                return
            
            print(f"æ£€æµ‹åˆ° {len(changed_files)} ä¸ªæ–‡ä»¶å˜åŒ–:")
            for file in changed_files:
                print(f"- {file['name']} (v{file['version']})")
            
            # å‘é€åˆ°Telegram
            if send_telegram_message(changed_files):
                print("é€šçŸ¥æµç¨‹å®Œæˆ!")
            else:
                print("é€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®")
        
        if __name__ == "__main__":
            main()
        EOF
        
        python apk_monitor.py