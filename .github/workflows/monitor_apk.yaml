name: Real-time APK Directory Monitor

on:
  push:
    paths:
      - 'apk/**'
    branches: [ main ]

jobs:
  detect-and-notify:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.ref }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libgit2-dev
        pip install telethon pygit2

    - name: Run Telethon detection script
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        cat << 'EOF' > apk_monitor.py
        import os
        import re
        import pygit2
        import asyncio
        from datetime import datetime
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        from urllib.parse import quote
        
        # å¢å¼ºç‰ˆç‰ˆæœ¬å·æå–
        def extract_version(filename):
            patterns = [
                r'[vV]?(\d+\.\d+(?:\.\d+)?)(?:[-_](beta|alpha|rc|preview)\d*)?',  # v1.2.3
                r'_v?(\d+\.\d+(?:\.\d+)?)',  # _1.2.3
                r'[vV](\d+)',                 # v123
                r'_(\d+)',                    # _123
                r'(\d+\.\d+)',                # 1.2
                r'(\d+)'                      # 123
            ]
            
            for pattern in patterns:
                match = re.search(pattern, filename)
                if match:
                    return match.group(1)
            return "unknown"
        
        async def send_telegram_message(files):
            """ä½¿ç”¨Telethonå‘é€æ¶ˆæ¯"""
            try:
                api_id = int(os.getenv("TELEGRAM_API_ID"))
                api_hash = os.getenv("TELEGRAM_API_HASH")
                session_str = os.getenv("TELEGRAM_SESSION")
                channel = os.getenv("TELEGRAM_CHANNEL")
                
                if not all([api_id, api_hash, session_str, channel]):
                    print("âŒ Telegramé…ç½®ä¸å®Œæ•´")
                    return False
                
                async with TelegramClient(
                    StringSession(session_str), 
                    api_id, 
                    api_hash
                ) as client:
                    # æ„å»ºæ¶ˆæ¯ - åŒ…å«ç‰ˆæœ¬å’Œæ—¥æœŸ
                    message = "ğŸ“± **APKç›®å½•æ›´æ–°é€šçŸ¥**\n\n"
                    
                    # æ·»åŠ æ–‡ä»¶åˆ—è¡¨
                    for file in files:
                        message += f"ğŸ“„ **{file['name']}**\n"
                        message += f"  - ç‰ˆæœ¬: `{file['version']}`\n"
                        message += f"  - æ›´æ–°: `{file['date']}`\n"
                        message += f"  - [ä¸‹è½½æ–‡ä»¶]({file['url']})\n\n"
                    
                    # æ·»åŠ ä»“åº“å’Œæäº¤ä¿¡æ¯
                    message += f"ğŸ”– ä»“åº“: `{os.getenv('GITHUB_REPOSITORY')}`\n"
                    message += f"ğŸ†” [æŸ¥çœ‹æäº¤è¯¦æƒ…](https://github.com/{os.getenv('GITHUB_REPOSITORY')}/commit/{os.getenv('GITHUB_SHA')})"
                    
                    await client.send_message(
                        entity=channel,
                        message=message,
                        parse_mode='md',
                        link_preview=False
                    )
                    return True
            except Exception as e:
                print(f"âŒ Telethoné”™è¯¯: {str(e)}")
                return False
        
        def main():
            print("ğŸš€ å¼€å§‹ç›‘æ§APKç›®å½•å˜æ›´...")
            repo = pygit2.Repository('.')
            
            # è·å–å½“å‰æäº¤
            head_commit = repo.head.peel()
            print(f"å½“å‰æäº¤: {head_commit.id}")
            
            # è·å–çˆ¶æäº¤
            parent_commit = head_commit.parents[0] if head_commit.parents else None
            
            if not parent_commit:
                print("âš ï¸ åˆå§‹æäº¤ - æ— å‰ä¸€ç‰ˆæœ¬")
                return
            
            print(f"çˆ¶æäº¤: {parent_commit.id}")
            
            # è®¡ç®—å·®å¼‚
            diff = repo.diff(parent_commit, head_commit)
            changed_files = []
            
            # è§£æå·®å¼‚
            for delta in diff.deltas:
                # åªå¤„ç†æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶ï¼Œå¿½ç•¥åˆ é™¤çš„æ–‡ä»¶
                if delta.status not in (pygit2.GIT_DELTA_ADDED, pygit2.GIT_DELTA_MODIFIED):
                    continue
                
                file_path = delta.new_file.path or delta.old_file.path
                print(f"æ£€æµ‹åˆ°å˜æ›´: {file_path} [çŠ¶æ€: {delta.status}]")
                
                # åªå¤„ç†apkç›®å½•ä¸‹çš„æ–‡ä»¶
                if not file_path.startswith('apk/'):
                    continue
                
                # è·å–æ–‡ä»¶å
                filename = os.path.basename(file_path)
                
                # è·å–æ›´æ–°æ—¶é—´ (è½¬æ¢ä¸ºUTCæ—¶é—´)
                commit_time = datetime.utcfromtimestamp(head_commit.commit_time).strftime('%Y-%m-%d %H:%M UTC')
                
                # æ„å»ºä¸‹è½½URL
                encoded_path = quote(file_path)
                raw_url = f"https://raw.githubusercontent.com/{os.getenv('GITHUB_REPOSITORY')}/main/{encoded_path}"
                
                changed_files.append({
                    "name": filename,
                    "version": extract_version(filename),
                    "date": commit_time,
                    "url": raw_url
                })
            
            if not changed_files:
                print("âœ… æœªæ£€æµ‹åˆ°APKæ–‡ä»¶å˜æ›´")
                return
            
            print(f"ğŸ“¦ æ£€æµ‹åˆ° {len(changed_files)} ä¸ªæ–‡ä»¶å˜æ›´:")
            for file in changed_files:
                print(f"  - {file['name']} (v{file['version']}, {file['date']})")
            
            # å‘é€åˆ°Telegram
            loop = asyncio.get_event_loop()
            success = loop.run_until_complete(send_telegram_message(changed_files))
            
            if success:
                print("âœ… Telegramé€šçŸ¥å‘é€æˆåŠŸ!")
            else:
                print("âŒ Telegramé€šçŸ¥å‘é€å¤±è´¥")
        
        if __name__ == "__main__":
            main()
        EOF
        
        python apk_monitor.py