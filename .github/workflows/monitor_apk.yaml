name: Real-time APK Directory Monitor

on:
  push:
    paths:
      - 'apk/**'  # ç›‘æ§ apk ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å˜åŒ–

jobs:
  detect-and-notify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libgit2-dev
        pip install telethon pygit2

    - name: Run detection script
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        cat << 'EOF' > detect_file_changes.py
        import os
        import re
        import pygit2
        import asyncio
        from datetime import datetime
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        
        def extract_version(filename):
            """ä»æ–‡ä»¶åä¸­æå–ç‰ˆæœ¬å·ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰"""
            patterns = [
                r'_v?(\d+\.\d+\.\d+)',  # åŒ¹é… v1.2.3 æˆ– _1.2.3
                r'_v?(\d+\.\d+)',        # åŒ¹é… v1.2 æˆ– _1.2
                r'_v?(\d+)',             # åŒ¹é… v123 æˆ– _123
                r'[^\d]*(\d+\.\d+\.\d+)' # åŒ¹é…ä»»æ„ä½ç½®çš„ 1.2.3
            ]
            for pattern in patterns:
                match = re.search(pattern, filename)
                if match:
                    return match.group(1)
            return "unknown"
        
        def main():
            repo = pygit2.Repository('.')
            
            # è·å–å½“å‰æäº¤
            try:
                new_commit = repo.revparse_single('HEAD')
            except KeyError:
                print("é”™è¯¯: æ— æ³•æ‰¾åˆ° HEAD æäº¤")
                return
            
            # è·å–ä¸Šä¸€ä¸ªæäº¤
            try:
                old_commit = repo.revparse_single('HEAD~1')
            except KeyError:
                print("åˆå§‹æäº¤ - æ— å‰ä¸€ç‰ˆæœ¬")
                return
            
            # è®¡ç®—å·®å¼‚
            diff = repo.diff(old_commit, new_commit)
            changed_files = []
            
            for delta in diff.deltas:
                file_path = delta.new_file.path if delta.new_file.path else delta.old_file.path
                
                # åªå¤„ç† apk/ ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ˆä»»ä½•ç±»å‹ï¼‰
                if not file_path.startswith('apk/'):
                    continue
                
                # æ£€æŸ¥æ–‡ä»¶çŠ¶æ€
                if delta.status in (pygit2.GIT_DELTA_ADDED, pygit2.GIT_DELTA_MODIFIED):
                    # ä»æ–‡ä»¶åæå–ç‰ˆæœ¬
                    filename = os.path.basename(file_path)
                    version = extract_version(filename)
                    
                    # è·å–æ–‡ä»¶æäº¤æ—¶é—´
                    commit_time = datetime.utcfromtimestamp(new_commit.commit_time).strftime('%Y-%m-%d %H:%M UTC')
                    
                    # æ„å»ºä¸‹è½½URL
                    raw_url = f"https://raw.githubusercontent.com/{os.getenv('GITHUB_REPOSITORY')}/main/{file_path}"
                    
                    # è·å–æ–‡ä»¶æ‰©å±•å
                    file_ext = os.path.splitext(filename)[1][1:].upper() if '.' in filename else "æ–‡ä»¶"
                    
                    changed_files.append({
                        "name": filename,
                        "path": file_path,
                        "type": file_ext,
                        "version": version,
                        "date": commit_time,
                        "url": raw_url
                    })
            
            if not changed_files:
                print("æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ã€‚")
                return
            
            # æ„å»ºTelegramæ¶ˆæ¯
            message = "ğŸ“ *ç›®å½•æ›´æ–°é€šçŸ¥*\n\n"
            message += f"æ£€æµ‹åˆ° {len(changed_files)} ä¸ªæ–‡ä»¶æ›´æ–°ï¼š\n\n"
            
            for file in changed_files:
                message += f"ğŸ“„ [{file['name']}]({file['url']})\n"
                message += f"   â€¢ ç±»å‹: `{file['type']}`\n"
                message += f"   â€¢ ç‰ˆæœ¬: `{file['version']}`\n"
                message += f"   â€¢ æ›´æ–°æ—¶é—´: `{file['date']}`\n\n"
            
            # æ·»åŠ ä»“åº“é“¾æ¥
            message += f"[æŸ¥çœ‹ä»“åº“](https://github.com/{os.getenv('GITHUB_REPOSITORY')})"
            
            # å‘é€åˆ°Telegram
            async def send_to_telegram():
                try:
                    async with TelegramClient(
                        StringSession(os.getenv("TELEGRAM_SESSION")),
                        int(os.getenv("TELEGRAM_API_ID")),
                        os.getenv("TELEGRAM_API_HASH")
                    ) as client:
                        await client.send_message(
                            entity=os.getenv("TELEGRAM_CHANNEL"),
                            message=message,
                            parse_mode='markdown',
                            link_preview=False
                        )
                    print("Telegramé€šçŸ¥å‘é€æˆåŠŸï¼")
                except Exception as e:
                    print(f"å‘é€Telegramé€šçŸ¥å¤±è´¥: {str(e)}")
            
            asyncio.run(send_to_telegram())
        
        if __name__ == "__main__":
            main()
        EOF
        
        python detect_file_changes.py