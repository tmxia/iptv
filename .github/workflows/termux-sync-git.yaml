name: Termux APK Sync from Source Repository

# ä½¿ç”¨åŸç”Ÿå¹¶å‘æ§åˆ¶
concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */24 * * *'  # æ¯24å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # åŸºäºç¼“å­˜çš„é”æœºåˆ¶
    - name: Acquire Repository Lock ğŸ”’
      uses: softprops/turnstyle@v1
      with:
        same-branch-only: true
        poll-interval-seconds: 30
        abort-after-seconds: 1200  # 20åˆ†é’Ÿè¶…æ—¶
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        
    - name: Run Git-based APK sync
      env:
        SOURCE_REPO: "termux/termux-app"
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
        STABLE_KEY_NAME: "termux.apk"
        PRE_RELEASE_KEY_NAME: "termux-beta.apk"
        STABLE_APK_PATTERN: "github-debug_arm64-v8a.apk"
        PRE_RELEASE_APK_PATTERN: "android-7-github-debug_arm64-v8a.apk"
      run: |
        #!/bin/bash
        set -euo pipefail
        
        # é…ç½®Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@users.noreply.github.com"
        git pull origin main --rebase
        
        # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
        WORK_DIR=$(mktemp -d)
        trap 'rm -rf "$WORK_DIR"; echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."' EXIT
        
        # 1. è·å–æºä»“åº“å‘å¸ƒä¿¡æ¯
        echo "è·å–æºä»“åº“å‘å¸ƒä¿¡æ¯..."
        releases=$(curl -sL "https://api.github.com/repos/$SOURCE_REPO/releases")
        
        # æå–ç¨³å®šç‰ˆä¿¡æ¯
        stable_release=$(echo "$releases" | jq -r '[.[] | select(.prerelease == false)] | sort_by(.published_at) | reverse | .[0]')
        stable_version=$(echo "$stable_release" | jq -r '.tag_name')
        stable_main_version=$(echo "$stable_version" | sed 's/-.*//')
        stable_date=$(echo "$stable_release" | jq -r '.published_at' | TZ=UTC date -f - +'%Y-%m-%d')
        echo "ç¨³å®šç‰ˆ: $stable_main_version ($stable_date)"
        
        # æå–é¢„å‘è¡Œç‰ˆä¿¡æ¯
        pre_release=$(echo "$releases" | jq -r '[.[] | select(.prerelease == true)] | sort_by(.published_at) | reverse | .[0]')
        if [ "$pre_release" = "null" ]; then
          echo "æ— é¢„å‘è¡Œç‰ˆå¯ç”¨"
          sync_pre_release=false
        else
          pre_version=$(echo "$pre_release" | jq -r '.tag_name')
          pre_main_version=$(echo "$pre_version" | sed 's/-.*//')
          pre_date=$(echo "$pre_release" | jq -r '.published_at' | TZ=UTC date -f - +'%Y-%m-%d')
          echo "é¢„å‘è¡Œç‰ˆ: $pre_main_version ($pre_date)"
          sync_pre_release=true
        fi
        
        # 2. è¯»å–æœ¬åœ°ç‰ˆæœ¬æ–‡ä»¶
        echo "è¯»å–æœ¬åœ°ç‰ˆæœ¬æ–‡ä»¶..."
        VERSION_FILE="version.txt"
        if [ -f "$VERSION_FILE" ]; then
          current_versions=$(jq -c . "$VERSION_FILE")
          echo "å½“å‰ç‰ˆæœ¬ä¿¡æ¯:"
          # åªæ˜¾ç¤ºç›¸å…³çš„é”®å€¼
          echo "$current_versions" | jq -r ".\"$STABLE_KEY_NAME\" // \"(æœªè®¾ç½®)\"" | awk -v key="$STABLE_KEY_NAME" '{print key ": " $0}'
          if [ "$sync_pre_release" = true ]; then
            echo "$current_versions" | jq -r ".\"$PRE_RELEASE_KEY_NAME\" // \"(æœªè®¾ç½®)\"" | awk -v key="$PRE_RELEASE_KEY_NAME" '{print key ": " $0}'
          fi
        else
          current_versions="{}"
          echo "æ— ç‰ˆæœ¬æ–‡ä»¶"
          echo "$STABLE_KEY_NAME: (æœªè®¾ç½®)"
          if [ "$sync_pre_release" = true ]; then
            echo "$PRE_RELEASE_KEY_NAME: (æœªè®¾ç½®)"
          fi
        fi
        
        # 3. æ›´æ–°ç‰ˆæœ¬æ•°æ®å‡½æ•°
        update_version_data() {
          local key=$1
          local version=$2
          local date=$3
          
          # ä»…æ›´æ–°æŒ‡å®šé”®å€¼
          current_versions=$(echo "$current_versions" | jq \
            --arg key "$key" \
            --arg value "$version,$date" \
            '.[$key] = $value')
        }
        
        # 4. å¢å¼ºæ–‡ä»¶å­˜åœ¨æ€§æ£€æµ‹
        check_file_exists() {
          local key_name=$1
          local target_path="apk/$key_name"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "$target_path" ]; then
            echo "æ–‡ä»¶å­˜åœ¨: $target_path"
            return 0
          else
            echo "æ–‡ä»¶ç¼ºå¤±: $target_path"
            return 1
          fi
        }
        
        # 5. å¢å¼ºç‰ˆæœ¬é”®å€¼å­˜åœ¨æ€§æ£€æµ‹
        check_key_exists() {
          local key_name=$1
          
          # æ£€æŸ¥é”®å€¼æ˜¯å¦å­˜åœ¨
          if echo "$current_versions" | jq -e "has(\"$key_name\")" >/dev/null; then
            echo "ç‰ˆæœ¬é”®å€¼å­˜åœ¨: $key_name"
            return 0
          else
            echo "ç‰ˆæœ¬é”®å€¼ç¼ºå¤±: $key_name"
            return 1
          fi
        }
        
        # 6. æ£€æŸ¥å¹¶ä¸‹è½½APK
        check_and_download() {
          local release_json=$1
          local key_name=$2
          local apk_pattern=$3
          local main_version=$4
          local date=$5
          
          # è·å–ç›®æ ‡æ–‡ä»¶å
          local target_filename="apk/$key_name"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if ! check_file_exists "$key_name"; then
            echo "æ–‡ä»¶ç¼ºå¤±ï¼Œå¿…é¡»æ›´æ–°: $key_name"
            file_missing=1
          else
            file_missing=0
          fi
          
          # æ£€æŸ¥é”®å€¼æ˜¯å¦å­˜åœ¨
          if ! check_key_exists "$key_name"; then
            echo "é”®å€¼ç¼ºå¤±ï¼Œå¿…é¡»æ›´æ–°: $key_name"
            key_missing=1
          else
            key_missing=0
          fi
          
          # è·å–å½“å‰ç‰ˆæœ¬å€¼
          local current_value=$(echo "$current_versions" | jq -r ".\"$key_name\" // \"\"")
          
          # ç¡®å®šæ˜¯å¦éœ€è¦æ›´æ–°
          if [[ $file_missing -eq 1 || $key_missing -eq 1 || "$current_value" != "$main_version,$date" ]]; then
            # ä¸‹è½½APK
            download_url=$(echo "$release_json" | jq -r \
              ".assets[] | select(.name | contains(\"$apk_pattern\")) | .browser_download_url" | head -1)
            
            if [ -z "$download_url" ]; then
              echo "é”™è¯¯: æœªæ‰¾åˆ°åŒ¹é…çš„APKæ–‡ä»¶: $apk_pattern"
              return 1
            fi
            
            echo "ä¸‹è½½: $download_url"
            curl -sL "$download_url" -o "$WORK_DIR/$key_name"
            
            # æ›´æ–°ç‰ˆæœ¬æ•°æ®
            update_version_data "$key_name" "$main_version" "$date"
            
            # ç§»åŠ¨æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•
            mkdir -p apk
            mv "$WORK_DIR/$key_name" "apk/$key_name"
            return 0
          else
            echo "æ— éœ€æ›´æ–°: $key_name ($current_value)"
            return 1
          fi
        }
        
        # 7. å¤„ç†ç¨³å®šç‰ˆ
        echo "å¤„ç†ç¨³å®šç‰ˆ..."
        if check_and_download "$stable_release" "$STABLE_KEY_NAME" \
          "$STABLE_APK_PATTERN" "$stable_main_version" "$stable_date"; then
          stable_updated=true
        else
          stable_updated=false
        fi
        
        # 8. å¤„ç†é¢„å‘è¡Œç‰ˆ
        if [ "$sync_pre_release" = true ]; then
          echo "å¤„ç†é¢„å‘è¡Œç‰ˆ..."
          if check_and_download "$pre_release" "$PRE_RELEASE_KEY_NAME" \
            "$PRE_RELEASE_APK_PATTERN" "$pre_main_version" "$pre_date"; then
            beta_updated=true
          else
            beta_updated=false
          fi
        fi
        
        # 9. æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        if [ "$stable_updated" = true ] || [ "$beta_updated" = true ]; then
          echo "æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶..."
          echo "$current_versions" | jq . > "$VERSION_FILE"
          
          # æäº¤æ›´æ”¹
          git add apk/"$STABLE_KEY_NAME"
          if [ "$sync_pre_release" = true ]; then
            git add apk/"$PRE_RELEASE_KEY_NAME"
          fi
          git add "$VERSION_FILE"
          
          commit_msg="æ›´æ–°Termux APK"
          [ "$stable_updated" = true ] && commit_msg+=" ç¨³å®šç‰ˆ: $stable_main_version"
          [ "$beta_updated" = true ] && commit_msg+=" æµ‹è¯•ç‰ˆ: $pre_main_version"
          
          git commit -m "$commit_msg"
          
          # æ¨é€æ›´æ”¹
          git push origin main
        fi
        
        # 10. æ˜¾ç¤ºæœ€ç»ˆå½“å‰çš„ç‰ˆæœ¬ä¿¡æ¯
        echo "åŒæ­¥å®Œæˆ! å½“å‰ç‰ˆæœ¬ä¿¡æ¯:"
        # åªæ˜¾ç¤ºç›¸åº”çš„é”®å€¼
        echo "$current_versions" | jq -r ".\"$STABLE_KEY_NAME\" // \"(æœªè®¾ç½®)\"" | awk -v key="$STABLE_KEY_NAME" '{print key ": " $0}'
        if [ "$sync_pre_release" = true ]; then
          echo "$current_versions" | jq -r ".\"$PRE_RELEASE_KEY_NAME\" // \"(æœªè®¾ç½®)\"" | awk -v key="$PRE_RELEASE_KEY_NAME" '{print key ": " $0}'
        fi

    # é‡Šæ”¾ä»“åº“é”
    - name: Release Repository Lock ğŸ”“
      if: always()
      uses: softprops/turnstyle@v1
      with:
        continue-on-error: true
        action: unlock
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const message = `ğŸš¨ Termux APKåŒæ­¥å¤±è´¥ï¼å·¥ä½œæµè¿è¡Œ: [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          })

  cleanup_self:
    name: Cleanup Self Workflow History
    runs-on: ubuntu-latest
    needs: sync
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "Termux APK Sync from Source Repository"
          repository: ${{ github.repository }}
