name: YouTube APK Sync from Source Repository

# ä½¿ç”¨åŸç”Ÿå¹¶å‘æ§åˆ¶
concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # åŸºäºç¼“å­˜çš„é”æœºåˆ¶
    - name: Acquire Repository Lock ğŸ”’
      uses: softprops/turnstyle@v3
      with:
        same-branch-only: true
        poll-interval-seconds: 30
        abort-after-seconds: 600
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout target repository
      uses: actions/checkout@v5
      with:
        repository: ${{ github.repository }}
        token: ${{ secrets.GITHUB_TOKEN }}
        path: target-repo
        fetch-depth: 1

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: Run APK sync script
      env:
        SOURCE_REPO: "NoName-exe/revanced"
        TARGET_REPO: "${{ github.repository }}"
      run: |
        # å·¥ä½œç›®å½•
        WORK_DIR=$(mktemp -d)
        echo "åˆ›å»ºä¸´æ—¶ç›®å½•: $WORK_DIR"
        trap 'rm -rf "$WORK_DIR"; echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."' EXIT

        # ç›®æ ‡ä»“åº“ç›®å½•
        TARGET_DIR="$GITHUB_WORKSPACE/target-repo"
        VERSION_FILE="$TARGET_DIR/version.txt"
        DOWNLOAD_LINKS_FILE="$TARGET_DIR/download-links.json"
        
        # 1. ç‰ˆæœ¬æ–‡ä»¶é”®å€¼å­˜åœ¨æ€§æ£€æµ‹
        echo "æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨æ€§..."
        if [ -f "$VERSION_FILE" ]; then
          echo "ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨: $VERSION_FILE"
          CURRENT_VERSION_DATA=$(cat "$VERSION_FILE")
          # éªŒè¯JSONæ ¼å¼
          if ! echo "$CURRENT_VERSION_DATA" | jq -e . >/dev/null 2>&1; then
            echo "ç‰ˆæœ¬æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œé‡ç½®ä¸ºç©ºå¯¹è±¡"
            CURRENT_VERSION_DATA="{}"
            echo "{}" > "$VERSION_FILE"
          fi
        else
          echo "ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºç‰ˆæœ¬æ–‡ä»¶"
          echo "{}" > "$VERSION_FILE"
          CURRENT_VERSION_DATA="{}"
        fi
        
        # 2. è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬çš„èµ„æºæ–‡ä»¶
        echo "è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬..."
        RELEASE_JSON=$(curl -sL "https://api.github.com/repos/$SOURCE_REPO/releases/latest")
        if [ $? -ne 0 ] || [ -z "$RELEASE_JSON" ]; then
          echo "é”™è¯¯: æ— æ³•è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬"
          exit 1
        fi
        
        # æå–å‘å¸ƒä¿¡æ¯
        RELEASE_TAG=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
        RELEASE_DATE=$(echo "$RELEASE_JSON" | jq -r '.published_at')
        RELEASE_DATE_UTC8=$(TZ=Asia/Shanghai date -d "$RELEASE_DATE" +'%Y-%m-%d')
        echo "æœ€æ–°å‘å¸ƒç‰ˆæœ¬: $RELEASE_TAG, å‘å¸ƒæ—¥æœŸ: $RELEASE_DATE_UTC8"
        
        # 3. ç²¾å‡†åŒ¹é…APKæ–‡ä»¶
        echo "æœç´¢åŒ¹é…çš„APKæ–‡ä»¶..."
        
        # æŸ¥æ‰¾YouTube APKæ–‡ä»¶ - åªåŒ¹é…APKï¼Œæ’é™¤Magiskæ¨¡å—
        YOUTUBE_ASSET=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("^youtube-revanced.*\\.apk$")) | select(.name | test("magisk") | not) | {name: .name, url: .browser_download_url, size: .size}' | jq -s '.[0]')
        if [ "$YOUTUBE_ASSET" = "null" ] || [ -z "$YOUTUBE_ASSET" ]; then
          echo "é”™è¯¯: æœªæ‰¾åˆ°åŒ¹é…çš„YouTube APKæ–‡ä»¶"
          exit 1
        fi
        
        YOUTUBE_APK_NAME=$(echo "$YOUTUBE_ASSET" | jq -r '.name')
        YOUTUBE_DOWNLOAD_URL=$(echo "$YOUTUBE_ASSET" | jq -r '.url')
        YOUTUBE_FILE_SIZE=$(echo "$YOUTUBE_ASSET" | jq -r '.size')
        echo "æ‰¾åˆ°YouTube APK: $YOUTUBE_APK_NAME (å¤§å°: $((YOUTUBE_FILE_SIZE/1024/1024))MB)"
        
        # æŸ¥æ‰¾YouTube Music APKæ–‡ä»¶ - åªåŒ¹é…APKï¼Œæ’é™¤Magiskæ¨¡å—
        YOUTUBE_MUSIC_ASSET=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("^youtube-music-revanced.*\\.apk$")) | select(.name | test("magisk") | not) | {name: .name, url: .browser_download_url, size: .size}' | jq -s '.[0]')
        if [ "$YOUTUBE_MUSIC_ASSET" = "null" ] || [ -z "$YOUTUBE_MUSIC_ASSET" ]; then
          echo "é”™è¯¯: æœªæ‰¾åˆ°åŒ¹é…çš„YouTube Music APKæ–‡ä»¶"
          exit 1
        fi
        
        YOUTUBE_MUSIC_APK_NAME=$(echo "$YOUTUBE_MUSIC_ASSET" | jq -r '.name')
        YOUTUBE_MUSIC_DOWNLOAD_URL=$(echo "$YOUTUBE_MUSIC_ASSET" | jq -r '.url')
        YOUTUBE_MUSIC_FILE_SIZE=$(echo "$YOUTUBE_MUSIC_ASSET" | jq -r '.size')
        echo "æ‰¾åˆ°YouTube Music APK: $YOUTUBE_MUSIC_APK_NAME (å¤§å°: $((YOUTUBE_MUSIC_FILE_SIZE/1024/1024))MB)"
        
        # 4. è§¦å‘æ›´æ–°é€»è¾‘
        NEED_UPDATE=0
        
        # ä»æ–‡ä»¶åæå–ç‰ˆæœ¬å·å‡½æ•°
        extract_version_from_filename() {
          local filename="$1"
          echo "ä»æ–‡ä»¶åæå–ç‰ˆæœ¬å·: $filename" >&2
          
          # ä»æ–‡ä»¶åä¸­æå–ç‰ˆæœ¬å·æ¨¡å¼ vX.Y.Z
          VERSION=$(echo "$filename" | grep -oP 'v\d+\.\d+\.\d+' | head -1)
          
          if [ -z "$VERSION" ]; then
            echo "è­¦å‘Š: æ— æ³•ä»æ–‡ä»¶åæå–ç‰ˆæœ¬å·" >&2
            VERSION="$RELEASE_TAG"
          fi
          
          echo "æå–çš„ç‰ˆæœ¬å·: $VERSION" >&2
          echo "$VERSION"
        }
        
        # æå–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆä»æ–‡ä»¶åï¼‰
        YOUTUBE_VERSION=$(extract_version_from_filename "$YOUTUBE_APK_NAME")
        YOUTUBE_MUSIC_VERSION=$(extract_version_from_filename "$YOUTUBE_MUSIC_APK_NAME")
        
        echo "YouTubeç‰ˆæœ¬: $YOUTUBE_VERSION, å‘å¸ƒæ—¥æœŸ: $RELEASE_DATE_UTC8"
        echo "YouTube Musicç‰ˆæœ¬: $YOUTUBE_MUSIC_VERSION, å‘å¸ƒæ—¥æœŸ: $RELEASE_DATE_UTC8"
        
        # 5. å¯¹æ¯”æ›´æ–°é€»è¾‘ - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•æå–å½“å‰ç‰ˆæœ¬
        echo "æå–å½“å‰ç‰ˆæœ¬ä¿¡æ¯..."
        
        # ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•ä»JSONä¸­æå–å€¼
        if echo "$CURRENT_VERSION_DATA" | jq -e ".youtube" >/dev/null 2>&1; then
          CURRENT_YOUTUBE=$(echo "$CURRENT_VERSION_DATA" | jq -r ".youtube")
        else
          CURRENT_YOUTUBE=""
        fi
        
        if echo "$CURRENT_VERSION_DATA" | jq -e ".youtube_music" >/dev/null 2>&1; then
          CURRENT_YOUTUBE_MUSIC=$(echo "$CURRENT_VERSION_DATA" | jq -r ".youtube_music")
        else
          CURRENT_YOUTUBE_MUSIC=""
        fi
        
        NEW_YOUTUBE_VALUE="$YOUTUBE_VERSION,$RELEASE_DATE_UTC8"
        NEW_YOUTUBE_MUSIC_VALUE="$YOUTUBE_MUSIC_VERSION,$RELEASE_DATE_UTC8"
        
        echo "å½“å‰YouTubeç‰ˆæœ¬: $CURRENT_YOUTUBE"
        echo "å½“å‰YouTube Musicç‰ˆæœ¬: $CURRENT_YOUTUBE_MUSIC"
        echo "æ–°YouTubeç‰ˆæœ¬: $NEW_YOUTUBE_VALUE"
        echo "æ–°YouTube Musicç‰ˆæœ¬: $NEW_YOUTUBE_MUSIC_VALUE"
        
        # æ›´æ–°æ£€æµ‹
        if [ "$CURRENT_YOUTUBE" != "$NEW_YOUTUBE_VALUE" ]; then
          echo "YouTubeç‰ˆæœ¬å˜åŒ–ï¼š$CURRENT_YOUTUBE -> $NEW_YOUTUBE_VALUEï¼Œéœ€è¦æ›´æ–°"
          NEED_UPDATE=1
        else
          echo "YouTubeæ— å˜åŒ–"
        fi
        
        if [ "$CURRENT_YOUTUBE_MUSIC" != "$NEW_YOUTUBE_MUSIC_VALUE" ]; then
          echo "YouTube Musicç‰ˆæœ¬å˜åŒ–ï¼š$CURRENT_YOUTUBE_MUSIC -> $NEW_YOUTUBE_MUSIC_VALUEï¼Œéœ€è¦æ›´æ–°"
          NEED_UPDATE=1
        else
          echo "YouTube Musicæ— å˜åŒ–"
        fi
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        if [ "$NEED_UPDATE" -eq 0 ]; then
          echo "æ²¡æœ‰éœ€è¦æ›´æ–°çš„ç‰ˆæœ¬"
          exit 0
        fi
        
        # 6. æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶å’Œä¸‹è½½é“¾æ¥æ–‡ä»¶
        echo "æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶å’Œä¸‹è½½é“¾æ¥..."
        
        # åˆ›å»ºä¸´æ—¶ç‰ˆæœ¬æ–‡ä»¶
        TEMP_VERSION_FILE="$WORK_DIR/version_temp.json"
        
        # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        if [ -n "$CURRENT_YOUTUBE" ]; then
          echo "$CURRENT_VERSION_DATA" | jq --arg key "youtube" --arg value "$NEW_YOUTUBE_VALUE" '.[$key] = $value' > "$TEMP_VERSION_FILE"
        else
          echo "$CURRENT_VERSION_DATA" | jq --arg key "youtube" --arg value "$NEW_YOUTUBE_VALUE" '. + {($key): $value}' > "$TEMP_VERSION_FILE"
        fi
        
        # éªŒè¯ç¬¬ä¸€æ­¥æˆåŠŸ
        if [ $? -ne 0 ]; then
          echo "é”™è¯¯: ç¬¬ä¸€æ­¥ç‰ˆæœ¬æ–‡ä»¶æ›´æ–°å¤±è´¥"
          exit 1
        fi
        
        # ç¬¬äºŒæ­¥æ›´æ–°YouTube Music
        if [ -n "$CURRENT_YOUTUBE_MUSIC" ]; then
          cat "$TEMP_VERSION_FILE" | jq --arg key "youtube_music" --arg value "$NEW_YOUTUBE_MUSIC_VALUE" '.[$key] = $value' > "$VERSION_FILE"
        else
          cat "$TEMP_VERSION_FILE" | jq --arg key "youtube_music" --arg value "$NEW_YOUTUBE_MUSIC_VALUE" '. + {($key): $value}' > "$VERSION_FILE"
        fi
        
        # éªŒè¯ç¬¬äºŒæ­¥æˆåŠŸ
        if [ $? -ne 0 ]; then
          echo "é”™è¯¯: ç¬¬äºŒæ­¥ç‰ˆæœ¬æ–‡ä»¶æ›´æ–°å¤±è´¥"
          exit 1
        fi
        
        # åˆ›å»ºä¸‹è½½é“¾æ¥æ–‡ä»¶
        DOWNLOAD_LINKS_JSON=$(cat <<EOF
{
  "youtube": {
    "name": "$YOUTUBE_APK_NAME",
    "version": "$YOUTUBE_VERSION",
    "download_url": "$YOUTUBE_DOWNLOAD_URL",
    "size": $YOUTUBE_FILE_SIZE,
    "release_date": "$RELEASE_DATE_UTC8",
    "release_tag": "$RELEASE_TAG"
  },
  "youtube_music": {
    "name": "$YOUTUBE_MUSIC_APK_NAME",
    "version": "$YOUTUBE_MUSIC_VERSION",
    "download_url": "$YOUTUBE_MUSIC_DOWNLOAD_URL",
    "size": $YOUTUBE_MUSIC_FILE_SIZE,
    "release_date": "$RELEASE_DATE_UTC8",
    "release_tag": "$RELEASE_TAG"
  }
}
EOF
        )
        
        echo "$DOWNLOAD_LINKS_JSON" | jq -r . > "$DOWNLOAD_LINKS_FILE"
        
        echo "ç‰ˆæœ¬æ–‡ä»¶å’Œä¸‹è½½é“¾æ¥å·²æ›´æ–°"
        
        # 7. åˆ›å»ºREADMEæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        README_FILE="$TARGET_DIR/APK_DOWNLOADS.md"
        cat > "$README_FILE" <<EOF
# YouTube ReVanced APK ä¸‹è½½ä¿¡æ¯

> æœ€åæ›´æ–°: $(date)

## å½“å‰ç‰ˆæœ¬ä¿¡æ¯

| åº”ç”¨ | ç‰ˆæœ¬ | å‘å¸ƒæ—¥æœŸ | æ–‡ä»¶å¤§å° | ä¸‹è½½é“¾æ¥ |
|------|------|----------|----------|----------|
| YouTube ReVanced | $YOUTUBE_VERSION | $RELEASE_DATE_UTC8 | $((YOUTUBE_FILE_SIZE/1024/1024))MB | [ä¸‹è½½]($YOUTUBE_DOWNLOAD_URL) |
| YouTube Music ReVanced | $YOUTUBE_MUSIC_VERSION | $RELEASE_DATE_UTC8 | $((YOUTUBE_MUSIC_FILE_SIZE/1024/1024))MB | [ä¸‹è½½]($YOUTUBE_MUSIC_DOWNLOAD_URL) |

## ä½¿ç”¨è¯´æ˜

1. ç‚¹å‡»ä¸Šé¢çš„ä¸‹è½½é“¾æ¥ç›´æ¥ä¸‹è½½APKæ–‡ä»¶
2. åœ¨Androidè®¾å¤‡ä¸Šå®‰è£…ä¸‹è½½çš„APKæ–‡ä»¶
3. å¦‚æœæç¤º"ç¦æ­¢å®‰è£…æ¥è‡ªæœªçŸ¥æ¥æºçš„åº”ç”¨"ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­å…è®¸å®‰è£…æœªçŸ¥æ¥æºçš„åº”ç”¨

## æ³¨æ„äº‹é¡¹

- è¿™äº›APKæ–‡ä»¶æ¥è‡ª [NoName-exe/revanced](https://github.com/NoName-exe/revanced) ä»“åº“
- æ–‡ä»¶å¤§å°è¶…è¿‡GitHubçš„100MBé™åˆ¶ï¼Œå› æ­¤ä¸ç›´æ¥å­˜å‚¨åœ¨ä»“åº“ä¸­
- ç‰ˆæœ¬ä¿¡æ¯ä¼šè‡ªåŠ¨åŒæ­¥æ›´æ–°

## è‡ªåŠ¨åŒ–ä¿¡æ¯

æ­¤é¡µé¢ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆï¼Œæ¯4å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ›´æ–°ã€‚

EOF
        
        # 8. æäº¤å’Œæ¨é€
        cd "$TARGET_DIR"
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff-index --quiet HEAD --; then
          echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          exit 0
        fi

        COMMIT_MESSAGE="æ›´æ–°YouTube APKä¿¡æ¯: YouTube ($YOUTUBE_VERSION) YouTube Music ($YOUTUBE_MUSIC_VERSION) - $RELEASE_TAG"
        
        git commit -m "$COMMIT_MESSAGE"
        
        # æ¨é€é‡è¯•æœºåˆ¶
        for i in {1..3}; do
          echo "å°è¯• $i/3: æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
          git pull origin main --rebase || {
            echo "æ‹‰å–å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
            sleep 10
            continue
          }
          
          echo "å°è¯• $i/3: æ¨é€æ›´æ”¹..."
          if git push origin main; then
            echo "æ¨é€æˆåŠŸ!"
            break
          else
            echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
            sleep 10
          fi
        done
        
        if [ $i -eq 3 ]; then
          echo "é”™è¯¯: ç»è¿‡3æ¬¡å°è¯•åä»æ— æ³•æ¨é€æ›´æ”¹"
          exit 1
        fi

        # 9. æœ€ç»ˆéªŒè¯
        echo "åŒæ­¥å®Œæˆï¼ŒéªŒè¯ç»“æœ:"
        echo "ç‰ˆæœ¬æ–‡ä»¶: $([ -f "$VERSION_FILE" ] && echo "å­˜åœ¨" || echo "ç¼ºå¤±")"
        echo "ä¸‹è½½é“¾æ¥æ–‡ä»¶: $([ -f "$DOWNLOAD_LINKS_FILE" ] && echo "å­˜åœ¨" || echo "ç¼ºå¤±")"
        echo "READMEæ–‡ä»¶: $([ -f "$README_FILE" ] && echo "å­˜åœ¨" || echo "ç¼ºå¤±")"
        
        echo "æ‰€æœ‰æ–‡ä»¶å·²ç¡®è®¤åŒæ­¥è‡³ä»“åº“"
        echo "çŠ¶æ€: æˆåŠŸ"

    - name: Release Repository Lock ğŸ”“
      if: always()
      uses: softprops/turnstyle@v3
      with:
        continue-on-error: true
        action: unlock
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          try {
            if (context.issue && context.issue.number) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ğŸš¨ YouTube APKåŒæ­¥å¤±è´¥ï¼å·¥ä½œæµè¿è¡Œ: [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              });
            } else {
              const issueTitle = "YouTube APKåŒæ­¥å¤±è´¥é€šçŸ¥";
              const issueBody = `### ğŸš¨ YouTube APKåŒæ­¥å¤±è´¥\n\n` +
                               `**å·¥ä½œæµ**: [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n` +
                               `**å¤±è´¥æ—¶é—´**: ${new Date().toISOString()}\n\n` +
                               `è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚`;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody
              });
            }
          } catch (error) {
            console.error('é€šçŸ¥å¤±è´¥:', error);
            core.warning('æ— æ³•å‘é€é€šçŸ¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥å·¥ä½œæµå¤±è´¥æƒ…å†µ');
          }

  cleanup_self:
    name: Cleanup Self Workflow History
    runs-on: ubuntu-latest
    needs: sync
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2.0.6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "YouTube APK Sync from Source Repository"
          repository: ${{ github.repository }}