name: Build and Commit YSP Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: '镜像版本标签'
        required: true
        default: 'latest'

jobs:
  init-go-module:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (Shallow)
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Initialize Go module
        run: |
          cd ysp
          if [ ! -f "go.mod" ]; then
            go mod init ysp
            go get github.com/gorilla/mux
            go get golang.org/x/crypto
          fi
          go mod tidy

  build-and-commit:
    needs: init-go-module
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      - name: Checkout repository (Shallow)
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd ysp
          echo "正在构建 ${{ matrix.platform.target }} 平台镜像..."
          if [ "${{ matrix.platform.govariant }}" != "" ]; then
            docker buildx build --platform ${{ matrix.platform.name }} --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar -t ysp:${{ matrix.platform.target }} --build-arg TARGETARCH=${{ matrix.platform.goarch }} --build-arg TARGETVARIANT=${{ matrix.platform.govariant }} .
          else
            docker buildx build --platform ${{ matrix.platform.name }} --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar -t ysp:${{ matrix.platform.target }} --build-arg TARGETARCH=${{ matrix.platform.goarch }} .
          fi
          echo "构建完成。"

      - name: Save and checksum image
        run: |
          cd ysp
          # 确保目标目录存在
          mkdir -p images
          # 移动并重命名文件，保持一致性
          mv ysp-${{ matrix.platform.target }}.tar images/
          # 计算校验和
          cd images
          sha256sum ysp-${{ matrix.platform.target }}.tar > ysp-${{ matrix.platform.target }}.tar.sha256
          echo "文件已保存至 ysp/images/"

      - name: Prepare for commit and push
        run: |
          echo "正在获取完整的Git历史记录以便推送..."
          # 此命令将浅克隆的仓库转换为完整克隆
          git fetch --prune --unshallow origin
          # 确保本地分支正确跟踪远程分支
          git branch --set-upstream-to=origin/${{ github.ref_name }} ${{ github.ref_name }}
          echo "历史记录获取完成。"

      - name: Commit and Push to Git Repository
        env:
          # 使用GitHub自动提供的令牌，拥有对当前仓库的写入权限
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 配置Git提交者身份（使用GitHub Actions机器人）
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          echo "检查 ysp/images/ 目录的变动..."
          # 检查是否有新的镜像文件生成
          if git status --porcelain ysp/images/ | grep -q .; then
            echo "检测到新的镜像文件，准备提交..."

            # 添加所有变动的镜像文件
            git add ysp/images/

            # 创建提交信息，[skip ci] 是防止工作流循环触发的关键
            git commit -m "chore(ci): 自动更新 ${{ matrix.platform.target }} 平台镜像 [skip ci]"

            echo "正在推送到仓库..."
            # 推送到触发工作流的同一分支
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
            echo "✅ 已成功提交并推送 ${{ matrix.platform.target }} 镜像文件至仓库。"
          else
            echo "没有检测到新的文件变动，跳过提交。"
          fi