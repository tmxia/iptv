name: Build and Commit YSP Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾'
        required: true
        default: 'latest'

jobs:
  # å‰ç½®ä½œä¸šï¼šä¸€æ¬¡æ€§å‡†å¤‡å…±äº«ç¯å¢ƒ
  prepare:
    runs-on: ubuntu-latest
    outputs:
      prepared-workspace-version: ${{ steps.generate-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: ysp/go.sum

      - name: Initialize Go module
        run: |
          cd ysp
          if [ ! -f "go.mod" ]; then
            go mod init ysp
            go get github.com/gorilla/mux
            go get golang.org/x/crypto
          fi
          go mod tidy

      - name: Generate workspace version
        id: generate-version
        run: |
          # åŸºäºæ—¶é—´å’Œéšæœºæ•°ç”Ÿæˆå”¯ä¸€ç‰ˆæœ¬æ ‡è¯†
          TIMESTAMP=$(date +%s)
          RANDOM_SUFFIX=$(openssl rand -hex 4)
          echo "version=${TIMESTAMP}-${RANDOM_SUFFIX}" >> $GITHUB_OUTPUT

      - name: Upload prepared workspace
        uses: actions/upload-artifact@v4
        with:
          name: prepared-workspace
          path: |
            ysp/
            !ysp/images/
          retention-days: 1

  # å¹¶è¡Œæ„å»ºä½œä¸šï¼šä¸‹è½½å…±äº«ç¯å¢ƒå¹¶æ„å»º
  build-and-commit:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      # ä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•å†ç§»åŠ¨
      - name: Download prepared workspace
        uses: actions/download-artifact@v4
        with:
          name: prepared-workspace
          path: workspace-temp

      - name: Restore workspace structure
        run: |
          echo "ğŸ“ æ¢å¤å·¥ä½œåŒºç»“æ„..."
          
          # æ£€æŸ¥ä¸‹è½½çš„ç›®å½•ç»“æ„
          echo "ä¸´æ—¶ç›®å½•å†…å®¹:"
          ls -la workspace-temp/
          
          # æƒ…å†µ1ï¼šå¦‚æœç›´æ¥åŒ…å«äº†yspç›®å½•
          if [ -d "workspace-temp/ysp" ]; then
            echo "æ£€æµ‹åˆ° workspace-temp/ysp ç›®å½•"
            mv workspace-temp/ysp .
          # æƒ…å†µ2ï¼šå¦‚æœæ–‡ä»¶ç›´æ¥è§£å‹åœ¨ä¸´æ—¶ç›®å½•æ ¹ä¸‹
          else
            echo "æ£€æµ‹åˆ°æ–‡ä»¶ç›´æ¥ä½äº workspace-temp/"
            # å°†ä¸´æ—¶ç›®å½•é‡å‘½åä¸ºysp
            mv workspace-temp ysp
          fi
          
          # éªŒè¯yspç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "ysp" ]; then
            echo "âœ… ysp ç›®å½•åˆ›å»ºæˆåŠŸ"
            echo "yspç›®å½•å†…å®¹:"
            ls -la ysp/
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            if [ -f "ysp/go.mod" ]; then
              echo "âœ… æ‰¾åˆ° go.mod æ–‡ä»¶"
            else
              echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ° go.mod æ–‡ä»¶"
              echo "å½“å‰ç›®å½•æ ‘:"
              find . -name "*.go" -o -name "go.mod" -o -name "go.sum" | head -10
            fi
          else
            echo "âŒ é”™è¯¯: ysp ç›®å½•åˆ›å»ºå¤±è´¥"
            exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Clean disk space before build
        run: |
          echo "ğŸ§¹ æ„å»ºå‰æ¸…ç†ç£ç›˜ç©ºé—´..."
          df -h
          docker system prune -a -f --volumes || true
          sudo apt-get clean || true
          sudo rm -rf /usr/local/lib/android /opt/ghc /usr/local/share/boost || true
          echo "æ¸…ç†åç£ç›˜çŠ¶æ€:"
          df -h

      - name: Build Docker image
        run: |
          cd ysp
          echo "ğŸš§ æ­£åœ¨æ„å»º ${{ matrix.platform.target }} å¹³å°é•œåƒ..."
          
          # åŠ¨æ€æ„å»ºå‘½ä»¤
          BUILD_CMD="docker buildx build --platform ${{ matrix.platform.name }} "
          BUILD_CMD+="--output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar "
          BUILD_CMD+="-t ysp:${{ matrix.platform.target }} "
          BUILD_CMD+="--build-arg TARGETARCH=${{ matrix.platform.goarch }}"
          
          if [ -n "${{ matrix.platform.govariant }}" ]; then
            BUILD_CMD+=" --build-arg TARGETVARIANT=${{ matrix.platform.govariant }}"
          fi
          
          BUILD_CMD+=" ."
          echo "æ‰§è¡Œå‘½ä»¤: $BUILD_CMD"
          eval $BUILD_CMD
          
          echo "âœ… æ„å»ºå®Œæˆã€‚"

      - name: Save and checksum image
        run: |
          cd ysp
          mkdir -p images
          
          # ç¡®ä¿é•œåƒæ–‡ä»¶å­˜åœ¨
          if [ -f "ysp-${{ matrix.platform.target }}.tar" ]; then
            mv ysp-${{ matrix.platform.target }}.tar images/
            echo "âœ… é•œåƒæ–‡ä»¶å·²ç§»åŠ¨åˆ° images/ ç›®å½•"
          else
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° ysp-${{ matrix.platform.target }}.tar"
            ls -la *.tar 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ä»»ä½•.taræ–‡ä»¶"
            exit 1
          fi
          
          cd images
          sha256sum ysp-${{ matrix.platform.target }}.tar > ysp-${{ matrix.platform.target }}.tar.sha256
          echo "ğŸ“¦ æ–‡ä»¶å·²ä¿å­˜è‡³ ysp/images/"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-image-${{ matrix.platform.target }}
          path: |
            ysp/images/ysp-${{ matrix.platform.target }}.tar
            ysp/images/ysp-${{ matrix.platform.target }}.tar.sha256
          if-no-files-found: error
          retention-days: 1

  # æäº¤ä½œä¸šï¼šæ”¶é›†æ‰€æœ‰æ„å»ºäº§ç‰©å¹¶æäº¤
  commit-all-to-repo:
    needs: build-and-commit
    runs-on: ubuntu-latest
    steps:
      - name: Clean disk space before checkout
        run: |
          echo "ğŸ§¹ æ£€å‡ºå‰å½»åº•æ¸…ç†ç£ç›˜ç©ºé—´..."
          df -h
          docker system prune -a -f --volumes || true
          sudo apt-get autoremove -y || true
          sudo apt-get clean || true
          sudo rm -rf /usr/local/lib/android /opt/ghc /usr/local/share/boost /image-generation /__t /opt/hostedtoolcache/CodeQL /opt/microsoft /usr/share/dotnet/shared /usr/share/dotnet/host /usr/share/dotnet/sdk || true
          echo "æ¸…ç†åç£ç›˜çŠ¶æ€:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10
          ref: ${{ github.ref }}

      - name: Download all built images
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts
          pattern: ysp-image-*
          merge-multiple: true

      - name: Organize files to repository
        run: |
          echo "ğŸ—‚ï¸ æ•´ç†æ‰€æœ‰å¹³å°çš„é•œåƒæ–‡ä»¶åˆ°ä»“åº“ç›®å½•..."
          mkdir -p ysp/images
          
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶
          rm -f ysp/images/ysp-*.tar ysp/images/ysp-*.tar.sha256
          
          # å¤åˆ¶æ–°æ–‡ä»¶
          if [ -d "downloaded-artifacts" ]; then
            find downloaded-artifacts -type f \( -name "*.tar" -o -name "*.sha256" \) -exec cp {} ysp/images/ \;
          fi
          
          echo "æ•´ç†åçš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la ysp/images/

      - name: Configure Git for push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and Push All to Git Repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” æ£€æŸ¥ä»“åº“å˜åŠ¨..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          if [ -z "$(git status --porcelain ysp/images/)" ]; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–°çš„æ–‡ä»¶å˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
            exit 0
          fi
          
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŠ¨ï¼Œå‡†å¤‡æäº¤æ‰€æœ‰é•œåƒ..."
          git add ysp/images/
          git commit -m "chore(ci): è‡ªåŠ¨æ›´æ–°æ‰€æœ‰å¤šå¹³å°é•œåƒ [skip ci]"
          
          echo "ğŸ“¤ æ­£åœ¨æ¨é€åˆ°ä»“åº“..."
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref }} --force-if-includes
          
          echo "âœ… å·²æˆåŠŸæäº¤å¹¶æ¨é€æ‰€æœ‰é•œåƒæ–‡ä»¶è‡³ä»“åº“ã€‚"