name: Build and Commit YSP Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾'
        required: true
        default: 'latest'

jobs:
  init-go-module:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (Shallow)
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Initialize Go module
        run: |
          cd ysp
          if [ ! -f "go.mod" ]; then
            go mod init ysp
            go get github.com/gorilla/mux
            go get golang.org/x/crypto
          fi
          go mod tidy

  build-and-commit:
    needs: init-go-module
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      - name: Checkout repository (Shallow)
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd ysp
          echo "ğŸš§ æ­£åœ¨æ„å»º ${{ matrix.platform.target }} å¹³å°é•œåƒ..."
          if [ "${{ matrix.platform.govariant }}" != "" ]; then
            docker buildx build --platform ${{ matrix.platform.name }} --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar -t ysp:${{ matrix.platform.target }} --build-arg TARGETARCH=${{ matrix.platform.goarch }} --build-arg TARGETVARIANT=${{ matrix.platform.govariant }} .
          else
            docker buildx build --platform ${{ matrix.platform.name }} --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar -t ysp:${{ matrix.platform.target }} --build-arg TARGETARCH=${{ matrix.platform.goarch }} .
          fi
          echo "âœ… æ„å»ºå®Œæˆã€‚"

      - name: Save and checksum image
        run: |
          cd ysp
          mkdir -p images
          mv ysp-${{ matrix.platform.target }}.tar images/
          cd images
          sha256sum ysp-${{ matrix.platform.target }}.tar > ysp-${{ matrix.platform.target }}.tar.sha256
          echo "ğŸ“¦ æ–‡ä»¶å·²ä¿å­˜è‡³ ysp/images/"

      # å…³é”®ä¿®æ”¹ï¼šæ¯ä¸ªå¹³å°æ„å»ºå®Œæˆåï¼Œç«‹å³ä¸Šä¼ è‡ªå·±çš„äº§ç‰©
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-image-${{ matrix.platform.target }}
          path: |
            ysp/images/ysp-${{ matrix.platform.target }}.tar
            ysp/images/ysp-${{ matrix.platform.target }}.tar.sha256
          if-no-files-found: error
          retention-days: 1

  # æ–°å¢ï¼šç‹¬ç«‹ã€å”¯ä¸€çš„æäº¤ä½œä¸š
  commit-all-to-repo:
    needs: build-and-commit # ç­‰å¾…æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆ
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (Full history)
        uses: actions/checkout@v4
        with:
          # å…³é”®ä¼˜åŒ–ï¼šå®Œæ•´å…‹éš†ä»…åœ¨æ­¤å¤„æ‰§è¡Œä¸€æ¬¡
          fetch-depth: 0

      - name: Download all built images
        uses: actions/download-artifact@v4
        with:
          # ä¸‹è½½æ‰€æœ‰æ„å»ºä½œä¸šä¸Šä¼ çš„äº§ç‰©
          path: downloaded-artifacts
          pattern: ysp-image-*
          merge-multiple: true

      - name: Organize files to repository
        run: |
          echo "ğŸ—‚ï¸ æ•´ç†æ‰€æœ‰å¹³å°çš„é•œåƒæ–‡ä»¶åˆ°ä»“åº“ç›®å½•..."
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p ysp/images
          # å¤åˆ¶æ‰€æœ‰ .tar å’Œ .sha256 æ–‡ä»¶åˆ°ä»“åº“ç›®å½•
          find downloaded-artifacts -type f \( -name "*.tar" -o -name "*.sha256" \) -exec cp {} ysp/images/ \;
          # åˆ—å‡ºæœ€ç»ˆæ–‡ä»¶ï¼Œç”¨äºç¡®è®¤
          echo "æ•´ç†åçš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la ysp/images/

      - name: Commit and Push All to Git Repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          echo "ğŸ” æ£€æŸ¥ä»“åº“å˜åŠ¨..."
          if git status --porcelain ysp/images/ | grep -q .; then
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŠ¨ï¼Œå‡†å¤‡æäº¤æ‰€æœ‰é•œåƒ..."
            git add ysp/images/
            # ä¸€æ¬¡æ€§æäº¤æ‰€æœ‰å¹³å°çš„æ–‡ä»¶
            git commit -m "chore(ci): è‡ªåŠ¨æ›´æ–°æ‰€æœ‰å¤šå¹³å°é•œåƒ [skip ci]"
            echo "ğŸ“¤ æ­£åœ¨æ¨é€åˆ°ä»“åº“..."
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
            echo "âœ… å·²æˆåŠŸæäº¤å¹¶æ¨é€æ‰€æœ‰é•œåƒæ–‡ä»¶è‡³ä»“åº“ã€‚"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–°çš„æ–‡ä»¶å˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
          fi