name: Build YSP Multi-Platform Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: '镜像版本标签'
        required: true
        default: 'latest'

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

  init-go-module:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Initialize Go module
        run: |
          cd ysp
          if [ ! -f "go.mod" ]; then
            go mod init ysp
            go get github.com/gorilla/mux
            go get golang.org/x/crypto
          fi
          go mod tidy

  build:
    needs: init-go-module
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd ysp
          echo "Building for platform: ${{ matrix.platform.name }}"
          if [ "${{ matrix.platform.govariant }}" != "" ]; then
            docker buildx build --platform ${{ matrix.platform.name }} --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar -t ysp:${{ matrix.platform.target }} --build-arg TARGETARCH=${{ matrix.platform.goarch }} --build-arg TARGETVARIANT=${{ matrix.platform.govariant }} .
          else
            docker buildx build --platform ${{ matrix.platform.name }} --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar -t ysp:${{ matrix.platform.target }} --build-arg TARGETARCH=${{ matrix.platform.goarch }} .
          fi
          
          # 检查文件是否生成
          echo "Checking if file was created:"
          ls -la ysp-*.tar || echo "No tar files found"
          pwd

      - name: Create images directory and save files
        run: |
          # 进入ysp目录
          cd ysp
          
          # 显示当前目录内容
          echo "Current directory (ysp/):"
          ls -la
          
          # 创建images目录
          mkdir -p images
          
          # 检查tar文件是否存在
          if [ -f "ysp-${{ matrix.platform.target }}.tar" ]; then
            echo "Moving ysp-${{ matrix.platform.target }}.tar to images/"
            mv ysp-${{ matrix.platform.target }}.tar images/
            
            # 进入images目录计算校验和
            cd images
            echo "Current directory (ysp/images/):"
            ls -la
            
            sha256sum ysp-${{ matrix.platform.target }}.tar > ysp-${{ matrix.platform.target }}.tar.sha256
            
            # 显示生成的文件
            echo "Generated files:"
            ls -la ysp-${{ matrix.platform.target }}.tar*
            echo "SHA256 checksum:"
            cat ysp-${{ matrix.platform.target }}.tar.sha256
          else
            echo "ERROR: ysp-${{ matrix.platform.target }}.tar not found!"
            # 列出所有文件以帮助调试
            echo "All files in ysp/:"
            ls -la
          fi

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-${{ matrix.platform.target }}
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar
          if-no-files-found: error

      - name: Upload SHA256 checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-${{ matrix.platform.target }}-sha256
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar.sha256
          if-no-files-found: error

      - name: Verify files are accessible
        run: |
          echo "Verifying files in repository:"
          find . -name "*.tar" -o -name "*.sha256" | head -20
          
          echo "Checking ysp/images directory:"
          if [ -d "ysp/images" ]; then
            ls -la ysp/images/
          else
            echo "ERROR: ysp/images directory does not exist!"
          fi
