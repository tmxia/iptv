name: Build YSP Multi-Platform Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾'
        required: true
        default: 'latest'

jobs:
  # å‰ç½®å‡†å¤‡ä½œä¸šï¼šæ‰§è¡Œæ‰€æœ‰å¯å…±äº«çš„æ­¥éª¤
  prepare:
    runs-on: ubuntu-latest
    outputs: # å®šä¹‰è¾“å‡ºå˜é‡ï¼Œä¾›åç»­ä½œä¸šä½¿ç”¨
      prepared-workspace-version: ${{ steps.generate-timestamp.outputs.timestamp }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # æµ…å…‹éš†ï¼ŒåŠ å¿«é€Ÿåº¦

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: ./ysp/go.sum # å¯ç”¨Goæ¨¡å—ç¼“å­˜

      - name: Initialize Go module
        run: |
          cd ysp
          if [ ! -f "go.mod" ]; then
            go mod init ysp
            go get github.com/gorilla/mux
            go get golang.org/x/crypto
          fi
          go mod tidy

      - name: Generate timestamp for workspace
        id: generate-timestamp
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Upload prepared workspace
        uses: actions/upload-artifact@v4
        with:
          name: prepared-workspace
          path: |
            ysp/
            !ysp/images/
          retention-days: 1

  # å¹¶è¡Œæ„å»ºä½œä¸š
  build:
    needs: prepare # ä¾èµ–å‰ç½®å‡†å¤‡ä½œä¸š
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # å³ä½¿ä¸€ä¸ªå¹³å°å¤±è´¥ï¼Œå…¶ä»–å¹³å°ç»§ç»­æ„å»º
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      # ä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•å¹¶æ­£ç¡®ç§»åŠ¨æ–‡ä»¶
      - name: Download prepared workspace
        uses: actions/download-artifact@v4
        with:
          name: prepared-workspace
          path: workspace-temp

      - name: Restore workspace structure
        run: |
          echo "ğŸ“ æ¢å¤å·¥ä½œåŒºç»“æ„..."
          
          # æ£€æŸ¥ä¸‹è½½çš„ç›®å½•ç»“æ„
          echo "ä¸´æ—¶ç›®å½•å†…å®¹:"
          ls -la workspace-temp/
          
          # æƒ…å†µ1ï¼šå¦‚æœç›´æ¥åŒ…å«äº†yspç›®å½•
          if [ -d "workspace-temp/ysp" ]; then
            echo "æ£€æµ‹åˆ° workspace-temp/ysp ç›®å½•"
            mv workspace-temp/ysp .
          # æƒ…å†µ2ï¼šå¦‚æœæ–‡ä»¶ç›´æ¥è§£å‹åœ¨ä¸´æ—¶ç›®å½•æ ¹ä¸‹
          else
            echo "æ£€æµ‹åˆ°æ–‡ä»¶ç›´æ¥ä½äº workspace-temp/"
            # å°†ä¸´æ—¶ç›®å½•é‡å‘½åä¸ºysp
            mv workspace-temp ysp
          fi
          
          # éªŒè¯yspç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "ysp" ]; then
            echo "âœ… ysp ç›®å½•åˆ›å»ºæˆåŠŸ"
            echo "yspç›®å½•å†…å®¹:"
            ls -la ysp/
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            if [ -f "ysp/go.mod" ]; then
              echo "âœ… æ‰¾åˆ° go.mod æ–‡ä»¶"
            else
              echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ° go.mod æ–‡ä»¶"
              echo "å½“å‰ç›®å½•æ ‘:"
              find . -name "*.go" -o -name "go.mod" -o -name "go.sum" | head -10
            fi
          else
            echo "âŒ é”™è¯¯: ysp ç›®å½•åˆ›å»ºå¤±è´¥"
            exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
            network=host

      - name: Build Docker image for ${{ matrix.platform.target }}
        run: |
          echo "ğŸš§ æ­£åœ¨æ„å»º ${{ matrix.platform.target }} å¹³å°é•œåƒ..."
          
          # è¿›å…¥yspç›®å½•æ„å»º
          cd ysp
          
          # æ ¹æ®å¹³å°å˜é‡åŠ¨æ€æ„å»ºå‘½ä»¤
          BUILD_ARGS="--platform ${{ matrix.platform.name }} \
                      --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar \
                      -t ysp:${{ matrix.platform.target }} \
                      --build-arg TARGETARCH=${{ matrix.platform.goarch }}"
          
          if [ -n "${{ matrix.platform.govariant }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg TARGETVARIANT=${{ matrix.platform.govariant }}"
          fi
          
          echo "æ‰§è¡Œå‘½ä»¤: docker buildx build $BUILD_ARGS ."
          docker buildx build $BUILD_ARGS .
          echo "âœ… æ„å»ºå®Œæˆã€‚"

      - name: Prepare images directory
        run: |
          echo "ğŸ“‚ å‡†å¤‡é•œåƒç›®å½•..."
          cd ysp
          mkdir -p images
          echo "å½“å‰ç›®å½•: $(pwd)"
          ls -la

      - name: Move image and calculate checksum
        run: |
          cd ysp
          echo "ç§»åŠ¨é•œåƒæ–‡ä»¶å¹¶è®¡ç®—æ ¡éªŒå’Œ..."
          
          # ç¡®ä¿æºæ–‡ä»¶å­˜åœ¨
          if [ -f "ysp-${{ matrix.platform.target }}.tar" ]; then
            mv ysp-${{ matrix.platform.target }}.tar images/
            echo "âœ… é•œåƒæ–‡ä»¶å·²ç§»åŠ¨åˆ° images/ ç›®å½•"
          else
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° ysp-${{ matrix.platform.target }}.tar"
            ls -la *.tar 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ä»»ä½•.taræ–‡ä»¶"
            exit 1
          fi
          
          # è®¡ç®—æ ¡éªŒå’Œ
          cd images
          sha256sum ysp-${{ matrix.platform.target }}.tar > ysp-${{ matrix.platform.target }}.tar.sha256
          echo "ğŸ“¦ æ ¡éªŒå’Œæ–‡ä»¶å·²ç”Ÿæˆ"
          echo "ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la *.sha256

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-image-${{ matrix.platform.target }}
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar
          retention-days: 7

      - name: Upload checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-checksum-${{ matrix.platform.target }}
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar.sha256
          retention-days: 7

  # æ”¶é›†å’Œå±•ç¤ºæ‰€æœ‰å¹³å°çš„ä¸‹è½½ä¿¡æ¯
  post-process:
    needs: build
    runs-on: ubuntu-latest
    if: always() # å³ä½¿éƒ¨åˆ†æ„å»ºå¤±è´¥ä¹Ÿæ‰§è¡Œï¼Œä¾¿äºæ¸…ç†æˆ–é€šçŸ¥
    steps:
      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
      
      - name: Collect and display download links
        run: |
          echo "========================================"
          echo "âœ… YSP å¤šå¹³å°é•œåƒæ„å»ºå®Œæˆ"
          echo "========================================"
          echo ""
          echo "ğŸ³ å¯ç”¨é•œåƒæ–‡ä»¶:"
          echo ""
          
          # æ˜¾ç¤ºå„ä¸ªå¹³å°çš„é•œåƒæ–‡ä»¶
          for platform in "x86_64" "aarch64" "armv7"; do
            IMAGE_FILE=""
            SHA_FILE=""
            
            # æŸ¥æ‰¾å¯¹åº”çš„æ–‡ä»¶
            if [ -f "all-artifacts/ysp-image-$platform/ysp-$platform.tar" ]; then
              IMAGE_FILE="all-artifacts/ysp-image-$platform/ysp-$platform.tar"
            elif [ -f "all-artifacts/ysp-image-$platform/ysp/images/ysp-$platform.tar" ]; then
              IMAGE_FILE="all-artifacts/ysp-image-$platform/ysp/images/ysp-$platform.tar"
            fi
            
            if [ -f "all-artifacts/ysp-checksum-$platform/ysp-$platform.tar.sha256" ]; then
              SHA_FILE="all-artifacts/ysp-checksum-$platform/ysp-$platform.tar.sha256"
            elif [ -f "all-artifacts/ysp-checksum-$platform/ysp/images/ysp-$platform.tar.sha256" ]; then
              SHA_FILE="all-artifacts/ysp-checksum-$platform/ysp/images/ysp-$platform.tar.sha256"
            fi
            
            if [ -n "$IMAGE_FILE" ] && [ -f "$IMAGE_FILE" ]; then
              SIZE=$(du -h "$IMAGE_FILE" | cut -f1)
              echo "ğŸ“¦ $platform å¹³å°:"
              echo "   â€¢ é•œåƒæ–‡ä»¶: ysp-$platform.tar (${SIZE})"
              
              if [ -n "$SHA_FILE" ] && [ -f "$SHA_FILE" ]; then
                echo "   â€¢ æ ¡éªŒæ–‡ä»¶: $(basename "$SHA_FILE")"
                echo "   â€¢ SHA256: $(cat "$SHA_FILE" | cut -d' ' -f1)"
              fi
              echo ""
            else
              echo "âš ï¸  $platform å¹³å°: æ–‡ä»¶æœªæ‰¾åˆ°"
              echo ""
            fi
          done
          
          echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
          echo "   1. è¿›å…¥ Artifacts åŒºåŸŸ"
          echo "   2. åˆ†åˆ«ä¸‹è½½:"
          echo "      - ysp-image-x86_64"
          echo "      - ysp-image-aarch64" 
          echo "      - ysp-image-armv7"
          echo "   3. å¯¹åº”æ ¡éªŒæ–‡ä»¶:"
          echo "      - ysp-checksum-x86_64"
          echo "      - ysp-checksum-aarch64"
          echo "      - ysp-checksum-armv7"
          echo ""
          echo "ğŸ”— å·¥ä½œæµé“¾æ¥:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "â° æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "========================================"