name: Build YSP Multi-Platform Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: '镜像版本标签'
        required: true
        default: 'latest'

jobs:
  # 前置准备作业：执行所有可共享的步骤
  prepare:
    runs-on: ubuntu-latest
    outputs:
      prepared-workspace-version: ${{ steps.generate-timestamp.outputs.timestamp }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: ./ysp/go.sum

      - name: Initialize Go module
        run: |
          cd ysp
          if [ ! -f "go.mod" ]; then
            go mod init ysp
            go get github.com/gorilla/mux
            go get golang.org/x/crypto
          fi
          go mod tidy

      - name: Generate timestamp for workspace
        id: generate-timestamp
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Upload prepared workspace
        uses: actions/upload-artifact@v4
        with:
          name: prepared-workspace
          path: |
            ysp/
            !ysp/images/
          retention-days: 1

  # 并行构建作业
  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      - name: Download prepared workspace
        uses: actions/download-artifact@v4
        with:
          name: prepared-workspace
          path: workspace-temp

      - name: Restore workspace structure
        run: |
          echo "📁 恢复工作区结构..."
          
          if [ -d "workspace-temp/ysp" ]; then
            echo "检测到 workspace-temp/ysp 目录"
            mv workspace-temp/ysp .
          else
            echo "检测到文件直接位于 workspace-temp/"
            mv workspace-temp ysp
          fi
          
          if [ -d "ysp" ]; then
            echo "✅ ysp 目录创建成功"
            ls -la ysp/
          else
            echo "❌ 错误: ysp 目录创建失败"
            exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
            network=host

      - name: Build Docker image for ${{ matrix.platform.target }}
        run: |
          echo "🚧 正在构建 ${{ matrix.platform.target }} 平台镜像..."
          cd ysp
          
          BUILD_ARGS="--platform ${{ matrix.platform.name }} \
                      --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar \
                      -t ysp:${{ matrix.platform.target }} \
                      --build-arg TARGETARCH=${{ matrix.platform.goarch }}"
          
          if [ -n "${{ matrix.platform.govariant }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg TARGETVARIANT=${{ matrix.platform.govariant }}"
          fi
          
          docker buildx build $BUILD_ARGS .
          echo "✅ 构建完成。"

      - name: Prepare images directory
        run: |
          cd ysp
          mkdir -p images

      - name: Move image and calculate checksum
        run: |
          cd ysp
          echo "移动镜像文件并计算校验和..."
          
          if [ -f "ysp-${{ matrix.platform.target }}.tar" ]; then
            mv ysp-${{ matrix.platform.target }}.tar images/
            echo "✅ 镜像文件已移动到 images/ 目录"
          else
            echo "❌ 错误: 找不到 ysp-${{ matrix.platform.target }}.tar"
            ls -la *.tar 2>/dev/null || echo "没有找到任何.tar文件"
            exit 1
          fi
          
          cd images
          sha256sum ysp-${{ matrix.platform.target }}.tar > ysp-${{ matrix.platform.target }}.tar.sha256
          echo "📦 校验和文件已生成"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-image-${{ matrix.platform.target }}
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar
          retention-days: 7

      - name: Upload checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-checksum-${{ matrix.platform.target }}
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar.sha256
          retention-days: 7

  # 动态收集和展示构建信息
  post-process:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
      
      - name: Collect and display dynamic build info
        run: |
          echo "========================================"
          echo "✅ YSP 多平台镜像构建完成"
          echo "========================================"
          echo ""
          echo "🐳 本次构建镜像信息:"
          echo ""
          
          # 基础URL
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"
          WEB_URL="${{ github.server_url }}/$REPO/actions/runs/$RUN_ID"
          API_BASE="https://api.github.com/repos/$REPO/actions/artifacts"
          
          # 动态收集各平台信息
          for platform in "x86_64" "aarch64" "armv7"; do
            IMAGE_FILE=""
            SHA_FILE=""
            
            # 查找镜像文件
            for file in $(find all-artifacts -name "*.tar" -type f 2>/dev/null); do
              if echo "$file" | grep -q "$platform"; then
                IMAGE_FILE="$file"
                break
              fi
            done
            
            # 查找校验文件
            for file in $(find all-artifacts -name "*.sha256" -type f 2>/dev/null); do
              if echo "$file" | grep -q "$platform"; then
                SHA_FILE="$file"
                break
              fi
            done
            
            if [ -n "$IMAGE_FILE" ] && [ -f "$IMAGE_FILE" ]; then
              SIZE=$(du -h "$IMAGE_FILE" | cut -f1)
              echo "📦 $platform 平台:"
              echo "   镜像文件: $(basename "$IMAGE_FILE") (${SIZE})"
              
              if [ -n "$SHA_FILE" ] && [ -f "$SHA_FILE" ]; then
                SHA_VALUE=$(cat "$SHA_FILE" | cut -d' ' -f1)
                echo "   SHA256: $SHA_VALUE"
              fi
              
              # 直接下载链接
              echo "   网页下载: $WEB_URL"
              echo "   API链接: $API_BASE?name=ysp-image-$platform"
              echo ""
            else
              echo "⚠️  $platform 平台: 镜像文件未生成"
              echo ""
            fi
          done
          
          echo "📥 下载说明:"
          echo "   1. 网页下载: 访问上方链接，在 'Artifacts' 区域下载文件"
          echo "   2. API下载: 使用API链接配合 GitHub Token 获取文件"
          echo ""
          echo "⏰ 构建时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "🔗 工作流运行: #${{ github.run_number }}"
          echo "========================================"