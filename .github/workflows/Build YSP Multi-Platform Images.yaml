name: Build YSP Multi-Platform Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾'
        required: true
        default: 'latest'

jobs:
  # å‰ç½®å‡†å¤‡ä½œä¸šï¼šæ‰§è¡Œæ‰€æœ‰å¯å…±äº«çš„æ­¥éª¤
  prepare:
    runs-on: ubuntu-latest
    outputs:
      prepared-workspace-version: ${{ steps.generate-timestamp.outputs.timestamp }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: ./ysp/go.sum

      - name: Initialize Go module
        run: |
          cd ysp
          if [ ! -f "go.mod" ]; then
            go mod init ysp
            go get github.com/gorilla/mux
            go get golang.org/x/crypto
          fi
          go mod tidy

      - name: Generate timestamp for workspace
        id: generate-timestamp
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Upload prepared workspace
        uses: actions/upload-artifact@v4
        with:
          name: prepared-workspace
          path: |
            ysp/
            !ysp/images/
          retention-days: 1

  # å¹¶è¡Œæ„å»ºä½œä¸š
  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      - name: Download prepared workspace
        uses: actions/download-artifact@v4
        with:
          name: prepared-workspace
          path: workspace-temp

      - name: Restore workspace structure
        run: |
          echo "ğŸ“ æ¢å¤å·¥ä½œåŒºç»“æ„..."
          
          if [ -d "workspace-temp/ysp" ]; then
            echo "æ£€æµ‹åˆ° workspace-temp/ysp ç›®å½•"
            mv workspace-temp/ysp .
          else
            echo "æ£€æµ‹åˆ°æ–‡ä»¶ç›´æ¥ä½äº workspace-temp/"
            mv workspace-temp ysp
          fi
          
          if [ -d "ysp" ]; then
            echo "âœ… ysp ç›®å½•åˆ›å»ºæˆåŠŸ"
            ls -la ysp/
          else
            echo "âŒ é”™è¯¯: ysp ç›®å½•åˆ›å»ºå¤±è´¥"
            exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
            network=host

      - name: Build Docker image for ${{ matrix.platform.target }}
        run: |
          echo "ğŸš§ æ­£åœ¨æ„å»º ${{ matrix.platform.target }} å¹³å°é•œåƒ..."
          cd ysp
          
          BUILD_ARGS="--platform ${{ matrix.platform.name }} \
                      --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar \
                      -t ysp:${{ matrix.platform.target }} \
                      --build-arg TARGETARCH=${{ matrix.platform.goarch }}"
          
          if [ -n "${{ matrix.platform.govariant }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg TARGETVARIANT=${{ matrix.platform.govariant }}"
          fi
          
          docker buildx build $BUILD_ARGS .
          echo "âœ… æ„å»ºå®Œæˆã€‚"

      - name: Prepare images directory
        run: |
          cd ysp
          mkdir -p images

      - name: Move image and calculate checksum
        run: |
          cd ysp
          echo "ç§»åŠ¨é•œåƒæ–‡ä»¶å¹¶è®¡ç®—æ ¡éªŒå’Œ..."
          
          if [ -f "ysp-${{ matrix.platform.target }}.tar" ]; then
            mv ysp-${{ matrix.platform.target }}.tar images/
            echo "âœ… é•œåƒæ–‡ä»¶å·²ç§»åŠ¨åˆ° images/ ç›®å½•"
          else
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° ysp-${{ matrix.platform.target }}.tar"
            ls -la *.tar 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ä»»ä½•.taræ–‡ä»¶"
            exit 1
          fi
          
          cd images
          sha256sum ysp-${{ matrix.platform.target }}.tar > ysp-${{ matrix.platform.target }}.tar.sha256
          echo "ğŸ“¦ æ ¡éªŒå’Œæ–‡ä»¶å·²ç”Ÿæˆ"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-image-${{ matrix.platform.target }}
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar
          retention-days: 7

      - name: Upload checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-checksum-${{ matrix.platform.target }}
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar.sha256
          retention-days: 7

  # åŠ¨æ€æ”¶é›†å’Œå±•ç¤ºæ„å»ºä¿¡æ¯
  post-process:
    needs: [build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
      
      - name: Collect and display dynamic build info
        run: |
          echo "========================================"
          echo "âœ… YSP å¤šå¹³å°é•œåƒæ„å»ºå®Œæˆ"
          echo "========================================"
          echo ""
          echo "ğŸ³ æœ¬æ¬¡æ„å»ºé•œåƒä¿¡æ¯:"
          echo ""
          
          # åŸºç¡€URL
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"
          SERVER_URL="${{ github.server_url }}"
          
          # åŠ¨æ€æ”¶é›†å„å¹³å°ä¿¡æ¯
          platforms=("x86_64" "aarch64" "armv7")
          
          for platform in "${platforms[@]}"; do
            IMAGE_FILE=""
            SHA_FILE=""
            
            # æŸ¥æ‰¾é•œåƒæ–‡ä»¶
            for file in $(find all-artifacts -name "*.tar" -type f 2>/dev/null); do
              if echo "$file" | grep -q "$platform"; then
                IMAGE_FILE="$file"
                break
              fi
            done
            
            # æŸ¥æ‰¾æ ¡éªŒæ–‡ä»¶
            for file in $(find all-artifacts -name "*.sha256" -type f 2>/dev/null); do
              if echo "$file" | grep -q "$platform"; then
                SHA_FILE="$file"
                break
              fi
            done
            
            if [ -n "$IMAGE_FILE" ] && [ -f "$IMAGE_FILE" ]; then
              SIZE=$(du -h "$IMAGE_FILE" | cut -f1)
              echo "ğŸ“¦ $platform å¹³å°:"
              echo "   é•œåƒæ–‡ä»¶: $(basename "$IMAGE_FILE") (${SIZE})"
              
              # è·å–Artifactä¿¡æ¯
              ARTIFACT_DIR="all-artifacts"
              ARTIFACT_NAME=""
              
              # æ£€æŸ¥artifactç›®å½•ç»“æ„
              if [ -d "$ARTIFACT_DIR/ysp-image-$platform" ]; then
                # æ–°ç‰ˆæœ¬çš„artifactç›®å½•ç»“æ„
                ARTIFACT_INFO_FILE="$ARTIFACT_DIR/ysp-image-$platform/artifact-info.json"
                if [ -f "$ARTIFACT_INFO_FILE" ]; then
                  ARTIFACT_ID=$(grep -o '"id":[[:space:]]*[0-9]*' "$ARTIFACT_INFO_FILE" | head -1 | cut -d':' -f2 | tr -d ' ')
                  if [ -n "$ARTIFACT_ID" ]; then
                    echo "   ä¸‹è½½é“¾æ¥: ${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}/artifacts/${ARTIFACT_ID}"
                  fi
                fi
              fi
              
              if [ -n "$SHA_FILE" ] && [ -f "$SHA_FILE" ]; then
                SHA_VALUE=$(cat "$SHA_FILE" | cut -d' ' -f1)
                echo "   SHA256: $SHA_VALUE"
                
                # å°è¯•è·å–checksum artifactä¿¡æ¯
                if [ -d "$ARTIFACT_DIR/ysp-checksum-$platform" ]; then
                  CHECKSUM_INFO_FILE="$ARTIFACT_DIR/ysp-checksum-$platform/artifact-info.json"
                  if [ -f "$CHECKSUM_INFO_FILE" ]; then
                    CHECKSUM_ID=$(grep -o '"id":[[:space:]]*[0-9]*' "$CHECKSUM_INFO_FILE" | head -1 | cut -d':' -f2 | tr -d ' ')
                    if [ -n "$CHECKSUM_ID" ]; then
                      echo "   æ ¡éªŒæ–‡ä»¶: ${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}/artifacts/${CHECKSUM_ID}"
                    fi
                  fi
                fi
              fi
              
              # å¤‡ç”¨æ–¹æ³•ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°artifact-infoï¼Œæ˜¾ç¤ºé€šç”¨é“¾æ¥
              if [ -z "$ARTIFACT_ID" ]; then
                echo "   ä¸‹è½½é¡µé¢: ${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}"
              fi
              
              echo ""
            else
              echo "âš ï¸  $platform å¹³å°: é•œåƒæ–‡ä»¶æœªç”Ÿæˆ"
              echo ""
            fi
          done
          
          echo ""
          echo "ğŸ“Š æ„å»ºæ‘˜è¦:"
          echo "   å·¥ä½œæµè¿è¡Œ: #${{ github.run_number }}"
          echo "   æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "   ä»£ç ç‰ˆæœ¬: ${{ github.sha }}"
          echo "   è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "   ç‰ˆæœ¬æ ‡ç­¾: ${{ github.event.inputs.version }}"
          fi
          
          echo ""
          echo "ğŸ“‹ ä½¿ç”¨è¯´æ˜:"
          echo "   1. åœ¨ArtifactsåŒºåŸŸä¸‹è½½å¯¹åº”å¹³å°çš„é•œåƒæ–‡ä»¶"
          echo "   2. ä½¿ç”¨ 'docker load -i ysp-<å¹³å°>.tar' å¯¼å…¥é•œåƒ"
          echo "   3. ä½¿ç”¨ 'docker run -d -p 8080:8080 ysp:<å¹³å°>' è¿è¡Œå®¹å™¨"
          echo ""
          echo "ğŸ”— Artifactsä¸‹è½½:"
          echo "   ${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}"
          echo "========================================"
      
      - name: Display artifact structure (è°ƒè¯•)
        if: always()
        run: |
          echo "ğŸ“ Artifactsç›®å½•ç»“æ„:"
          find all-artifacts -type f -name "*.json" | head -20
          echo ""
          echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨:"
          find all-artifacts -type f | head -30