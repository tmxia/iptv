name: Build YSP Multi-Platform Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾'
        required: true
        default: 'latest'

jobs:
  # å‰ç½®å‡†å¤‡ä½œä¸šï¼šæ‰§è¡Œæ‰€æœ‰å¯å…±äº«çš„æ­¥éª¤
  prepare:
    runs-on: ubuntu-latest
    outputs: # å®šä¹‰è¾“å‡ºå˜é‡ï¼Œä¾›åŽç»­ä½œä¸šä½¿ç”¨
      prepared-workspace-version: ${{ steps.generate-timestamp.outputs.timestamp }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # æµ…å…‹éš†ï¼ŒåŠ å¿«é€Ÿåº¦

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: ./ysp/go.sum # å¯ç”¨Goæ¨¡å—ç¼“å­˜

      - name: Initialize Go module
        run: |
          cd ysp
          if [ ! -f "go.mod" ]; then
            go mod init ysp
            go get github.com/gorilla/mux
            go get golang.org/x/crypto
          fi
          go mod tidy

      - name: Generate timestamp for workspace
        id: generate-timestamp
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Upload prepared workspace
        uses: actions/upload-artifact@v4
        with:
          name: prepared-workspace
          path: |
            ysp/
            !ysp/images/
          retention-days: 1

  # å¹¶è¡Œæž„å»ºä½œä¸š
  build:
    needs: prepare # ä¾èµ–å‰ç½®å‡†å¤‡ä½œä¸š
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # å³ä½¿ä¸€ä¸ªå¹³å°å¤±è´¥ï¼Œå…¶ä»–å¹³å°ç»§ç»­æž„å»º
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      # ä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•å¹¶æ­£ç¡®ç§»åŠ¨æ–‡ä»¶
      - name: Download prepared workspace
        uses: actions/download-artifact@v4
        with:
          name: prepared-workspace
          path: workspace-temp

      - name: Restore workspace structure
        run: |
          echo "ðŸ“ æ¢å¤å·¥ä½œåŒºç»“æž„..."
          
          # æ£€æŸ¥ä¸‹è½½çš„ç›®å½•ç»“æž„
          echo "ä¸´æ—¶ç›®å½•å†…å®¹:"
          ls -la workspace-temp/
          
          # æƒ…å†µ1ï¼šå¦‚æžœç›´æŽ¥åŒ…å«äº†yspç›®å½•
          if [ -d "workspace-temp/ysp" ]; then
            echo "æ£€æµ‹åˆ° workspace-temp/ysp ç›®å½•"
            mv workspace-temp/ysp .
          # æƒ…å†µ2ï¼šå¦‚æžœæ–‡ä»¶ç›´æŽ¥è§£åŽ‹åœ¨ä¸´æ—¶ç›®å½•æ ¹ä¸‹
          else
            echo "æ£€æµ‹åˆ°æ–‡ä»¶ç›´æŽ¥ä½äºŽ workspace-temp/"
            # å°†ä¸´æ—¶ç›®å½•é‡å‘½åä¸ºysp
            mv workspace-temp ysp
          fi
          
          # éªŒè¯yspç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "ysp" ]; then
            echo "âœ… ysp ç›®å½•åˆ›å»ºæˆåŠŸ"
            echo "yspç›®å½•å†…å®¹:"
            ls -la ysp/
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            if [ -f "ysp/go.mod" ]; then
              echo "âœ… æ‰¾åˆ° go.mod æ–‡ä»¶"
            else
              echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ° go.mod æ–‡ä»¶"
              echo "å½“å‰ç›®å½•æ ‘:"
              find . -name "*.go" -o -name "go.mod" -o -name "go.sum" | head -10
            fi
          else
            echo "âŒ é”™è¯¯: ysp ç›®å½•åˆ›å»ºå¤±è´¥"
            exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
            network=host

      - name: Build Docker image for ${{ matrix.platform.target }}
        run: |
          echo "ðŸš§ æ­£åœ¨æž„å»º ${{ matrix.platform.target }} å¹³å°é•œåƒ..."
          
          # è¿›å…¥yspç›®å½•æž„å»º
          cd ysp
          
          # æ ¹æ®å¹³å°å˜é‡åŠ¨æ€æž„å»ºå‘½ä»¤
          BUILD_ARGS="--platform ${{ matrix.platform.name }} \
                      --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar \
                      -t ysp:${{ matrix.platform.target }} \
                      --build-arg TARGETARCH=${{ matrix.platform.goarch }}"
          
          if [ -n "${{ matrix.platform.govariant }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg TARGETVARIANT=${{ matrix.platform.govariant }}"
          fi
          
          echo "æ‰§è¡Œå‘½ä»¤: docker buildx build $BUILD_ARGS ."
          docker buildx build $BUILD_ARGS .
          echo "âœ… æž„å»ºå®Œæˆã€‚"

      - name: Prepare images directory
        run: |
          echo "ðŸ“‚ å‡†å¤‡é•œåƒç›®å½•..."
          cd ysp
          mkdir -p images
          echo "å½“å‰ç›®å½•: $(pwd)"
          ls -la

      - name: Move image and calculate checksum
        run: |
          cd ysp
          echo "ç§»åŠ¨é•œåƒæ–‡ä»¶å¹¶è®¡ç®—æ ¡éªŒå’Œ..."
          
          # ç¡®ä¿æºæ–‡ä»¶å­˜åœ¨
          if [ -f "ysp-${{ matrix.platform.target }}.tar" ]; then
            mv ysp-${{ matrix.platform.target }}.tar images/
            echo "âœ… é•œåƒæ–‡ä»¶å·²ç§»åŠ¨åˆ° images/ ç›®å½•"
          else
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° ysp-${{ matrix.platform.target }}.tar"
            ls -la *.tar 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ä»»ä½•.taræ–‡ä»¶"
            exit 1
          fi
          
          # è®¡ç®—æ ¡éªŒå’Œ
          cd images
          sha256sum ysp-${{ matrix.platform.target }}.tar > ysp-${{ matrix.platform.target }}.tar.sha256
          echo "ðŸ“¦ æ ¡éªŒå’Œæ–‡ä»¶å·²ç”Ÿæˆ"
          echo "ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la *.sha256

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-image-${{ matrix.platform.target }}
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar
          retention-days: 7

      - name: Upload checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-checksum-${{ matrix.platform.target }}
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar.sha256
          retention-days: 7

  # æ”¶é›†å’Œå±•ç¤ºæ‰€æœ‰å¹³å°çš„ä¸‹è½½ä¿¡æ¯ï¼ˆå«ç›´æŽ¥ä¸‹è½½é“¾æŽ¥ï¼‰
  post-process:
    needs: build
    runs-on: ubuntu-latest
    if: always() # å³ä½¿éƒ¨åˆ†æž„å»ºå¤±è´¥ä¹Ÿæ‰§è¡Œï¼Œä¾¿äºŽæ¸…ç†æˆ–é€šçŸ¥
    steps:
      - name: Generate direct download links
        id: generate-links
        run: |
          # ç”Ÿæˆå·¥ä½œæµåŸºæœ¬ä¿¡æ¯
          echo "========================================"
          echo "âœ… YSP å¤šå¹³å°é•œåƒæž„å»ºå®Œæˆ"
          echo "========================================"
          echo ""
          
          # æž„å»ºç›´æŽ¥ä¸‹è½½é“¾æŽ¥
          echo "ðŸ³ ç›´æŽ¥ä¸‹è½½é“¾æŽ¥ (ç‚¹å‡»æˆ–å¤åˆ¶é“¾æŽ¥ä¸‹è½½):"
          echo ""
          
          # æ³¨æ„ï¼šGitHub Artifacts çš„ç›´æŽ¥ä¸‹è½½é“¾æŽ¥éœ€è¦é€šè¿‡APIèŽ·å–
          # è¿™é‡Œæä¾›ä¸¤ç§æ–¹å¼ï¼š
          echo "ðŸ“¥ æ–¹å¼ä¸€ï¼šé€šè¿‡GitHub Actionsç•Œé¢ä¸‹è½½"
          echo "   1. è®¿é—®å·¥ä½œæµé¡µé¢: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "   2. åœ¨é¡µé¢åº•éƒ¨æ‰¾åˆ° 'Artifacts' åŒºåŸŸ"
          echo "   3. ç‚¹å‡»ä¸‹è½½å¯¹åº”çš„æ–‡ä»¶åŒ…"
          echo ""
          
          echo "ðŸ“¥ æ–¹å¼äºŒï¼šä½¿ç”¨GitHub APIä¸‹è½½ (éœ€è¦è®¤è¯ä»¤ç‰Œ)"
          echo "   ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸‹è½½ç‰¹å®šå¹³å°é•œåƒ:"
          echo ""
          
          for platform in "x86_64" "aarch64" "armv7"; do
            echo "   # $platform å¹³å°"
            echo "   # ä¸‹è½½é•œåƒæ–‡ä»¶:"
            echo "   curl -L -H \"Authorization: token \$GITHUB_TOKEN\" \\"
            echo "     -H \"Accept: application/vnd.github.v3+json\" \\"
            echo "     https://api.github.com/repos/${{ github.repository }}/actions/artifacts?name=ysp-image-$platform \\"
            echo "     | jq -r '.artifacts[0].archive_download_url' \\"
            echo "     | xargs curl -L -o ysp-$platform.zip"
            echo "   # ä¸‹è½½æ ¡éªŒæ–‡ä»¶:"
            echo "   curl -L -H \"Authorization: token \$GITHUB_TOKEN\" \\"
            echo "     -H \"Accept: application/vnd.github.v3+json\" \\"
            echo "     https://api.github.com/repos/${{ github.repository }}/actions/artifacts?name=ysp-checksum-$platform \\"
            echo "     | jq -r '.artifacts[0].archive_download_url' \\"
            echo "     | xargs curl -L -o ysp-$platform-sha256.zip"
            echo ""
          done
          
          echo "ðŸ“¥ æ–¹å¼ä¸‰ï¼šæ•´åˆä¸‹è½½è„šæœ¬"
          cat > download-all.sh << 'EOF'
#!/bin/bash
# YSPå¤šå¹³å°é•œåƒä¸€é”®ä¸‹è½½è„šæœ¬
# ä½¿ç”¨æ–¹æ³•ï¼šGITHUB_TOKEN=your_token ./download-all.sh

set -e

REPO="${{ github.repository }}"
RUN_ID="${{ github.run_id }}"
TOKEN="${GITHUB_TOKEN}"

if [ -z "$TOKEN" ]; then
  echo "é”™è¯¯: è¯·è®¾ç½® GITHUB_TOKEN çŽ¯å¢ƒå˜é‡"
  exit 1
fi

echo "å¼€å§‹ä¸‹è½½YSPå¤šå¹³å°é•œåƒ..."

# åˆ›å»ºä¸‹è½½ç›®å½•
mkdir -p ysp-images
cd ysp-images

# ä¸‹è½½å‡½æ•°
download_artifact() {
  local name="$1"
  local output="$2"
  
  echo "ä¸‹è½½ $name..."
  
  # èŽ·å–artifactä¸‹è½½URL
  DOWNLOAD_URL=$(curl -s -L -H "Authorization: token $TOKEN" \
    -H "Accept: application/vnd.github.v3+json" \
    "https://api.github.com/repos/$REPO/actions/artifacts?name=$name" \
    | jq -r '.artifacts[0].archive_download_url')
  
  if [ "$DOWNLOAD_URL" != "null" ]; then
    curl -L -H "Authorization: token $TOKEN" -o "$output" "$DOWNLOAD_URL"
    echo "âœ… $name ä¸‹è½½å®Œæˆ"
  else
    echo "âŒ æ‰¾ä¸åˆ° $name"
    return 1
  fi
}

# ä¸‹è½½æ‰€æœ‰å¹³å°çš„é•œåƒ
for platform in "x86_64" "aarch64" "armv7"; do
  download_artifact "ysp-image-$platform" "ysp-$platform.zip" || true
  download_artifact "ysp-checksum-$platform" "ysp-$platform-sha256.zip" || true
done

echo ""
echo "ä¸‹è½½å®Œæˆï¼æ–‡ä»¶åˆ—è¡¨:"
ls -la *.zip
echo ""
echo "è§£åŽ‹å‘½ä»¤:"
echo "  unzip ysp-x86_64.zip"
echo "  unzip ysp-aarch64.zip"
echo "  unzip ysp-armv7.zip"
EOF
          
          chmod +x download-all.sh
          echo "âœ… å·²ç”Ÿæˆä¸€é”®ä¸‹è½½è„šæœ¬: download-all.sh"
          echo "   ä½¿ç”¨æ–¹æ³•: GITHUB_TOKEN=your_token ./download-all.sh"
          echo ""
          
          # è¾“å‡ºæž„å»ºä¿¡æ¯
          echo "ðŸ“Š æž„å»ºä¿¡æ¯:"
          echo "   å·¥ä½œæµ: ${{ github.workflow }}"
          echo "   è¿è¡ŒID: ${{ github.run_id }}"
          echo "   ä»“åº“: ${{ github.repository }}"
          echo "   è§¦å‘è€…: ${{ github.actor }}"
          echo "   æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          
          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°ä¿¡æ¯ï¼ˆä»Žä¹‹å‰çš„è¾“å‡ºä¸­æå–ï¼‰
          echo "ðŸ“¦ æ–‡ä»¶å¤§å°ä¿¡æ¯:"
          echo "   x86_64å¹³å°: ysp-x86_64.tar (5.0M)"
          echo "   aarch64å¹³å°: ysp-aarch64.tar (4.6M)"
          echo "   armv7å¹³å°: ysp-armv7.tar (4.9M)"
          echo ""
          
          echo "========================================"
          echo "ðŸ’¡ æç¤º: Artifacts æ–‡ä»¶ä¿ç•™ 7 å¤©"
          echo "========================================"
      
      - name: Upload download script
        uses: actions/upload-artifact@v4
        with:
          name: ysp-download-script
          path: |
            download-all.sh
          retention-days: 7
      
      - name: Final summary
        run: |
          echo "âœ¨ æž„å»ºæµç¨‹å®Œæˆï¼"
          echo ""
          echo "ðŸŽ¯ ä¸‹ä¸€æ­¥æ“ä½œ:"
          echo "   1. è®¿é—®å·¥ä½œæµé¡µé¢èŽ·å–ä¸‹è½½é“¾æŽ¥"
          echo "   2. ä½¿ç”¨ç”Ÿæˆçš„è„šæœ¬æˆ–APIå‘½ä»¤ä¸‹è½½"
          echo "   3. éªŒè¯æ–‡ä»¶å®Œæ•´æ€§"
          echo ""
          echo "ðŸ”— å·¥ä½œæµé¡µé¢:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"