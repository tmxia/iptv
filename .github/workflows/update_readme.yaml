name: Real-time README Updater

on:
  push:
    paths:
      - "version.txt"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version.txt
        id: validate-version
        run: |
          if [ ! -f version.txt ]; then
            echo "::error::version.txt not found"
            exit 1
          fi
          
          if ! jq empty version.txt 2>/dev/null; then
            echo "::error::Invalid JSON in version.txt"
            exit 1
          fi
          
          if [ $(jq -e 'length == 0' version.txt) = "true" ]; then
            echo "::warning::Empty version.txt, skipping update"
            echo "skip_update=true" >> $GITHUB_OUTPUT
          else
            echo "skip_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare README structure
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # ä¸¥æ ¼æ ¡éªŒå¹¶ç”Ÿæˆæ ‡è®°ï¼ˆç¡®ä¿ä¸ sed æ­£åˆ™å®Œå…¨ä¸€è‡´ï¼‰
          START_MARKER="<!-- VERSION_TABLE_START -->"
          END_MARKER="<!-- VERSION_TABLE_END -->"
          
          if [ ! -f README.md ]; then
            echo "# åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨" > README.md
            echo "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |" >> README.md
            echo "|----------|--------|----------|" >> README.md
            echo "$START_MARKER" >> README.md  # ç¡®ä¿æ ‡è®°åç§°æ­£ç¡®
            echo "$END_MARKER" >> README.md    # ç¡®ä¿æ ‡è®°åç§°æ­£ç¡®
          else
            # æ£€æŸ¥å¹¶è¡¥å……ç¼ºå¤±çš„æ ‡è®°ï¼ˆé¿å…æ ‡è®°æ‹¼å†™é”™è¯¯ï¼‰
            if ! grep -q "$START_MARKER" README.md; then
              echo "$START_MARKER" >> README.md
            fi
            if ! grep -q "$END_MARKER" README.md; then
              echo "$END_MARKER" >> README.md
            fi
          fi

      - name: Generate and update version table
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/apk/"
          
          # ç”Ÿæˆè¡¨æ ¼å†…å®¹ï¼ˆjq è¡¨è¾¾å¼ç”¨å•å¼•å·ï¼Œç¡®ä¿ URL æ‹¼æ¥æ­£ç¡®ï¼‰
          table_content=$(jq -r --arg base_url "$BASE_URL" '
            to_entries | 
            sort_by(.value | split(",")[1] | strptime("%Y-%m-%d") | mktime) | reverse | 
            .[] | 
            "| [\(.key)](\($base_url + (.key | @uri))) | \(.value | split(",")[0]) | \(.value | split(",")[1]) |"
          ' version.txt)
          
          # **æ·±åº¦è½¬ä¹‰ï¼šåŒ…æ‹¬æ‰€æœ‰å¯èƒ½ç ´å sed ç»“æ„çš„å­—ç¬¦ï¼ˆæ¢è¡Œã€å•/åŒå¼•å·ã€|ã€&ã€/ï¼‰**
          escaped_table_content=$(echo "$table_content" | sed 's/[&/|"\'\'\n]/\\&/g')
          
          # è°ƒè¯•ï¼šæ‰“å° sed å‘½ä»¤å’Œè½¬ä¹‰åçš„å†…å®¹ï¼ˆå…³é”®æ’æŸ¥æ­¥éª¤ï¼‰
          echo "-------------------------"
          echo "sed æ¸…é™¤æ—§å†…å®¹çš„å‘½ä»¤ï¼š"
          echo "sed -i \"/$START_MARKER/,/$END_MARKER/{ /$START_MARKER/!d; /$END_MARKER/!d }\" README.md"
          echo "-------------------------"
          echo "è½¬ä¹‰åçš„è¡¨æ ¼å†…å®¹ï¼ˆé€è¡Œæ˜¾ç¤ºï¼‰ï¼š"
          echo "$escaped_table_content" | tr '\n' '#'  # ç”¨ # æ›¿æ¢æ¢è¡Œç¬¦ï¼Œä¾¿äºæŸ¥çœ‹
          echo "-------------------------"
          
          # æ¸…é™¤æ—§è¡¨æ ¼å†…å®¹ï¼ˆä¸¥æ ¼åŒ¹é…æ ‡è®°ï¼ŒåŒå¼•å·åŒ…è£¹é¿å…æ­£åˆ™è§£æé”™è¯¯ï¼‰
          sed -i "/$START_MARKER/,/$END_MARKER/{
            /$START_MARKER/!d;
            /$END_MARKER/!d
          }" README.md
          
          # æ’å…¥å†…å®¹ï¼ˆåŒå¼•å·ç¡®ä¿å˜é‡æ­£ç¡®è§£æï¼Œæ— å¼•å·åµŒå¥—é—®é¢˜ï¼‰
          sed -i "/$START_MARKER/a $escaped_table_content" README.md
          
          echo "âœ… è¡¨æ ¼æ›´æ–°å®Œæˆï¼Œå…±ç”Ÿæˆ $(echo "$table_content" | wc -l) è¡Œ"

      - name: Commit and push changes
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git pull origin ${{ github.ref_name }} --rebase
          
          if git diff --quiet README.md; then
            echo "No changes to README.md"
          else
            git add README.md
            git commit -m "ğŸ“š è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬è¡¨æ ¼ [skip ci]"
            git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
          fi

      - name: Verify table update
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          expected_lines=$(jq 'length' version.txt)
          actual_lines=$(grep -c '| \[.*\]' README.md)
          
          if [ "$expected_lines" -eq "$actual_lines" ]; then
            echo "âœ… READMEæ›´æ–°æˆåŠŸï¼è¡¨æ ¼è¡Œæ•°åŒ¹é…ï¼š$actual_lines"
          else
            echo "::error::è¡¨æ ¼è¡Œæ•°ä¸åŒ¹é…ï¼ˆé¢„æœŸï¼š$expected_linesï¼Œå®é™…ï¼š$actual_linesï¼‰"
            exit 1
          fi

  cleanup_self:
    name: Cleanup Workflow History
    runs-on: ubuntu-latest
    needs: [update-readme]
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 2
          retain_days: 7
          delete_workflow_pattern: "Real-time README Updater"
          repository: ${{ github.repository }}
