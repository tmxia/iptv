name: Real-time README Updater

on:
  push:
    paths:
      - 'version.txt'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version.txt
        id: validate-version
        run: |
          if [ ! -f version.txt ]; then
            echo "::error::version.txt not found"
            exit 1
          fi
          
          if ! jq empty version.txt 2>/dev/null; then
            echo "::error::Invalid JSON in version.txt"
            exit 1
          fi
          
          if [ $(jq -e 'length == 0' version.txt) = "true" ]; then
            echo "::warning::Empty version.txt"
            echo "skip_update=true" >> $GITHUB_OUTPUT
          else
            echo "skip_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare README
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # åˆ›å»ºæˆ–ä¿®å¤READMEç»“æ„
          if [ ! -f README.md ]; then
            echo "# åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨" > README.md
            echo "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |" >> README.md
            echo "|----------|--------|----------|" >> README.md
            echo "<!-- VERSION_TABLE -->" >> README.md
          fi
          
          # ç¡®ä¿è¡¨æ ¼ç»“æ„å­˜åœ¨
          if ! grep -q "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |" README.md; then
            sed -i '1i <!-- VERSION_TABLE -->' README.md
            sed -i '1i |----------|--------|----------|' README.md
            sed -i '1i | æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |' README.md
          fi
          
          # ç¡®ä¿æ ‡è®°å­˜åœ¨
          if ! grep -q "<!-- VERSION_TABLE -->" README.md; then
            echo "<!-- VERSION_TABLE -->" >> README.md
          fi

      - name: Generate and update table
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # è®¾ç½®åŸºç¡€URL
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/apk/"
          
          # ä»…ç”Ÿæˆæ•°æ®è¡Œï¼ˆä¸åŒ…æ‹¬è¡¨å¤´ï¼‰
          table_content=$(jq -r --arg base_url "$BASE_URL" '
            to_entries | sort_by(.value | split(",")[1]) | reverse | .[] |
            "| [\(.key)](\($base_url + (.key | @uri))) | \(.value | split(",")[0]) | \(.value | split(",")[1]) |"
          ' version.txt)
          
          # æ›¿æ¢æ ‡è®°ä¹‹é—´çš„å†…å®¹
          sed -i '/<!-- VERSION_TABLE -->/{
            n   # ç§»åŠ¨åˆ°æ ‡è®°çš„ä¸‹ä¸€è¡Œ
            :a
            n   # è¯»å–ä¸‹ä¸€è¡Œ
            /<!-- VERSION_TABLE -->/!ba   # å¦‚æœä¸æ˜¯ç»“æŸæ ‡è®°åˆ™å¾ªç¯
            d   # åˆ é™¤ç»“æŸæ ‡è®°å‰çš„æ‰€æœ‰è¡Œ
          }' README.md
          
          # æ’å…¥æ–°å†…å®¹å’Œç»“æŸæ ‡è®°
          sed -i '/<!-- VERSION_TABLE -->/a \\n'"$table_content" README.md
          sed -i '/<!-- VERSION_TABLE -->/a <!-- VERSION_TABLE -->' README.md
          
          echo "Updated README.md"

      - name: æäº¤æ›´æ”¹
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git pull origin ${{ github.ref_name }}
          git add README.md
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“š è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬è¡¨æ ¼ [skip ci]"
            git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
          fi

      - name: Verify update
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # éªŒè¯è¡¨æ ¼è¡Œæ•°æ˜¯å¦åŒ¹é…
          expected_lines=$(jq 'length' version.txt)
          actual_lines=$(grep -c '| \[.*\]' README.md)
          
          if [ "$expected_lines" -eq "$actual_lines" ]; then
            echo "READMEæ›´æ–°æˆåŠŸ! è¡¨æ ¼è¡Œæ•°: $actual_lines"
          else
            echo "::error::è¡¨æ ¼è¡Œæ•°ä¸åŒ¹é… (é¢„æœŸ: $expected_lines, å®é™…: $actual_lines)"
            exit 1
          fi

  cleanup_self:
    name: Cleanup Workflow History
    runs-on: ubuntu-latest
    needs: [update-readme]
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 2
          retain_days: 1
          delete_workflow_pattern: "Real-time README Updater"
          repository: ${{ github.repository }}