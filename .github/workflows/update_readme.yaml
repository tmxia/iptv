name: Real-time README Updater

on:
  push:
    paths:
      - 'version.txt'
  workflow_run:
    workflows: ["NagramX Sync from Source Repository", "BV APK Sync from Source Repository", "GitHub XAPK Download and Sync", "Karing Beta Sync from Source Repository", "MYTV APK Sync from Source Repository", "OK PRO APK Sync from TELEGRAM", "OK APK Sync from Source Repository", "Proxypin Sync from Source Repository", "Simple_live APK Sync from Source Repository", "ServerBox Sync from Source Repository"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ä½¿ç”¨ PAT ä»¤ç‰Œæ›¿ä»£é»˜è®¤ä»¤ç‰Œ
          token: ${{ secrets.REPO_PAT }}  # éœ€è¦åˆ›å»ºä¸ªäººè®¿é—®ä»¤ç‰Œ

      - name: è·å–æœ€æ–°å˜æ›´
        run: git pull origin ${{ github.ref_name }}

      - name: Validate version.txt
        id: validate-version
        run: |
          if [ ! -f version.txt ]; then
            echo "::error::version.txt not found"
            exit 1
          fi
          
          if ! jq empty version.txt 2>/dev/null; then
            echo "::error::Invalid JSON in version.txt"
            exit 1
          fi
          
          if [ $(jq -e 'length == 0' version.txt) = "true" ]; then
            echo "::warning::Empty version.txt"
            echo "skip_update=true" >> $GITHUB_OUTPUT
          else
            echo "skip_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate new README
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # è®¾ç½®åŸºç¡€URL
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/apk/"
          
          # ç”Ÿæˆå…¨æ–°çš„READMEå†…å®¹
          {
            echo "# åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨"
            echo ""
            echo "æœ€åæ›´æ–°: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
            echo "|----------|--------|----------|"
            
            # æŒ‰æ›´æ–°æ—¥æœŸé™åºæ’åˆ—
            jq -r --arg base_url "$BASE_URL" '
              to_entries | sort_by(.value | split(",")[1]) | reverse | .[] |
              "| [\(.key)](\($base_url + (.key | @uri))) | \(.value | split(",")[0]) | \(.value | split(",")[1]) |"
            ' version.txt
          } > README.md
          
          echo "Generated new README.md"

      - name: æäº¤æ›´æ”¹
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add README.md
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            # ä½¿ç”¨ [skip actions] é¿å…è§¦å‘å…¶ä»–å·¥ä½œæµ
            git commit -m "ğŸ“š è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬è¡¨æ ¼ [skip actions]"
            # ä½¿ç”¨ PAT ä»¤ç‰Œæ¨é€
            git push "https://${{ github.actor }}:${{ secrets.REPO_PAT }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
          fi

      - name: Simple verification
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # ç®€å•éªŒè¯READMEæ˜¯å¦åŒ…å«å…³é”®å†…å®¹
          if grep -q "åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨" README.md && \
             grep -q "æœ€åæ›´æ–°" README.md; then
            echo "âœ… READMEæ›´æ–°æˆåŠŸ"
          else
            echo "::error::READMEæ›´æ–°å¤±è´¥"
            cat README.md
            exit 1
          fi

  cleanup_self:
    name: Cleanup Workflow History
    runs-on: ubuntu-latest
    needs: [update-readme]
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 2
          retain_days: 1
          delete_workflow_pattern: "Real-time README Updater"
          repository: ${{ github.repository }}