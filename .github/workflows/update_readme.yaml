name: Real-time README Updater

on:
  push:
    paths:
      - 'version.txt'
      - 'apk/**'
      - 'kernel_versions.json'
      - 'kernels/**'
  workflow_run:
    workflows: ["NagramX Sync from Source Repository", "BV APK Sync from Source Repository", "GitHub XAPK Download and Sync", "Karing Beta Sync from Source Repository", "MYTV APK Sync from Source Repository", "OK PRO APK Sync from TELEGRAM", "OK APK Sync from Source Repository", "Proxypin Sync from Source Repository", "Simple_live APK Sync from Source Repository", "OpenWrt Kernel Sync from TELEGRAM", "ServerBox Sync from Source Repository", "TV APK Sync from TELEGRAM", "TV NEW APK Sync from TELEGRAM", "Hiddify APK Sync from Source Repository", "Termux APK Sync from Source Repository", "Passwall Packages Sync from Source Repository", "OpenWrt Kernel Sync from TELEGRAM", "Plus APK Download and Sync", "TAuxiliary APK Sync from TELEGRAM"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_PAT }}

      - name: è·å–æœ€æ–°å˜æ›´
        run: git pull origin ${{ github.ref_name }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc jq curl

      - name: Validate version files
        id: validate-versions
        run: |
          # æ£€æŸ¥APKç‰ˆæœ¬æ–‡ä»¶
          if [ ! -f version.txt ]; then
            echo "::warning::version.txt not found"
          else
            if ! jq empty version.txt 2>/dev/null; then
              echo "::error::Invalid JSON in version.txt"
              exit 1
            fi
          fi
          
          # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
          if [ ! -f kernel_versions.json ]; then
            echo "::warning::kernel_versions.json not found"
          else
            if ! jq empty kernel_versions.json 2>/dev/null; then
              echo "::error::Invalid JSON in kernel_versions.json"
              exit 1
            fi
          fi
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°APKéƒ¨åˆ†
          if [ -f version.txt ] && [ $(jq -e 'length > 0' version.txt) = "true" ]; then
            echo "update_apk=true" >> $GITHUB_OUTPUT
          else
            echo "update_apk=false" >> $GITHUB_OUTPUT
          fi
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°å†…æ ¸éƒ¨åˆ†
          if [ -f kernel_versions.json ] && [ $(jq -e 'length > 0' kernel_versions.json) = "true" ]; then
            echo "update_kernel=true" >> $GITHUB_OUTPUT
          else
            echo "update_kernel=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate new README
        id: generate-readme
        run: |
          # è®¾ç½®åŸºç¡€URL
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          APK_BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/apk/"
          KERNEL_BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/kernels/"
          
          # åˆå§‹åŒ–READMEå†…å®¹
          {
            echo "# åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨"
            echo ""
            echo "æœ€åæ›´æ–°: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)"
            echo ""
            
            # ç”Ÿæˆåº”ç”¨è¡¨æ ¼
            if ${{ steps.validate-versions.outputs.update_apk }} == 'true'; then
              echo "## åº”ç”¨"
              echo ""
              echo "| æ–‡ä»¶åç§° | æ–‡ä»¶å¤§å°(M) | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
              echo "|----------|------------|--------|----------|"
              
              # æŒ‰æ›´æ–°æ—¥æœŸé™åºæ’åˆ—
              jq -r 'to_entries | sort_by(.value | split(",")[1]) | reverse | .[] | .key' version.txt | while read -r key; do
                # è·å–ç‰ˆæœ¬ä¿¡æ¯
                value=$(jq -r ".\"$key\"" version.txt)
                version=$(echo "$value" | cut -d, -f1)
                date=$(echo "$value" | cut -d, -f2)
                
                # è·å–æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰
                file_path="apk/$key"
                if [ -f "$file_path" ]; then
                  file_bytes=$(stat -c%s "$file_path")
                  file_size=$(echo "scale=2; $file_bytes / (1024*1024)" | bc)
                else
                  file_size="N/A"
                fi
                
                # ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤ºæ–‡ä»¶åï¼Œä¸‹æ–¹æ·»åŠ ä¸‹è½½é“¾æ¥
                echo "| <div>$key</div><div><small>[ä¸‹è½½](${APK_BASE_URL}${key})</small></div> | $file_size | $version | $date |"
              done
            else
              echo "> æš‚æ— åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯"
            fi
            
            # æ·»åŠ å†…æ ¸éƒ¨åˆ†
            echo ""
            echo "---"
            echo ""
            echo "# OpenWrtå†…æ ¸åˆ—è¡¨"
            echo ""
            
            if ${{ steps.validate-versions.outputs.update_kernel }} == 'true'; then
              echo "## å†…æ ¸"
              echo ""
              echo "| å†…æ ¸åç§° | æ–‡ä»¶å¤§å°(M) | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
              echo "|----------|------------|--------|----------|"
              
              # å¤„ç†å†…æ ¸ç‰ˆæœ¬ - æŒ‰æ›´æ–°æ—¥æœŸé™åºæ’åˆ—
              jq -r 'to_entries | sort_by(.value.date) | reverse | .[] | .key' kernel_versions.json | while read -r kernel_key; do
                # è·å–ç‰ˆæœ¬ä¿¡æ¯
                version=$(jq -r ".\"$kernel_key\".version" kernel_versions.json)
                date=$(jq -r ".\"$kernel_key\".date" kernel_versions.json)
                
                # æ„å»ºå®é™…æ–‡ä»¶å
                file_name="${kernel_key}_${version}.zip"
                
                # è·å–æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰
                file_path="kernels/$file_name"
                if [ -f "$file_path" ]; then
                  file_bytes=$(stat -c%s "$file_path")
                  file_size=$(echo "scale=2; $file_bytes / (1024*1024)" | bc)
                else
                  file_size="N/A"
                fi
                
                # ç¾åŒ–å†…æ ¸åç§°
                kernel_name=$(echo "$kernel_key" | sed 's/openwrt_flippy//; s/6\.1/6.1/; s/6\.6/6.6/; s/6\.12/6.12/')
                kernel_name="OpenWrt $kernel_name"
                
                # ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤ºæ–‡ä»¶åï¼Œä¸‹æ–¹æ·»åŠ ä¸‹è½½é“¾æ¥
                echo "| <div>$kernel_name</div><div><small>[ä¸‹è½½](${KERNEL_BASE_URL}${file_name})</small></div> | $file_size | $version | $date |"
              done
            else
              echo "> æš‚æ— å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯"
            fi
            
          } > README.md
          
          echo "Generated new README.md with APK and Kernel tables (sorted by date)"

      - name: æ£€æµ‹å¹¶ä¿®å¤æ— æ•ˆæ–‡ä»¶å¤§å°
        if: always() && steps.generate-readme.conclusion == 'success'
        run: |
          # æ£€æµ‹æ— æ•ˆæ–‡ä»¶å¤§å°å€¼
          if grep -qE '\| (0\.00|N/A|0|0\.0|0\.) \|' README.md; then
            echo "æ£€æµ‹åˆ°æ— æ•ˆçš„æ–‡ä»¶å¤§å°å€¼ï¼Œå°è¯•ä¿®å¤..."
            
            # è®¾ç½®åŸºç¡€URL
            REPO="${{ github.repository }}"
            BRANCH="${{ github.ref_name }}"
            API_BASE="https://api.github.com/repos/${REPO}/contents/"
            TOKEN="${{ secrets.REPO_PAT }}"
            
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            TEMP_FILE=$(mktemp)
            
            # è·å–æ‰€æœ‰APKæ–‡ä»¶åˆ—è¡¨
            apk_files=$(find apk -type f -name "*.apk" -exec basename {} \;)
            
            # åˆ›å»ºæ–‡ä»¶å¤§å°æ˜ å°„
            declare -A file_sizes
            for file in $apk_files; do
              # è·å–æ–‡ä»¶å…ƒæ•°æ®
              api_url="${API_BASE}apk/${file}?ref=${BRANCH}"
              api_response=$(curl -s -H "Authorization: token $TOKEN" -H "Accept: application/vnd.github.v3+json" "$api_url")
              
              if size=$(echo "$api_response" | jq -r '.size'); then
                if [ "$size" != "null" ]; then
                  # è®¡ç®—MBå¤§å°
                  file_mb=$(echo "scale=2; $size / (1024*1024)" | bc)
                  file_sizes["$file"]=$file_mb
                  echo "æ–‡ä»¶å¤§å°: $file â†’ $file_mb MB"
                fi
              fi
            done
            
            # å¤„ç†READMEæ¯ä¸€è¡Œ
            while IFS= read -r line; do
              # æ£€æŸ¥æ˜¯å¦åŒ…å«æ— æ•ˆå¤§å°å€¼
              if [[ "$line" =~ \|.*\|(0\.00|N/A|0|0\.0|0\.)\|.*\| ]]; then
                # æå–æ–‡ä»¶å
                if [[ "$line" =~ \<div\>([^<]+)\<\/div\> ]]; then
                  file_name="${BASH_REMATCH[1]}"
                  
                  # æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„å¤§å°å€¼
                  if [ -n "${file_sizes[$file_name]}" ]; then
                    # æ›¿æ¢è¡Œä¸­çš„å¤§å°å€¼
                    new_line=$(echo "$line" | sed -E "s/\| (0\.00|N/A|0|0\.0|0\.) \|/| ${file_sizes[$file_name]} |/")
                    echo "ä¿®å¤: $file_name â†’ ${file_sizes[$file_name]} MB"
                    echo "$new_line" >> "$TEMP_FILE"
                    continue
                  fi
                fi
              fi
              
              # ä¿ç•™åŸå§‹è¡Œ
              echo "$line" >> "$TEMP_FILE"
            done < README.md
            
            # æ›¿æ¢åŸå§‹æ–‡ä»¶
            mv "$TEMP_FILE" README.md
            echo "å·²ä¿®å¤æ— æ•ˆçš„æ–‡ä»¶å¤§å°å€¼"
          else
            echo "æœªæ£€æµ‹åˆ°æ— æ•ˆçš„æ–‡ä»¶å¤§å°å€¼"
          fi

      - name: æäº¤æ›´æ”¹
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add README.md
          
          # ä½¿ç”¨ [skip actions] é¿å…è§¦å‘å…¶ä»–å·¥ä½œæµ
          git commit -m "ğŸ“š è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬è¡¨æ ¼ [skip actions]"
          
          # ä½¿ç”¨ PAT ä»¤ç‰Œæ¨é€
          git push "https://${{ github.actor }}:${{ secrets.REPO_PAT }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}

      - name: éªŒè¯ç»“æœ
        run: |
          # ç®€å•éªŒè¯READMEæ˜¯å¦åŒ…å«å…³é”®å†…å®¹
          if grep -q "åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨" README.md && \
             grep -q "OpenWrtå†…æ ¸åˆ—è¡¨" README.md; then
            echo "âœ… READMEæ›´æ–°æˆåŠŸ"
          else
            echo "::error::READMEæ›´æ–°å¤±è´¥"
            cat README.md
            exit 1
          fi
          
          # éªŒè¯æ˜¯å¦è¿˜æœ‰æ— æ•ˆæ–‡ä»¶å¤§å°
          if grep -qE '\| (0\.00|N/A|0|0\.0|0\.) \|' README.md; then
            echo "::warning::æ£€æµ‹åˆ°æœªä¿®å¤çš„æ— æ•ˆæ–‡ä»¶å¤§å°å€¼"
            grep -E '\| (0\.00|N/A|0|0\.0|0\.) \|' README.md
          fi

  cleanup_self:
    name: Cleanup Workflow History
    runs-on: ubuntu-latest
    needs: [update-readme]
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "Real-time README Updater"
          repository: ${{ github.repository }}