name: Real-time README Updater

on:
  push:
    paths:
      - 'apk/**'
      - 'kernels/**'
      - 'version.txt'
      - 'kernel_versions.json'
    branches: [ main ]
  workflow_run:
    workflows: ${{ fromJSON(needs.setup.outputs.all_workflows_excluded) }}
    types: [completed]
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      all_workflows_excluded: ${{ steps.exclude.outputs.workflow_list }}
    steps:
      - name: è·å–æ‰€æœ‰å·¥ä½œæµ
        id: get-workflows
        uses: actions/github-script@v6
        with:
          script: |
            const workflows = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const names = workflows.data.workflow_runs.map(w => w.name);
            const uniqueNames = [...new Set(names)];
            return uniqueNames.filter(name => name !== 'Real-time Directory Monitor');

      - name: æ’é™¤æŒ‡å®šå·¥ä½œæµ
        id: exclude
        run: |
          # åœ¨æ­¤æ·»åŠ è¦æ’é™¤çš„å·¥ä½œæµåç§°
          EXCLUDE=(
            "Cleanup All Workflow Runs"
            "Trigger All Workflows"
            "Real-time Directory Monitor"
          )
          
          # è½¬æ¢ä¸ºJSONæ•°ç»„
          ALL_WORKFLOWS=${{ steps.get-workflows.outputs.result }}
          FILTERED=$(echo "$ALL_WORKFLOWS" | jq --argjson exclude "$(printf '%s\n' "${EXCLUDE[@]}" | jq -R . | jq -s .)" 'map(select(. as $w | $exclude | index($w) | not)')
          
          # è¾“å‡ºå¤„ç†åçš„åˆ—è¡¨
          echo "workflow_list=$FILTERED" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  detect-and-notify:
    runs-on: ubuntu-latest
    needs: [setup]
    timeout-minutes: 5
    concurrency: 
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_PAT }}

      - name: è·å–æœ€æ–°å˜æ›´
        run: git pull origin ${{ github.ref_name }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc jq

      - name: Validate version files
        id: validate-versions
        run: |
          # æ£€æŸ¥APKç‰ˆæœ¬æ–‡ä»¶
          if [ ! -f version.txt ]; then
            echo "::warning::version.txt not found"
          else
            if ! jq empty version.txt 2>/dev/null; then
              echo "::error::Invalid JSON in version.txt"
              exit 1
            fi
          fi
          
          # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
          if [ ! -f kernel_versions.json ]; then
            echo "::warning::kernel_versions.json not found"
          else
            if ! jq empty kernel_versions.json 2>/dev/null; then
              echo "::error::Invalid JSON in kernel_versions.json"
              exit 1
            fi
          fi
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°APKéƒ¨åˆ†
          if [ -f version.txt ] && [ $(jq -e 'length > 0' version.txt) = "true" ]; then
            echo "update_apk=true" >> $GITHUB_OUTPUT
          else
            echo "update_apk=false" >> $GITHUB_OUTPUT
          fi
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°å†…æ ¸éƒ¨åˆ†
          if [ -f kernel_versions.json ] && [ $(jq -e 'length > 0' kernel_versions.json) = "true" ]; then
            echo "update_kernel=true" >> $GITHUB_OUTPUT
          else
            echo "update_kernel=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate new README
        run: |
          # è®¾ç½®åŸºç¡€URL
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          APK_BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/apk/"
          KERNEL_BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/kernels/"
          
          # åˆå§‹åŒ–READMEå†…å®¹
          {
            echo "# åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨"
            echo ""
            echo "æœ€åæ›´æ–°: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)"
            echo ""
            
            # ç”Ÿæˆåº”ç”¨è¡¨æ ¼
            if ${{ steps.validate-versions.outputs.update_apk }} == 'true'; then
              echo "## åº”ç”¨"
              echo ""
              echo "| æ–‡ä»¶åç§° | æ–‡ä»¶å¤§å°(M) | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
              echo "|----------|------------|--------|----------|"
              
              # æŒ‰æ›´æ–°æ—¥æœŸé™åºæ’åˆ—
              jq -r 'to_entries | sort_by(.value | split(",")[1]) | reverse | .[] | .key' version.txt | while read -r key; do
                # è·å–ç‰ˆæœ¬ä¿¡æ¯
                value=$(jq -r ".\"$key\"" version.txt)
                version=$(echo "$value" | cut -d, -f1)
                date=$(echo "$value" | cut -d, -f2)
                
                # è·å–æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰
                file_path="apk/$key"
                if [ -f "$file_path" ]; then
                  file_bytes=$(stat -c%s "$file_path")
                  file_size=$(echo "scale=2; $file_bytes / (1024*1024)" | bc)
                else
                  file_size="N/A"
                fi
                
                # ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤ºæ–‡ä»¶åï¼Œä¸‹æ–¹æ·»åŠ ä¸‹è½½é“¾æ¥
                echo "| <div>$key</div><div><small>[ä¸‹è½½](${APK_BASE_URL}${key})</small></div> | $file_size | $version | $date |"
              done
            else
              echo "> æš‚æ— åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯"
            fi
            
            # æ·»åŠ å†…æ ¸éƒ¨åˆ†
            echo ""
            echo "---"
            echo ""
            echo "# OpenWrtå†…æ ¸åˆ—è¡¨"
            echo ""
            
            if ${{ steps.validate-versions.outputs.update_kernel }} == 'true'; then
              echo "## å†…æ ¸"
              echo ""
              echo "| å†…æ ¸åç§° | æ–‡ä»¶å¤§å°(M) | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
              echo "|----------|------------|--------|----------|"
              
              # å¤„ç†å†…æ ¸ç‰ˆæœ¬ - æŒ‰æ›´æ–°æ—¥æœŸé™åºæ’åˆ—
              jq -r 'to_entries | sort_by(.value.date) | reverse | .[] | .key' kernel_versions.json | while read -r kernel_key; do
                # è·å–ç‰ˆæœ¬ä¿¡æ¯
                version=$(jq -r ".\"$kernel_key\".version" kernel_versions.json)
                date=$(jq -r ".\"$kernel_key\".date" kernel_versions.json)
                
                # æ„å»ºå®é™…æ–‡ä»¶å
                file_name="${kernel_key}_${version}.zip"
                
                # è·å–æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰
                file_path="kernels/$file_name"
                if [ -f "$file_path" ]; then
                  file_bytes=$(stat -c%s "$file_path")
                  file_size=$(echo "scale=2; $file_bytes / (1024*1024)" | bc)
                else
                  file_size="N/A"
                fi
                
                # ç¾åŒ–å†…æ ¸åç§°
                kernel_name=$(echo "$kernel_key" | sed 's/openwrt_flippy//; s/6\.1/6.1/; s/6\.6/6.6/; s/6\.12/6.12/')
                kernel_name="OpenWrt $kernel_name"
                
                # ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤ºæ–‡ä»¶åï¼Œä¸‹æ–¹æ·»åŠ ä¸‹è½½é“¾æ¥
                echo "| <div>$kernel_name</div><div><small>[ä¸‹è½½](${KERNEL_BASE_URL}${file_name})</small></div> | $file_size | $version | $date |"
              done
            else
              echo "> æš‚æ— å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯"
            fi
            
          } > README.md
          
          echo "Generated new README.md with APK and Kernel tables (sorted by date)"

      - name: æäº¤æ›´æ”¹
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add README.md
          
          # ä½¿ç”¨ [skip actions] é¿å…è§¦å‘å…¶ä»–å·¥ä½œæµ
          git commit -m "ğŸ“š è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬è¡¨æ ¼ [skip actions]"
          
          # ä½¿ç”¨ PAT ä»¤ç‰Œæ¨é€
          git push "https://${{ github.actor }}:${{ secrets.REPO_PAT }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}

      - name: Simple verification
        run: |
          # ç®€å•éªŒè¯READMEæ˜¯å¦åŒ…å«å…³é”®å†…å®¹
          if grep -q "åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨" README.md && \
             grep -q "OpenWrtå†…æ ¸åˆ—è¡¨" README.md; then
            echo "âœ… READMEæ›´æ–°æˆåŠŸ"
          else
            echo "::error::READMEæ›´æ–°å¤±è´¥"
            cat README.md
            exit 1
          fi

  cleanup_self:
    name: Cleanup Workflow History
    runs-on: ubuntu-latest
    needs: [update-readme]
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "Real-time README Updater"
          repository: ${{ github.repository }}