name: Real-time README Updater

on:
  push:
    paths:
      - 'version.txt'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with retry
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          retry-on-timeout: true
          max-retries: 3
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version.txt
        id: validate-version
        run: |
          if [ ! -f version.txt ]; then
            echo "::error::version.txt not found"
            exit 1
          fi
          
          if ! jq empty version.txt 2>/dev/null; then
            echo "::error::Invalid JSON in version.txt"
            exit 1
          fi
          
          if [ $(jq -e 'length == 0' version.txt) = "true" ]; then
            echo "::warning::Empty version.txt"
            echo "skip_update=true" >> $GITHUB_OUTPUT
          else
            echo "skip_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate README content
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # è®¾ç½®åŸºç¡€URL
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/apk/"
          
          # ç”Ÿæˆæ–°çš„READMEå†…å®¹
          {
            echo "# åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨"
            echo ""
            echo "æœ€åŽæ›´æ–°: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
            echo "|----------|--------|----------|"
            
            # æŒ‰æ›´æ–°æ—¥æœŸé™åºæŽ’åˆ—
            jq -r --arg base_url "$BASE_URL" '
              to_entries | sort_by(.value | split(",")[1]) | reverse | .[] |
              "| [\(.key)](\($base_url + (.key | @uri))) | \(.value | split(",")[0]) | \(.value | split(",")[1]) |"
            ' version.txt
          } > README_NEW.md
          
          echo "Generated new README content"

      - name: Apply new README
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # æ£€æŸ¥å†…å®¹æ˜¯å¦æœ‰æ•ˆ
          if [ $(grep -c '^\| \[' README_NEW.md) -ne $(jq 'length' version.txt) ]; then
            echo "::error::ç”Ÿæˆçš„å†…å®¹è¡Œæ•°ä¸åŒ¹é…"
            cat README_NEW.md
            exit 1
          fi
          
          # æ›¿æ¢çŽ°æœ‰README
          mv README_NEW.md README.md
          echo "Applied new README"

      - name: Commit changes with conflict resolution
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # é…ç½®Git
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          
          # é‡è¯•æœºåˆ¶å¤„ç†å¹¶å‘å†²çª
          for i in {1..3}; do
            echo "Attempt $i: Updating README..."
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin ${{ github.ref_name }} --rebase
            
            # æ£€æŸ¥version.txtæ˜¯å¦å˜åŒ–
            if git diff --name-only origin/${{ github.ref_name }} | grep -q version.txt; then
              echo "::warning::version.txt changed during update, regenerating README"
              
              # é‡æ–°ç”ŸæˆREADME
              "$GITHUB_WORKSPACE/${{ github.workflow }}/generate_readme.sh"
            fi
            
            # æ·»åŠ å¹¶æäº¤
            git add README.md
            
            if git diff --cached --quiet; then
              echo "No changes to commit"
              break
            fi
            
            # å°è¯•æäº¤
            if git commit -m "ðŸ“š è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬è¡¨æ ¼ [skip ci]" && \
               git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}; then
              echo "Update successful"
              break
            else
              echo "::warning::Push failed, retrying..."
              sleep $((RANDOM % 5 + 1)) # éšæœºç­‰å¾…å‡å°‘å†²çª
            fi
          done

      - name: Final verification
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # ç®€å•éªŒè¯READMEæ˜¯å¦åŒ…å«å…³é”®å†…å®¹
          if grep -q "åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨" README.md; then
            echo "âœ… READMEæ›´æ–°éªŒè¯é€šè¿‡"
          else
            echo "::error::READMEæ›´æ–°å¤±è´¥"
            exit 1
          fi

  cleanup_self:
    name: Cleanup Workflow History
    runs-on: ubuntu-latest
    needs: [update-readme]
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 2
          retain_days: 1
          delete_workflow_pattern: "Real-time README Updater"
          repository: ${{ github.repository }}

  # ç”ŸæˆREADMEçš„è¾…åŠ©è„šæœ¬
  generate_readme.sh: |
    #!/bin/bash
    REPO="${{ github.repository }}"
    BRANCH="${{ github.ref_name }}"
    BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/apk/"
    
    {
      echo "# åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨"
      echo ""
      echo "æœ€åŽæ›´æ–°: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      echo ""
      echo "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
      echo "|----------|--------|----------|"
      
      jq -r --arg base_url "$BASE_URL" '
        to_entries | sort_by(.value | split(",")[1]) | reverse | .[] |
        "| [\(.key)](\($base_url + (.key | @uri))) | \(.value | split(",")[0]) | \(.value | split(",")[1]) |"
      ' version.txt
    } > README.md