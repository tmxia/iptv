name: Update README

on:
  push:
    paths:
      - 'version.txt'
  schedule:
    - cron: '0 * * * *'  # 每小时自动检查一次
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Validate version.txt
        id: validate-version
        run: |
          if [ ! -f version.txt ]; then
            echo "::warning::version.txt not found"
            echo "skip_update=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 检查文件是否为有效JSON
          if ! jq empty version.txt 2>/dev/null; then
            echo "::error::version.txt contains invalid JSON"
            exit 1
          fi
          
          # 检查是否有有效数据
          if [ $(jq -e 'length > 0' version.txt) != "true" ]; then
            echo "::warning::version.txt is empty"
            echo "skip_update=true" >> $GITHUB_OUTPUT
          else
            echo "skip_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare README
        id: prepare-readme
        run: |
          # 创建README（如果不存在）
          if [ ! -f README.md ]; then
            echo "Creating new README.md"
            cat <<EOF > README.md
            # Project Versions
            <!-- VERSION_TABLE_START -->
            <!-- VERSION_TABLE_END -->
            EOF
            echo "readme_created=true" >> $GITHUB_OUTPUT
          else
            echo "readme_created=false" >> $GITHUB_OUTPUT
          fi
          
          # 确保标记存在
          if ! grep -q "<!-- VERSION_TABLE_START -->" README.md || ! grep -q "<!-- VERSION_TABLE_END -->" README.md; then
            echo "::warning::Adding missing markers to README.md"
            awk -i inplace '
              BEGIN { added=0 }
              { print }
              /<!-- VERSION_TABLE_START -->/ { 
                print "| 文件名称 | 版本号 | 更新日期 |"
                print "|----------|--------|----------|"
                added=1 
              }
              END { 
                if (!added) {
                  print "\n<!-- VERSION_TABLE_START -->"
                  print "| 文件名称 | 版本号 | 更新日期 |"
                  print "|----------|--------|----------|"
                  print "<!-- VERSION_TABLE_END -->"
                }
              }
            ' README.md
            echo "markers_added=true" >> $GITHUB_OUTPUT
          else
            echo "markers_added=false" >> $GITHUB_OUTPUT
          fi

      - name: Update README
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # 安装必要工具
          sudo apt-get update
          sudo apt-get install -y jq
          
          # 获取仓库信息
          REPO_NAME="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO_NAME}/raw/main/apk/"
          
          # 生成新表格内容
          TABLE_CONTENT=$(jq -r --arg base_url "$BASE_URL" '
            to_entries | 
            map({
              key: .key, 
              version: (.value | split(",")[0]), 
              date: (.value | split(",")[1]),
              url: ("\($base_url)" + (.key | @uri))
            }) | 
            sort_by(.date) | reverse[] | 
            "| [\(.key)](\(.url)) | \(.version) | \(.date) |"
          ' version.txt)
          
          # 生成完整的表格
          FULL_TABLE="| 文件名称 | 版本号 | 更新日期 |\n|----------|--------|----------|\n$TABLE_CONTENT"
          
          # 更新README.md
          awk -i inplace -v table="$FULL_TABLE" '
            BEGIN { replaced=0 }
            /<!-- VERSION_TABLE_START -->/ {
              print
              print table
              replaced=1
              next
            }
            /<!-- VERSION_TABLE_END -->/ {
              # 跳过原始表格内容直到结束标记
              while (getline && !/<!-- VERSION_TABLE_END -->/) {}
              print "<!-- VERSION_TABLE_END -->"
              next
            }
            replaced != 1 { print }
          ' README.md
          
          echo "README updated successfully"

      - name: Commit changes
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # 检查是否有实际变更
          if git diff --exit-code --quiet README.md; then
            echo "No changes to commit"
          else
            git config user.name "github-actions"
            git config user.email "actions@users.noreply.github.com"
            git add README.md
            git commit -m "📚 Update version table [skip ci]"
            git push
          fi

  cleanup_self:
    name: Cleanup Workflow History
    runs-on: ubuntu-latest
    needs: [update-readme]
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0  # 保留最近5次运行记录
          retain_days: 0
          delete_workflow_pattern: "Update README"
          repository: ${{ github.repository }}