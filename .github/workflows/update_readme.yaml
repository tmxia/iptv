name: Real-time README Updater

on:
  push:
    paths:
      - 'version.txt'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version.txt
        id: validate-version
        run: |
          if [ ! -f version.txt ]; then
            echo "::error::version.txt not found"
            exit 1
          fi
          
          if ! jq empty version.txt 2>/dev/null; then
            echo "::error::Invalid JSON in version.txt"
            exit 1
          fi
          
          if [ $(jq -e 'length == 0' version.txt) = "true" ]; then
            echo "::warning::Empty version.txt"
            echo "skip_update=true" >> $GITHUB_OUTPUT
          else
            echo "skip_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare README
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          if [ ! -f README.md ]; then
            echo "# åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨" > README.md
            echo "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |" >> README.md
            echo "|----------|--------|----------|" >> README.md
            echo "<!-- VERSION_TABLE -->" >> README.md
          fi
          
          if ! grep -q "<!-- VERSION_TABLE -->" README.md; then
            echo "<!-- VERSION_TABLE -->" >> README.md
          fi

      - name: Generate and update table
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/apk/"
          
          jq -r --arg base_url "$BASE_URL" '
            to_entries | sort_by(.value | split(",")[1]) | reverse | .[] |
            "| [\(.key)](\($base_url + (.key | @uri))) | \(.value | split(",")[0]) | \(.value | split(",")[1]) |"
          ' version.txt > table_content.txt
          
          awk '
            BEGIN { found = 0; printed = 0 }
            /<!-- VERSION_TABLE -->/ {
              if (!found) {
                found = 1
                print
                print "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
                print "|----------|--------|----------|"
                while (getline line < "table_content.txt") {
                  print line
                }
                close("table_content.txt")
                printed = 1
                while (getline) {
                  if (/<!-- VERSION_TABLE -->/) {
                    print
                    break
                  }
                }
              } else {
                print
              }
              next
            }
            { print }
            END {
              if (!found) {
                print "<!-- VERSION_TABLE -->"
                print "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
                print "|----------|--------|----------|"
                while (getline line < "table_content.txt") {
                  print line
                }
                close("table_content.txt")
                print "<!-- VERSION_TABLE -->"
              } else if (!printed) {
                print "<!-- VERSION_TABLE -->"
              }
            }
          ' README.md > README.tmp
          
          mv README.tmp README.md
          rm table_content.txt
          echo "Updated README.md"

      - name: æäº¤æ›´æ”¹
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git pull origin ${{ github.ref_name }}
          git add README.md
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“š è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬è¡¨æ ¼ [skip ci]"
            git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
          fi

      - name: Verify update
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # å¢å¼ºéªŒè¯ï¼šè¯¦ç»†è°ƒè¯•è¾“å‡º
          echo "===== å¼€å§‹éªŒè¯ README æ›´æ–° ====="
          
          # 1. è·å–ç‰ˆæœ¬æ–‡ä»¶ä¸­çš„æ¡ç›®
          jq -r 'keys[]' version.txt > version_keys.txt
          echo "ç‰ˆæœ¬æ–‡ä»¶ä¸­çš„APKæ–‡ä»¶:"
          cat version_keys.txt
          
          # 2. æå–READMEä¸­çš„æ–‡ä»¶å
          grep -oP '(?<=\[)[^\]]+(?=\]\()' README.md > readme_files.txt
          echo "READMEä¸­æ‰¾åˆ°çš„æ–‡ä»¶å:"
          cat readme_files.txt
          
          # 3. æ£€æŸ¥æ¯ä¸ªç‰ˆæœ¬æ¡ç›®æ˜¯å¦åœ¨READMEä¸­
          missing_count=0
          total_count=0
          
          while IFS= read -r apk_file; do
            ((total_count++))
            if grep -qFx "$apk_file" readme_files.txt; then
              echo "âœ… $apk_file å­˜åœ¨äºREADMEä¸­"
            else
              echo "::error::âŒ $apk_file åœ¨READMEä¸­ç¼ºå¤±"
              ((missing_count++))
            fi
          done < version_keys.txt
          
          # 4. æ£€æŸ¥READMEä¸­æ˜¯å¦æœ‰é¢å¤–æ¡ç›®
          extra_count=0
          while IFS= read -r readme_file; do
            if ! grep -qFx "$readme_file" version_keys.txt; then
              echo "::warning::âš ï¸ $readme_file åœ¨READMEä¸­å­˜åœ¨ä½†ä¸åœ¨version.txtä¸­"
              ((extra_count++))
            fi
          done < readme_files.txt
          
          # 5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm version_keys.txt readme_files.txt
          
          # 6. æŠ¥å‘Šç»“æœ
          echo "===== éªŒè¯ç»“æœ ====="
          echo "æ€»æ¡ç›®æ•°: $total_count"
          echo "ç¼ºå¤±æ¡ç›®: $missing_count"
          echo "é¢å¤–æ¡ç›®: $extra_count"
          
          if [ "$missing_count" -gt 0 ]; then
            echo "::error::éªŒè¯å¤±è´¥: $missing_count ä¸ªæ¡ç›®ç¼ºå¤±"
            exit 1
          elif [ "$extra_count" -gt 0 ]; then
            echo "::warning::è­¦å‘Š: $extra_count ä¸ªé¢å¤–æ¡ç›®å­˜åœ¨"
          else
            echo "âœ… éªŒè¯æˆåŠŸ! æ‰€æœ‰ $total_count ä¸ªæ¡ç›®åŒ¹é…"
          fi

  cleanup_self:
    name: Cleanup Workflow History
    runs-on: ubuntu-latest
    needs: [update-readme]
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 2
          retain_days: 1
          delete_workflow_pattern: "Real-time README Updater"
          repository: ${{ github.repository }}