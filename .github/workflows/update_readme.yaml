name: Update README

on:
  push:
    paths:
      - 'version.txt'
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Validate version.txt
        id: validate-version
        run: |
          if [ ! -f version.txt ]; then
            echo "::warning::version.txt not found"
            echo "skip_update=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºæœ‰æ•ˆJSON
          if ! jq empty version.txt 2>/dev/null; then
            echo "::error::version.txt contains invalid JSON"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
          if [ $(jq -e 'length > 0' version.txt) != "true" ]; then
            echo "::warning::version.txt is empty"
            echo "skip_update=true" >> $GITHUB_OUTPUT
          else
            echo "skip_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare README
        id: prepare-readme
        run: |
          # åˆ›å»ºREADMEï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if [ ! -f README.md ]; then
            echo "Creating new README.md"
            cat <<EOF > README.md
            # Project Versions
            <!-- VERSION_TABLE_START -->
            <!-- VERSION_TABLE_END -->
            EOF
            echo "readme_created=true" >> $GITHUB_OUTPUT
          else
            echo "readme_created=false" >> $GITHUB_OUTPUT
          fi
          
          # ç¡®ä¿æ ‡è®°å­˜åœ¨
          if ! grep -q "<!-- VERSION_TABLE_START -->" README.md || ! grep -q "<!-- VERSION_TABLE_END -->" README.md; then
            echo "::warning::Adding missing markers to README.md"
            awk -i inplace '
              BEGIN { added=0 }
              { print }
              /<!-- VERSION_TABLE_START -->/ { 
                print "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
                print "|----------|--------|----------|"
                added=1 
              }
              END { 
                if (!added) {
                  print "\n<!-- VERSION_TABLE_START -->"
                  print "| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
                  print "|----------|--------|----------|"
                  print "<!-- VERSION_TABLE_END -->"
                }
              }
            ' README.md
            echo "markers_added=true" >> $GITHUB_OUTPUT
          else
            echo "markers_added=false" >> $GITHUB_OUTPUT
          fi

      - name: Update README
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # å®‰è£…å¿…è¦å·¥å…·
          sudo apt-get update
          sudo apt-get install -y jq
          
          # è·å–ä»“åº“ä¿¡æ¯
          REPO_NAME="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO_NAME}/raw/main/apk/"
          
          # ç”Ÿæˆæ–°è¡¨æ ¼å†…å®¹
          TABLE_CONTENT=$(jq -r --arg base_url "$BASE_URL" '
            to_entries | 
            map({
              key: .key, 
              version: (.value | split(",")[0]), 
              date: (.value | split(",")[1]),
              url: ("\($base_url)" + (.key | @uri))
            }) | 
            sort_by(.date) | reverse[] | 
            "| [\(.key)](\(.url)) | \(.version) | \(.date) |"
          ' version.txt)
          
          # ç”Ÿæˆå®Œæ•´çš„è¡¨æ ¼
          FULL_TABLE="| æ–‡ä»¶åç§° | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |\n|----------|--------|----------|\n$TABLE_CONTENT"
          
          # æ›´æ–°README.md
          awk -i inplace -v table="$FULL_TABLE" '
            BEGIN { replaced=0 }
            /<!-- VERSION_TABLE_START -->/ {
              print
              print table
              replaced=1
              next
            }
            /<!-- VERSION_TABLE_END -->/ {
              # è·³è¿‡åŸå§‹è¡¨æ ¼å†…å®¹ç›´åˆ°ç»“æŸæ ‡è®°
              while (getline && !/<!-- VERSION_TABLE_END -->/) {}
              print "<!-- VERSION_TABLE_END -->"
              next
            }
            replaced != 1 { print }
          ' README.md
          
          echo "README updated successfully"

      - name: Commit changes
        if: ${{ steps.validate-version.outputs.skip_update == 'false' }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
          if git diff --exit-code --quiet README.md; then
            echo "No changes to commit"
          else
            git config user.name "github-actions"
            git config user.email "actions@users.noreply.github.com"
            git add README.md
            git commit -m "ğŸ“š Update version table [skip ci]"
            git push
          fi

  cleanup_self:
    name: Cleanup Workflow History
    runs-on: ubuntu-latest
    needs: [update-readme]
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0  # ä¿ç•™æœ€è¿‘5æ¬¡è¿è¡Œè®°å½•
          retain_days: 0
          delete_workflow_pattern: "Update README"
          repository: ${{ github.repository }}