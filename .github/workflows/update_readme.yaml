name: Real-time README Updater

on:
  push:
    paths:
      - 'version.txt'
      - 'apk/**'
      - 'kernel_versions.json'
      - 'kernels/**'
  
  workflow_run:
    workflows: 
      - "NagramX Sync from Source Repository"
      - "BV APK Sync from Source Repository"
      - "GitHub XAPK Download and Sync"
      - "Karing Beta Sync from Source Repository"
      - "MYTV APK Sync from Source Repository"
      - "OK PRO APK Sync from TELEGRAM"
      - "OK APK Sync from Source Repository"
      - "Proxypin Sync from Source Repository"
      - "Simple_live APK Sync from Source Repository"
      - "OpenWrt Kernel Sync from TELEGRAM"
      - "ServerBox Sync from Source Repository"
      - "TV APK Sync from TELEGRAM"
      - "TV NEW APK Sync from TELEGRAM"
      - "Hiddify APK Sync from Source Repository"
      - "Termux APK Sync from Source Repository"
      - "Passwall Packages Sync from Source Repository"
      - "Plus APK Download and Sync"
      - "TAuxiliary APK Sync from TELEGRAM"
    types: [completed]
    branches: [main]
  
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}-${{ github.event.workflow_run.id || github.sha }}
  cancel-in-progress: false  # å…è®¸å¹¶è¡Œæ‰§è¡Œ

jobs:
  # å‰ç½®æ£€æŸ¥é˜¶æ®µ
  pre-check:
    name: Validate Conditions
    runs-on: ubuntu-latest
    outputs:
      should_proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: Check workflow status
        id: check
        run: |
          # å¯¹äºworkflow_runè§¦å‘ï¼Œæ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æˆåŠŸ
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "::set-output name=proceed::false"
              echo "ğŸ›‘ ä¸Šæ¸¸å·¥ä½œæµæœªæˆåŠŸï¼Œç»ˆæ­¢æ‰§è¡Œ"
              exit 0
            fi
          fi
          
          # å¯¹äºæ‰€æœ‰è§¦å‘ç±»å‹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³æ–‡ä»¶å˜æ›´
          changed_files=$(git diff --name-only HEAD^ HEAD)
          relevant_changes=$(echo "$changed_files" | grep -E 'version.txt|kernel_versions.json|apk/|kernels/' || true)
          
          if [ -z "$relevant_changes" ]; then
            echo "::set-output name=proceed::false"
            echo "â­ï¸ æ— ç›¸å…³æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æ‰§è¡Œ"
          else
            echo "::set-output name=proceed::true"
            echo "âœ… æ£€æµ‹åˆ°ç›¸å…³æ–‡ä»¶å˜æ›´ï¼Œç»§ç»­æ‰§è¡Œ"
          fi

  # æ ¸å¿ƒæ›´æ–°ä»»åŠ¡
  update-readme:
    needs: pre-check
    if: ${{ needs.pre-check.outputs.should_proceed == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_PAT }}

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc jq

      - name: Validate version files
        id: validate-versions
        run: |
          # æ£€æŸ¥APKç‰ˆæœ¬æ–‡ä»¶
          if [ ! -f version.txt ]; then
            echo "::warning::version.txt not found"
            echo "update_apk=false" >> $GITHUB_OUTPUT
          else
            # å°è¯•è§£æä¸ºJSON
            if jq empty version.txt 2>/dev/null; then
              echo "update_apk=true" >> $GITHUB_OUTPUT
            else
              echo "::error::Invalid JSON in version.txt"
              exit 1
            fi
          fi
          
          # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶
          if [ ! -f kernel_versions.json ]; then
            echo "::warning::kernel_versions.json not found"
            echo "update_kernel=false" >> $GITHUB_OUTPUT
          else
            if jq empty kernel_versions.json 2>/dev/null; then
              echo "update_kernel=true" >> $GITHUB_OUTPUT
            else
              echo "::error::Invalid JSON in kernel_versions.json"
              exit 1
            fi
          fi

      - name: Generate new README
        run: |
          # è®¾ç½®åŸºç¡€URL
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          APK_BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/apk/"
          KERNEL_BASE_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/kernels/"
          
          # åˆå§‹åŒ–READMEå†…å®¹
          {
            echo "# åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨"
            echo ""
            echo "æœ€åæ›´æ–°: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)"
            echo ""
            
            # ç”Ÿæˆåº”ç”¨è¡¨æ ¼
            if ${{ steps.validate-versions.outputs.update_apk }} == 'true'; then
              echo "## åº”ç”¨"
              echo ""
              echo "| æ–‡ä»¶åç§° | æ–‡ä»¶å¤§å°(M) | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
              echo "|----------|------------|--------|----------|"
              
              # æŒ‰æ›´æ–°æ—¥æœŸé™åºæ’åˆ—
              jq -r 'to_entries | sort_by(.value | split(",")[1]) | reverse | .[] | .key' version.txt | while read -r key; do
                # è·å–ç‰ˆæœ¬ä¿¡æ¯
                value=$(jq -r ".\"$key\"" version.txt)
                version=$(echo "$value" | cut -d, -f1)
                date=$(echo "$value" | cut -d, -f2)
                
                # è·å–æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰
                file_path="apk/$key"
                if [ -f "$file_path" ]; then
                  file_bytes=$(stat -c%s "$file_path")
                  file_size=$(echo "scale=2; $file_bytes / (1024*1024)" | bc)
                else
                  file_size="N/A"
                fi
                
                # ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤ºæ–‡ä»¶åï¼Œä¸‹æ–¹æ·»åŠ ä¸‹è½½é“¾æ¥
                echo "| <div>$key</div><div><small>[ä¸‹è½½](${APK_BASE_URL}${key})</small></div> | $file_size | $version | $date |"
              done
            else
              echo "> æš‚æ— åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯"
            fi
            
            # æ·»åŠ å†…æ ¸éƒ¨åˆ†
            echo ""
            echo "---"
            echo ""
            echo "# OpenWrtå†…æ ¸åˆ—è¡¨"
            echo ""
            
            if ${{ steps.validate-versions.outputs.update_kernel }} == 'true'; then
              echo "## å†…æ ¸"
              echo ""
              echo "| å†…æ ¸åç§° | æ–‡ä»¶å¤§å°(M) | ç‰ˆæœ¬å· | æ›´æ–°æ—¥æœŸ |"
              echo "|----------|------------|--------|----------|"
              
              # å¤„ç†å†…æ ¸ç‰ˆæœ¬ - æŒ‰æ›´æ–°æ—¥æœŸé™åºæ’åˆ—
              jq -r 'to_entries | sort_by(.value.date) | reverse | .[] | .key' kernel_versions.json | while read -r kernel_key; do
                # è·å–ç‰ˆæœ¬ä¿¡æ¯
                version=$(jq -r ".\"$kernel_key\".version" kernel_versions.json)
                date=$(jq -r ".\"$kernel_key\".date" kernel_versions.json)
                
                # æ„å»ºå®é™…æ–‡ä»¶å
                file_name="${kernel_key}_${version}.zip"
                
                # è·å–æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰
                file_path="kernels/$file_name"
                if [ -f "$file_path" ]; then
                  file_bytes=$(stat -c%s "$file_path")
                  file_size=$(echo "scale=2; $file_bytes / (1024*1024)" | bc)
                else
                  file_size="N/A"
                fi
                
                # ç¾åŒ–å†…æ ¸åç§°
                kernel_name=$(echo "$kernel_key" | sed 's/openwrt_flippy//; s/6\.1/6.1/; s/6\.6/6.6/; s/6\.12/6.12/')
                kernel_name="OpenWrt $kernel_name"
                
                # ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤ºæ–‡ä»¶åï¼Œä¸‹æ–¹æ·»åŠ ä¸‹è½½é“¾æ¥
                echo "| <div>$kernel_name</div><div><small>[ä¸‹è½½](${KERNEL_BASE_URL}${file_name})</small></div> | $file_size | $version | $date |"
              done
            else
              echo "> æš‚æ— å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯"
            fi
            
          } > README.md
          
          echo "Generated new README.md with APK and Kernel tables"

      - name: Commit changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          if git diff --quiet README.md; then
            echo "No changes to README.md"
            exit 0
          fi
          
          git config user.name "github-actions[bot]"
          git config user.email "actions@users.noreply.github.com"
          git add README.md
          
          # ä½¿ç”¨ [skip actions] é¿å…è§¦å‘å…¶ä»–å·¥ä½œæµ
          git commit -m "ğŸ“š è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬è¡¨æ ¼ [skip actions]"
          
          # ä½¿ç”¨ PAT ä»¤ç‰Œæ¨é€
          git push "https://${{ github.actor }}:${{ secrets.REPO_PAT }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}

      - name: Verify README
        run: |
          # ç®€å•éªŒè¯READMEæ˜¯å¦åŒ…å«å…³é”®å†…å®¹
          if grep -q "åº”ç”¨ç‰ˆæœ¬åˆ—è¡¨" README.md && \
             grep -q "OpenWrtå†…æ ¸åˆ—è¡¨" README.md; then
            echo "âœ… READMEæ›´æ–°æˆåŠŸ"
          else
            echo "::error::READMEæ›´æ–°å¤±è´¥"
            exit 1
          fi

  # å·¥ä½œæµæ¸…ç†
  cleanup_self:
    name: Cleanup Workflow History
    runs-on: ubuntu-latest
    needs: [update-readme]
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 5
          retain_days: 3
          delete_workflow_pattern: "Real-time README Updater"
          repository: ${{ github.repository }}