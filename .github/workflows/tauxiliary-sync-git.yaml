name: TAuxiliary APK ä» Telegram åŒæ­¥

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */1 * * *'  # æ¯1å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    name: åŒæ­¥APK
    runs-on: ubuntu-latest
    steps:
    - name: è·å–ä»“åº“é”
      uses: softprops/turnstyle@v1
      with:
        same-branch-only: true
        abort-after-seconds: 600
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade telethon==1.34.0 pytz requests
        pip install cryptography cffi

    - name: é…ç½®Git
      run: |
        git config user.name "github-actions"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

    - name: åŒæ­¥TAuxiliary APK
      id: sync_apk
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
      run: |
        echo "å¼€å§‹æ‰§è¡ŒåŒæ­¥è„šæœ¬..."
        python - << "EOF"
        import os
        import re
        import json
        import sys
        from datetime import datetime
        from telethon import TelegramClient
        from telethon.sessions import StringSession
        from telethon.tl.types import DocumentAttributeFilename
        import pytz
        
        # é…ç½®å‚æ•°
        GROUP = "TAuxiliary"  # ç¾¤ç»„ç”¨æˆ·å
        TOPIC_ID = 3763       # è¯é¢˜ID
        APK_PATH = "apk/tauxiliary.apk"
        VERSION_FILE = "version.txt"
        VERSION_KEY = "tauxiliary.apk"
        
        def log(msg):
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] {msg}")
        
        async def main():
            """ä¸»åŒæ­¥é€»è¾‘"""
            log("å¼€å§‹åŒæ­¥ TAuxiliary APK")
            
            # åˆå§‹åŒ–ç‰ˆæœ¬ä¿¡æ¯
            versions = {}
            current = ""
            
            # å°è¯•è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
            try:
                if os.path.exists(VERSION_FILE):
                    with open(VERSION_FILE, 'r') as f:
                        try:
                            versions = json.load(f)
                            current = versions.get(VERSION_KEY, "")
                            if current:
                                log(f"å½“å‰ç‰ˆæœ¬: {current.split(',')[0]}")
                            else:
                                log("æœªæ‰¾åˆ°å½“å‰ç‰ˆæœ¬ä¿¡æ¯")
                        except json.JSONDecodeError:
                            log("ç‰ˆæœ¬æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œå°†é‡ç½®")
                            versions = {}
                else:
                    log("ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»º")
            except Exception as e:
                log(f"è¯»å–ç‰ˆæœ¬æ–‡ä»¶é”™è¯¯: {str(e)}")
            
            # æ£€æŸ¥APKæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            apk_exists = os.path.exists(APK_PATH)
            log(f"APKæ–‡ä»¶å­˜åœ¨: {'æ˜¯' if apk_exists else 'å¦'}")
            
            # è¿æ¥Telegram
            client = TelegramClient(
                StringSession(os.environ['TELEGRAM_SESSION']),
                int(os.environ['TELEGRAM_API_ID']),
                os.environ['TELEGRAM_API_HASH'],
                connection_retries=5,
                request_retries=5,
                auto_reconnect=True,
                use_ipv6=False
            )
            
            try:
                await client.start()
                log("æˆåŠŸè¿æ¥ Telegram")
                
                # è·å–ç¾¤ç»„å®ä½“
                group = await client.get_entity(GROUP)
                log(f"å·²è¿›å…¥ç¾¤ç»„: {group.title}")
                
                # æŸ¥æ‰¾è¯é¢˜ä¸­çš„æœ€æ–°APK
                found = False
                update_available = False
                async for msg in client.iter_messages(group, reply_to=TOPIC_ID, limit=10):
                    if not msg.media or not hasattr(msg.media, "document"):
                        continue
                    
                    # æŸ¥æ‰¾æ–‡ä»¶åå±æ€§
                    for attr in msg.media.document.attributes:
                        if not isinstance(attr, DocumentAttributeFilename):
                            continue
                        
                        filename = attr.file_name
                        if not filename.endswith(".apk"):
                            continue
                        
                        # ä½¿ç”¨ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ–‡ä»¶å
                        match = re.search(r'TAuxiliary-([\d.]+)_([a-f0-9]+)\.apk$', filename)
                        if not match:
                            log(f"è·³è¿‡æ— æ•ˆæ–‡ä»¶å: {filename}")
                            continue
                        
                        version = f"v{match.group(1)}"
                        commit_hash = match.group(2)
                        date = msg.date.astimezone(pytz.timezone('Asia/Shanghai')).strftime("%Y-%m-%d")
                        new_value = f"{version},{date}"
                        
                        log(f"å‘ç°æ–°ç‰ˆæœ¬: {version} (å‘å¸ƒäº {date})")
                        
                        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨æˆ–ç‰ˆæœ¬ä¸åŒ¹é…ï¼‰
                        if not apk_exists or not current or new_value != current:
                            # ä¸‹è½½APKåˆ°å†…å­˜
                            log(f"æ­£åœ¨ä¸‹è½½æ–°ç‰ˆæœ¬: {version}")
                            apk_content = await client.download_media(msg, file=bytes)
                            
                            # ç¡®ä¿ç›®å½•å­˜åœ¨
                            os.makedirs(os.path.dirname(APK_PATH), exist_ok=True)
                            
                            # å†™å…¥APKæ–‡ä»¶
                            with open(APK_PATH, 'wb') as f:
                                f.write(apk_content)
                            
                            # æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
                            versions[VERSION_KEY] = new_value
                            with open(VERSION_FILE, 'w') as f:
                                json.dump(versions, f, indent=2)
                            
                            log(f"æˆåŠŸæ›´æ–°åˆ°ç‰ˆæœ¬: {version}")
                            update_available = True
                        else:
                            log("å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬")
                        
                        found = True
                        break
                    if found:
                        break
                
                if not found:
                    log("æœªåœ¨è¯é¢˜ä¸­æ‰¾åˆ°æœ‰æ•ˆçš„ TAuxiliary APK")
                
                return update_available
            except Exception as e:
                log(f"åŒæ­¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}")
                import traceback
                traceback.print_exc()
                return False
            finally:
                await client.disconnect()
                log("å·²æ–­å¼€ Telegram è¿æ¥")
        
        if __name__ == "__main__":
            import asyncio
            try:
                update_available = asyncio.run(main())
                # è®¾ç½®è¾“å‡ºæ ‡å¿—
                if update_available:
                    print("::set-output name=update_available::true")
                    log("åŒæ­¥å®Œæˆ: å‘ç°æ–°ç‰ˆæœ¬")
                else:
                    log("åŒæ­¥å®Œæˆ: æ— æ–°ç‰ˆæœ¬")
            except Exception as e:
                log(f"è„šæœ¬æ‰§è¡Œå¤±è´¥: {str(e)}")
                sys.exit(1)
        EOF

    - name: æäº¤å¹¶æ¨é€æ›´æ”¹
      if: steps.sync_apk.outputs.update_available == 'true'
      run: |
        echo "æ£€æµ‹åˆ°æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."
        git add apk/tauxiliary.apk version.txt
        git status
        git commit -m "æ›´æ–° TAuxiliary APK å’Œç‰ˆæœ¬ä¿¡æ¯"
        git push
        echo "å·²æäº¤å¹¶æ¨é€æ›´æ–°"

    - name: é‡Šæ”¾ä»“åº“é”
      if: always()
      uses: softprops/turnstyle@v1
      with:
        action: unlock
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: å¤±è´¥é€šçŸ¥
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš¨ TAuxiliary åŒæ­¥å¤±è´¥ï¼[æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
          })

  cleanup:
    name: æ¸…ç†å·¥ä½œæµå†å²
    runs-on: ubuntu-latest
    needs: sync
    if: always()
    permissions:
      actions: write
      contents: read
    steps:
      - name: åˆ é™¤æ—§è¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 5  # ä¿ç•™æœ€è¿‘5æ¬¡è¿è¡Œ
          retain_days: 7  # ä¿ç•™7å¤©å†…çš„è¿è¡Œè®°å½•
          delete_workflow_pattern: "TAuxiliary APK ä» Telegram åŒæ­¥"
          repository: ${{ github.repository }}