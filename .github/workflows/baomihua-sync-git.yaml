name: BaoMiHua APK Download and Sync

on:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

# ä½¿ç”¨åŸç”Ÿå¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # åŸºäºç¼“å­˜çš„é”æœºåˆ¶
    - name: Acquire Repository Lock ğŸ”’
      id: lock
      run: |
        # åˆ›å»ºé”æ–‡ä»¶è·¯å¾„
        LOCK_DIR="$GITHUB_WORKSPACE/.lock"
        mkdir -p "$LOCK_DIR"
        LOCK_FILE="$LOCK_DIR/repo-lock"
        
        # å°è¯•è·å–é”
        for i in {1..10}; do
          if [ -f "$LOCK_FILE" ]; then
            echo "é”å·²è¢«å ç”¨ï¼Œç­‰å¾…é‡è¯• ($i/10)..."
            sleep 30
          else
            # åˆ›å»ºé”æ–‡ä»¶
            touch "$LOCK_FILE"
            echo "lock-acquired=true" >> $GITHUB_OUTPUT
            echo "æˆåŠŸè·å–é”"
            exit 0
          fi
        done
        
        echo "é”™è¯¯: æ— æ³•åœ¨5åˆ†é’Ÿå†…è·å–é”"
        exit 1

    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@users.noreply.github.com"
        git config pull.rebase true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl wget python3-pip
        pip install --upgrade pip
        pip install cloudscraper requests beautifulsoup4

    - name: Download and process APK
      env:
        APK_NAME: "baomihua.apk"
        DOWNLOAD_PAGE_URL: "https://bmh.163.com/download/"
      run: |
        # 1. ç¡®ä¿è·å–æœ€æ–°ä»£ç 
        echo "æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
        git pull origin main
        
        # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
        WORK_DIR=$(mktemp -d)
        echo "åˆ›å»ºä¸´æ—¶ç›®å½•: $WORK_DIR"
        trap 'rm -rf "$WORK_DIR"; echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."' EXIT

        # ä½¿ç”¨cloudscraperç»•è¿‡Cloudflareè·å–é¡µé¢
        echo "è·å–ä¸‹è½½é¡µé¢..."
        cat > "$WORK_DIR/get_page.py" <<EOL
        import cloudscraper
        import sys
        import json
        
        scraper = cloudscraper.create_scraper()
        try:
            response = scraper.get(sys.argv[1])
            if response.status_code == 200:
                print(response.text)
            else:
                print(f"é”™è¯¯: çŠ¶æ€ç  {response.status_code}", file=sys.stderr)
                sys.exit(1)
        except Exception as e:
            print(f"é”™è¯¯: {str(e)}", file=sys.stderr)
            sys.exit(1)
        EOL
        
        # è¿è¡ŒPythonè„šæœ¬è·å–é¡µé¢
        DOWNLOAD_PAGE=$(python3 "$WORK_DIR/get_page.py" "$DOWNLOAD_PAGE_URL")
        if [ $? -ne 0 ]; then
          echo "è·å–é¡µé¢å¤±è´¥"
          exit 1
        fi
        
        # è§£æé¡µé¢æå–Androidç‰ˆæœ¬ä¿¡æ¯å’Œä¸‹è½½é“¾æ¥
        echo "è§£æé¡µé¢æå–Androidç‰ˆæœ¬ä¿¡æ¯..."
        cat > "$WORK_DIR/parse_android.py" <<EOL
        import sys
        import re
        import json
        from bs4 import BeautifulSoup
        
        html_content = sys.argv[1]
        soup = BeautifulSoup(html_content, 'html.parser')
        
        # æŸ¥æ‰¾Androidä¸‹è½½é¡¹
        android_items = soup.find_all(attrs={"data-type": "android"})
        if not android_items:
            print("é”™è¯¯: æœªæ‰¾åˆ°Androidä¸‹è½½é¡¹", file=sys.stderr)
            sys.exit(1)
        
        android_item = android_items[0]
        
        # æå–ç‰ˆæœ¬ä¿¡æ¯
        version_element = android_item.select_one('.download-item__version')
        version_text = version_element.get_text().strip() if version_element else ""
        
        # ä»ç‰ˆæœ¬æ–‡æœ¬ä¸­æå–ç‰ˆæœ¬å·
        version_match = re.search(r'v?([0-9]+\\.[0-9]+\\.[0-9]+)', version_text)
        if version_match:
            version = version_match.group(1)
        else:
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰ˆæœ¬å·ï¼Œå°è¯•ä»JavaScriptæ•°æ®ä¸­è·å–
            script_tags = soup.find_all('script')
            for script in script_tags:
                if script.string and 'android' in script.string.lower():
                    # æŸ¥æ‰¾ç‰ˆæœ¬ä¿¡æ¯æ¨¡å¼
                    version_matches = re.findall(r'version[\\s:=]+["\']?([0-9]+\\.[0-9]+\\.[0-9]+)["\']?', script.string, re.IGNORECASE)
                    if version_matches:
                        version = version_matches[0]
                        break
            else:
                version = "unknown"
        
        # æŸ¥æ‰¾JavaScriptä¸­çš„ä¸‹è½½é“¾æ¥
        download_link = None
        
        # æ–¹æ³•1: æŸ¥æ‰¾åŒ…å«ä¸‹è½½é“¾æ¥çš„JavaScriptä»£ç 
        for script in soup.find_all('script'):
            if script.string:
                # æŸ¥æ‰¾å¸¸è§çš„ä¸‹è½½é“¾æ¥æ¨¡å¼
                patterns = [
                    r'https://[^"\']*BaoMiHua[^"\']*\\.apk[^"\']*',
                    r'https://[^"\']*netease[^"\']*\\.apk[^"\']*',
                    r'https://[^"\']*gdl\\.netease[^"\']*\\.apk[^"\']*',
                    r'https://[^"\']*filmly[^"\']*\\.apk[^"\']*'
                ]
                for pattern in patterns:
                    matches = re.findall(pattern, script.string)
                    if matches:
                        # ä¼˜å…ˆé€‰æ‹©åŒ…å«BaoMiHuaçš„é“¾æ¥
                        for match in matches:
                            if 'BaoMiHua' in match:
                                download_link = match
                                break
                        if not download_link:
                            download_link = matches[0]
                        break
                if download_link:
                    break
        
        # æ–¹æ³•2: æŸ¥æ‰¾å¯èƒ½åŒ…å«ä¸‹è½½ä¿¡æ¯çš„dataå±æ€§
        if not download_link:
            data_links = soup.find_all(attrs={"data-download-url": True})
            for link in data_links:
                if 'android' in str(link).lower():
                    download_link = link.get('data-download-url')
                    break
        
        # æ–¹æ³•3: æŸ¥æ‰¾æ¨¡æ€æ¡†ä¸­çš„ä¸‹è½½é“¾æ¥
        if not download_link:
            popup_elements = soup.find_all(class_='filmly-popup')
            for popup in popup_elements:
                android_download = popup.select_one('.androiddownload')
                if android_download:
                    onclick_attr = android_download.get('onclick')
                    if onclick_attr:
                        # ä»onclickä¸­æå–URL
                        url_match = re.search(r"window\\.open\\('([^']+)'\\)", onclick_attr)
                        if url_match:
                            download_link = url_match.group(1)
                            break
                        # å…¶ä»–å¯èƒ½çš„onclickæ¨¡å¼
                        url_match = re.search(r"location\\.href=['\"]([^'\"]+)['\"]", onclick_attr)
                        if url_match:
                            download_link = url_match.group(1)
                            break
                    href_attr = android_download.get('href')
                    if href_attr and href_attr.startswith('http'):
                        download_link = href_attr
                        break
        
        # æ–¹æ³•4: ä»å¤–éƒ¨JavaScriptæ–‡ä»¶è·å–
        if not download_link:
            # æŸ¥æ‰¾é¡µé¢å¼•ç”¨çš„JavaScriptæ–‡ä»¶
            js_files = []
            for script in soup.find_all('script'):
                src = script.get('src')
                if src and ('download' in src or 'filmly' in src):
                    js_files.append(src)
            
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸‹è½½å’Œåˆ†æJSæ–‡ä»¶çš„é€»è¾‘
            # ä½†ç”±äºå¤æ‚åº¦ï¼Œæš‚æ—¶è·³è¿‡
        
        if not download_link:
            print("é”™è¯¯: æ— æ³•ä»é¡µé¢ä¸­æ‰¾åˆ°APKä¸‹è½½é“¾æ¥", file=sys.stderr)
            sys.exit(1)
        
        result = {
            "version": version,
            "download_url": download_link
        }
        
        print(json.dumps(result))
        EOL
        
        # è¿è¡Œè§£æè„šæœ¬
        ANDROID_INFO=$(python3 "$WORK_DIR/parse_android.py" "$DOWNLOAD_PAGE")
        if [ $? -ne 0 ]; then
          echo "è§£æAndroidä¿¡æ¯å¤±è´¥"
          exit 1
        fi
        
        # æå–ç‰ˆæœ¬å’Œä¸‹è½½é“¾æ¥
        VERSION=$(echo "$ANDROID_INFO" | jq -r '.version')
        APK_LINK=$(echo "$ANDROID_INFO" | jq -r '.download_url')
        
        echo "æå–åˆ°ç‰ˆæœ¬å·: $VERSION"
        echo "æå–åˆ°APKé“¾æ¥: $APK_LINK"
        
        if [ "$VERSION" = "unknown" ]; then
          VERSION=$(date +%Y%m%d%H%M)
          echo "è­¦å‘Š: ä½¿ç”¨æ—¥æœŸä½œä¸ºç‰ˆæœ¬å·: $VERSION"
        fi
        
        # è·å–å½“å‰æ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
        CURRENT_DATE=$(TZ=Asia/Shanghai date +"%Y-%m-%d")
        echo "å½“å‰æ—¥æœŸ: $CURRENT_DATE"

        # è¯»å–ç‰ˆæœ¬æ–‡ä»¶
        VERSION_FILE="version.txt"
        if [ -f "$VERSION_FILE" ]; then
          CURRENT_VERSION_JSON=$(cat "$VERSION_FILE")
        else
          CURRENT_VERSION_JSON="{}"
        fi

        # è·å–å½“å‰ç‰ˆæœ¬å€¼
        CURRENT_VALUE=$(echo "$CURRENT_VERSION_JSON" | jq -r ".\"$APK_NAME\"")
        CURRENT_VERSION=""
        if [ "$CURRENT_VALUE" != "null" ] && [ -n "$CURRENT_VALUE" ]; then
          IFS=',' read -ra parts <<< "$CURRENT_VALUE"
          CURRENT_VERSION="${parts[0]}"
        fi

        # ç§»é™¤å½“å‰ç‰ˆæœ¬å·ä¸­çš„vå‰ç¼€
        CURRENT_VERSION_NO_V=${CURRENT_VERSION#v}

        echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION_NO_V"
        echo "æ–°ç‰ˆæœ¬: $VERSION"

        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        NEED_UPDATE=false

        if [ "$CURRENT_VALUE" == "null" ] || [ -z "$CURRENT_VALUE" ]; then
          echo "éœ€è¦æ›´æ–°: ç‰ˆæœ¬è®°å½•ä¸å­˜åœ¨"
          NEED_UPDATE=true
        
        elif [ "$VERSION" != "$CURRENT_VERSION_NO_V" ]; then
          echo "éœ€è¦æ›´æ–°: å‘ç°æ–°ç‰ˆæœ¬ ($CURRENT_VERSION_NO_V â†’ $VERSION)"
          NEED_UPDATE=true
        
        elif [ ! -f "apk/$APK_NAME" ]; then
          echo "éœ€è¦æ›´æ–°: APKæ–‡ä»¶ä¸å­˜åœ¨"
          NEED_UPDATE=true
        else
          echo "æ— éœ€æ›´æ–°: ç‰ˆæœ¬ç›¸åŒä¸”æ–‡ä»¶å­˜åœ¨"
        fi

        if [ "$NEED_UPDATE" = false ]; then
          echo "æ— éœ€æ›´æ–°ï¼Œé€€å‡º"
          exit 0
        fi

        # ä½¿ç”¨cloudscraperä¸‹è½½æ–‡ä»¶
        echo "æ­£åœ¨ä¸‹è½½APKæ–‡ä»¶..."
        cat > "$WORK_DIR/download_file.py" <<EOL
        import cloudscraper
        import sys
        
        scraper = cloudscraper.create_scraper()
        try:
            response = scraper.get(sys.argv[1], stream=True)
            if response.status_code != 200:
                print(f"é”™è¯¯: ä¸‹è½½å¤±è´¥ï¼ŒçŠ¶æ€ç  {response.status_code}", file=sys.stderr)
                sys.exit(1)
                
            with open(sys.argv[2], 'wb') as f:
                for chunk in response.iter_content(chunk_size=8192):
                    if chunk:
                        f.write(chunk)
            
            print(f"ä¸‹è½½å®Œæˆ")
            
        except Exception as e:
            print(f"ä¸‹è½½é”™è¯¯: {str(e)}", file=sys.stderr)
            sys.exit(1)
        EOL
        
        # è¿è¡Œä¸‹è½½è„šæœ¬
        python3 "$WORK_DIR/download_file.py" "$APK_LINK" "$WORK_DIR/temp.apk"
        if [ $? -ne 0 ]; then
          echo "ä¸‹è½½APKå¤±è´¥"
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦åˆç†
        if [ ! -f "$WORK_DIR/temp.apk" ]; then
          echo "é”™è¯¯: APKä¸‹è½½å¤±è´¥ - æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < "$WORK_DIR/temp.apk")
        if [ "$FILE_SIZE" -lt 50000000 ]; then
          echo "é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶å¤§å°($FILE_SIZE å­—èŠ‚)è¿‡å°"
          exit 1
        fi

        # åˆ›å»ºapkç›®å½•
        mkdir -p apk

        # ä¿å­˜å½“å‰ç‰ˆæœ¬
        cp "$WORK_DIR/temp.apk" "apk/$APK_NAME"
        echo "å·²ä¿å­˜APKæ–‡ä»¶ (å¤§å°: $FILE_SIZE å­—èŠ‚)"

        # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        NEW_VALUE="v$VERSION,$CURRENT_DATE"
        NEW_VERSION_JSON=$(echo "$CURRENT_VERSION_JSON" | jq --arg key "$APK_NAME" --arg value "$NEW_VALUE" '.[$key] = $value')
        echo "$NEW_VERSION_JSON" > "$VERSION_FILE"
        echo "æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶"

        # æ·»åŠ æ–‡ä»¶åˆ°Git
        git add apk/ "$VERSION_FILE"

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -z "$(git status --porcelain)" ]; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          exit 0
        fi

        # æäº¤æ›´æ”¹
        git commit -m "æ›´æ–°ç½‘æ˜“çˆ†ç±³èŠ±: v$VERSION ($CURRENT_DATE)"
        
        # æ¨é€æ›´æ”¹
        echo "æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
        git push origin main

        echo "åŒæ­¥å®Œæˆ! ç‰ˆæœ¬: v$VERSION, æ—¥æœŸ: $CURRENT_DATE"

    - name: Release Repository Lock ğŸ”“
      if: always()
      run: |
        # é‡Šæ”¾é”
        LOCK_FILE="$GITHUB_WORKSPACE/.lock/repo-lock"
        if [ -f "$LOCK_FILE" ]; then
          rm -f "$LOCK_FILE"
          echo "é”å·²é‡Šæ”¾"
        else
          echo "é”æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€é‡Šæ”¾"
        fi

  cleanup_self:
    name: Cleanup Self Workflow History
    runs-on: ubuntu-latest
    needs: sync
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2.0.6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "BaoMiHua APK Download and Sync"
          repository: ${{ github.repository }}