name: Plus APK Download and Sync

on:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # åŸºäºç¼“å­˜çš„é”æœºåˆ¶
    - name: Acquire Repository Lock ğŸ”’
      id: lock
      run: |
        # åˆ›å»ºé”æ–‡ä»¶è·¯å¾„
        LOCK_DIR="$GITHUB_WORKSPACE/.lock"
        mkdir -p "$LOCK_DIR"
        LOCK_FILE="$LOCK_DIR/repo-lock"
        
        # å°è¯•è·å–é”
        for i in {1..10}; do
          if [ -f "$LOCK_FILE" ]; then
            echo "é”å·²è¢«å ç”¨ï¼Œç­‰å¾…é‡è¯• ($i/10)..."
            sleep 30
          else
            # åˆ›å»ºé”æ–‡ä»¶
            touch "$LOCK_FILE"
            echo "lock-acquired=true" >> $GITHUB_OUTPUT
            echo "æˆåŠŸè·å–é”"
            exit 0
          fi
        done
        
        echo "é”™è¯¯: æ— æ³•åœ¨5åˆ†é’Ÿå†…è·å–é”"
        exit 1

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@users.noreply.github.com"
        git config pull.rebase true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl wget python3-pip
        pip install --upgrade pip
        pip install cloudscraper requests beautifulsoup4

    - name: Download and process APK
      env:
        APK_NAME: "plus_mod.apk"
        DOWNLOAD_URL: "https://leeapk.com/plus-messenger-mod-apk/download/"
      run: |
        # 1. ç¡®ä¿è·å–æœ€æ–°ä»£ç 
        echo "æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
        git pull origin main
        
        # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
        WORK_DIR=$(mktemp -d)
        echo "åˆ›å»ºä¸´æ—¶ç›®å½•: $WORK_DIR"
        trap 'rm -rf "$WORK_DIR"; echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."' EXIT

        # ä½¿ç”¨cloudscraperç»•è¿‡Cloudflareè·å–é¡µé¢
        echo "è·å–ä¸‹è½½é¡µé¢å¹¶æå–ä¿¡æ¯..."
        cat > "$WORK_DIR/extract_info.py" <<EOL
        import cloudscraper
        import re
        import sys
        from bs4 import BeautifulSoup
        from datetime import datetime
        
        def extract_info(url):
            scraper = cloudscraper.create_scraper()
            try:
                response = scraper.get(url)
                if response.status_code != 200:
                    print(f"é”™è¯¯: è·å–é¡µé¢å¤±è´¥ï¼ŒçŠ¶æ€ç  {response.status_code}", file=sys.stderr)
                    sys.exit(1)
                
                content = response.text
                
                # æå–APKé“¾æ¥
                apk_link = None
                soup = BeautifulSoup(content, 'html.parser')
                download_button = soup.find('a', id='download_button')
                if download_button and download_button.has_attr('href'):
                    apk_link = download_button['href']
                
                # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸‹è½½æŒ‰é’®ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•
                if not apk_link:
                    apk_link_match = re.search(r'href="(https://dl\.leeapk\.com[^"]+\.apk)"', content)
                    if apk_link_match:
                        apk_link = apk_link_match.group(1)
                
                # æå–å‘å¸ƒæ—¥æœŸ
                release_date = None
                date_pattern = r"Download Plus Messenger For Android\s*([A-Za-z]+\s\d{1,2},\s\d{4})"
                date_match = re.search(date_pattern, content)
                if date_match:
                    raw_date = date_match.group(1)
                    try:
                        # è½¬æ¢æ—¥æœŸæ ¼å¼
                        date_obj = datetime.strptime(raw_date, "%B %d, %Y")
                        release_date = date_obj.strftime("%Y-%m-%d")
                    except Exception as e:
                        print(f"æ—¥æœŸè½¬æ¢é”™è¯¯: {str(e)}")
                
                return {
                    "apk_link": apk_link,
                    "release_date": release_date
                }
                
            except Exception as e:
                print(f"é”™è¯¯: {str(e)}", file=sys.stderr)
                sys.exit(1)
        
        if __name__ == "__main__":
            if len(sys.argv) != 2:
                print("ç”¨æ³•: python extract_info.py <url>", file=sys.stderr)
                sys.exit(1)
            
            info = extract_info(sys.argv[1])
            print(f"APK_LINK={info['apk_link']}")
            print(f"RELEASE_DATE={info['release_date']}")
        EOL
        
        # è¿è¡ŒPythonè„šæœ¬æå–ä¿¡æ¯
        EXTRACTED_INFO=$(python3 "$WORK_DIR/extract_info.py" "$DOWNLOAD_URL")
        if [ $? -ne 0 ]; then
          echo "æå–ä¿¡æ¯å¤±è´¥"
          exit 1
        fi
        
        # è§£ææå–çš„ä¿¡æ¯
        APK_LINK=$(echo "$EXTRACTED_INFO" | grep 'APK_LINK=' | cut -d'=' -f2)
        RELEASE_DATE=$(echo "$EXTRACTED_INFO" | grep 'RELEASE_DATE=' | cut -d'=' -f2)
        
        if [ -z "$APK_LINK" ]; then
          echo "é”™è¯¯: æ— æ³•æå–APKé“¾æ¥"
          exit 1
        fi
        
        echo "æå–åˆ°APKé“¾æ¥: $APK_LINK"
        echo "æå–åˆ°å‘å¸ƒæ—¥æœŸ: ${RELEASE_DATE:-æœªæ‰¾åˆ°}"
        
        # å¦‚æœæœªæå–åˆ°å‘å¸ƒæ—¥æœŸï¼Œä½¿ç”¨å½“å‰æ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
        if [ -z "$RELEASE_DATE" ]; then
          RELEASE_DATE=$(TZ=Asia/Shanghai date +"%Y-%m-%d")
          echo "è­¦å‘Š: ä½¿ç”¨å½“å‰æ—¥æœŸä½œä¸ºå‘å¸ƒæ—¥æœŸ: $RELEASE_DATE"
        fi

        # ä»é“¾æ¥æå–ä¸»ç‰ˆæœ¬å·
        FILENAME=$(basename "$APK_LINK")
        VERSION=$(echo "$FILENAME" | sed -n 's/.*Plus_Messenger_v\{0,1\}\([0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
        
        if [ -z "$VERSION" ]; then
          VERSION=$(date +%Y%m%d%H%M)
          echo "è­¦å‘Š: ä½¿ç”¨æ—¥æœŸä½œä¸ºç‰ˆæœ¬å·: $VERSION"
        fi
        
        echo "ç‰ˆæœ¬å·: $VERSION"
        
        # è¯»å–ç‰ˆæœ¬æ–‡ä»¶
        VERSION_FILE="version.txt"
        if [ -f "$VERSION_FILE" ]; then
          CURRENT_VERSION_JSON=$(cat "$VERSION_FILE")
        else
          CURRENT_VERSION_JSON="{}"
        fi

        # è·å–å½“å‰ç‰ˆæœ¬å€¼
        CURRENT_VALUE=$(echo "$CURRENT_VERSION_JSON" | jq -r ".\"$APK_NAME\"")
        CURRENT_VERSION=""
        if [ "$CURRENT_VALUE" != "null" ] && [ -n "$CURRENT_VALUE" ]; then
          IFS=',' read -ra parts <<< "$CURRENT_VALUE"
          CURRENT_VERSION="${parts[0]}"
        fi

        # ç§»é™¤å½“å‰ç‰ˆæœ¬å·ä¸­çš„vå‰ç¼€
        CURRENT_VERSION_NO_V=${CURRENT_VERSION#v}

        echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION_NO_V"
        echo "æ–°ç‰ˆæœ¬: $VERSION"

        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        NEED_UPDATE=false

        if [ "$CURRENT_VALUE" == "null" ] || [ -z "$CURRENT_VALUE" ]; then
          echo "éœ€è¦æ›´æ–°: ç‰ˆæœ¬è®°å½•ä¸å­˜åœ¨"
          NEED_UPDATE=true
        
        elif [ "$VERSION" != "$CURRENT_VERSION_NO_V" ]; then
          echo "éœ€è¦æ›´æ–°: å‘ç°æ–°ç‰ˆæœ¬ ($CURRENT_VERSION_NO_V â†’ $VERSION)"
          NEED_UPDATE=true
        
        elif [ ! -f "apk/$APK_NAME" ]; then
          echo "éœ€è¦æ›´æ–°: APKæ–‡ä»¶ä¸å­˜åœ¨"
          NEED_UPDATE=true
        else
          echo "æ— éœ€æ›´æ–°: ç‰ˆæœ¬ç›¸åŒä¸”æ–‡ä»¶å­˜åœ¨"
        fi

        if [ "$NEED_UPDATE" = false ]; then
          echo "æ— éœ€æ›´æ–°ï¼Œé€€å‡º"
          exit 0
        fi

        # ä½¿ç”¨cloudscraperä¸‹è½½æ–‡ä»¶
        echo "æ­£åœ¨ä¸‹è½½APKæ–‡ä»¶..."
        cat > "$WORK_DIR/download_file.py" <<EOL
        import cloudscraper
        import sys
        
        scraper = cloudscraper.create_scraper()
        try:
            response = scraper.get(sys.argv[1], stream=True)
            if response.status_code != 200:
                print(f"é”™è¯¯: ä¸‹è½½å¤±è´¥ï¼ŒçŠ¶æ€ç  {response.status_code}", file=sys.stderr)
                sys.exit(1)
                
            with open(sys.argv[2], 'wb') as f:
                for chunk in response.iter_content(chunk_size=8192):
                    if chunk:
                        f.write(chunk)
            
            print(f"ä¸‹è½½å®Œæˆ")
            
        except Exception as e:
            print(f"ä¸‹è½½é”™è¯¯: {str(e)}", file=sys.stderr)
            sys.exit(1)
        EOL
        
        # è¿è¡Œä¸‹è½½è„šæœ¬
        python3 "$WORK_DIR/download_file.py" "$APK_LINK" "$WORK_DIR/temp.apk"
        if [ $? -ne 0 ]; then
          echo "ä¸‹è½½APKå¤±è´¥"
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦åˆç†
        if [ ! -f "$WORK_DIR/temp.apk" ]; then
          echo "é”™è¯¯: APKä¸‹è½½å¤±è´¥ - æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < "$WORK_DIR/temp.apk")
        if [ "$FILE_SIZE" -lt 50000000 ]; then
          echo "é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶å¤§å°($FILE_SIZE å­—èŠ‚)è¿‡å°"
          exit 1
        fi

        # åˆ›å»ºapkç›®å½•
        mkdir -p apk

        # ä¿å­˜å½“å‰ç‰ˆæœ¬
        cp "$WORK_DIR/temp.apk" "apk/$APK_NAME"
        echo "å·²ä¿å­˜APKæ–‡ä»¶ (å¤§å°: $FILE_SIZE å­—èŠ‚)"

        # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        NEW_VALUE="v$VERSION,$RELEASE_DATE"
        NEW_VERSION_JSON=$(echo "$CURRENT_VERSION_JSON" | jq --arg key "$APK_NAME" --arg value "$NEW_VALUE" '.[$key] = $value')
        echo "$NEW_VERSION_JSON" > "$VERSION_FILE"
        echo "æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶"

        # æ·»åŠ æ–‡ä»¶åˆ°Git
        git add apk/ "$VERSION_FILE"

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -z "$(git status --porcelain)" ]; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          exit 0
        fi

        # æäº¤æ›´æ”¹
        git commit -m "æ›´æ–°Plus Messenger: v$VERSION ($RELEASE_DATE)"
        
        # æ¨é€æ›´æ”¹
        echo "æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
        git push origin main

        echo "åŒæ­¥å®Œæˆ! ç‰ˆæœ¬: v$VERSION, æ—¥æœŸ: $RELEASE_DATE"

    - name: Release Repository Lock ğŸ”“
      if: always()
      run: |
        # é‡Šæ”¾é”
        LOCK_FILE="$GITHUB_WORKSPACE/.lock/repo-lock"
        if [ -f "$LOCK_FILE" ]; then
          rm -f "$LOCK_FILE"
          echo "é”å·²é‡Šæ”¾"
        else
          echo "é”æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€é‡Šæ”¾"
        fi

  cleanup_self:
    name: Cleanup Self Workflow History
    runs-on: ubuntu-latest
    needs: sync
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "Plus APK Download and Sync"
          repository: ${{ github.repository }}