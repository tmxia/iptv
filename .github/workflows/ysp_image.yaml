name: Build YSP Multi-Platform Images

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾'
        required: true
        default: 'latest'
      skip_tests:
        description: 'è·³è¿‡é•œåƒæµ‹è¯•'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  PROJECT_DIR: main/ysp

jobs:
  verify-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify project structure
        run: |
          echo "éªŒè¯é¡¹ç›®ç›®å½•ç»“æž„..."
          
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "é”™è¯¯ï¼šç›®å½• $PROJECT_DIR ä¸å­˜åœ¨"
            ls -la
            exit 1
          fi
          
          echo "é¡¹ç›®ç›®å½•å†…å®¹ï¼š"
          ls -la $PROJECT_DIR/
          
          if [ ! -f "$PROJECT_DIR/main.go" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° main.go æ–‡ä»¶"
            exit 1
          fi
          
          if [ ! -f "$PROJECT_DIR/Dockerfile" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° Dockerfile æ–‡ä»¶"
            exit 1
          fi
          
          if [ ! -f "$PROJECT_DIR/go.mod" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° go.mod æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ“ é¡¹ç›®ç»“æž„éªŒè¯é€šè¿‡"

  tidy-modules:
    needs: verify-project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Tidy Go modules
        run: |
          echo "åœ¨ç›®å½• $PROJECT_DIR ä¸­æ•´ç†Goæ¨¡å—..."
          cd $PROJECT_DIR
          
          # æ˜¾ç¤ºå½“å‰go.modå†…å®¹
          echo "å½“å‰go.mod:"
          head -20 go.mod
          
          # æ•´ç†æ¨¡å—
          go mod tidy
          
          echo "æ•´ç†åŽçš„go.mod:"
          head -20 go.mod
          
          # æ˜¾ç¤ºå·®å¼‚
          git status
          git diff go.mod go.sum || echo "æ¨¡å—æ–‡ä»¶æœ‰æ›´æ–°"

      - name: Upload Go modules
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: go-modules
          path: $PROJECT_DIR/go.*
          retention-days: 7

  build-multi-platform:
    needs: [verify-project, tidy-modules]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
            govariant: ""
          - name: linux/arm64
            target: aarch64
            goarch: arm64
            govariant: ""
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log platform info
        run: |
          echo "æž„å»ºå¹³å°: ${{ matrix.platform.name }}"
          echo "ç›®æ ‡å¹³å°: ${{ matrix.platform.target }}"
          echo "Goæž¶æž„: ${{ matrix.platform.goarch }}"
          echo "Goå˜ä½“: ${{ matrix.platform.govariant }}"

      - name: Build Docker image
        run: |
          cd $PROJECT_DIR
          
          echo "ä½¿ç”¨é¡¹ç›®ä¸­çš„Dockerfileæž„å»ºé•œåƒ..."
          echo "Dockerfileå†…å®¹é¢„è§ˆ:"
          head -20 Dockerfile
          
          # æž„å»ºå¹¶å¯¼å‡ºä¸ºtaræ–‡ä»¶
          docker buildx build \
            --platform ${{ matrix.platform.name }} \
            --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar \
            -t ysp:${{ matrix.platform.target }} \
            -t ysp:${{ github.event.inputs.version }}-${{ matrix.platform.target }} \
            --build-arg TARGETARCH=${{ matrix.platform.goarch }} \
            --build-arg TARGETVARIANT=${{ matrix.platform.govariant }} \
            .
          
          echo "é•œåƒæž„å»ºå®Œæˆï¼Œå¤§å°:"
          ls -lh ysp-${{ matrix.platform.target }}.tar

      - name: Test Docker image
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: |
          cd $PROJECT_DIR
          
          echo "æµ‹è¯• ${{ matrix.platform.name }} é•œåƒ..."
          
          # åŠ è½½é•œåƒ
          docker load -i ysp-${{ matrix.platform.target }}.tar
          
          # å¯åŠ¨æµ‹è¯•å®¹å™¨ï¼ˆä½¿ç”¨ä¸åŒçš„ç«¯å£é¿å…å†²çªï¼‰
          TEST_PORT=$((9824 + RANDOM % 1000))
          echo "ä½¿ç”¨ç«¯å£ $TEST_PORT è¿›è¡Œæµ‹è¯•..."
          
          docker run -d \
            --name ysp-test-${{ matrix.platform.target }} \
            -p $TEST_PORT:9824 \
            ysp:${{ matrix.platform.target }}
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          for i in {1..10}; do
            if curl -s -f http://localhost:$TEST_PORT/ > /dev/null 2>&1; then
              echo "âœ“ æœåŠ¡åœ¨ç¬¬ $i ç§’å¯åŠ¨æˆåŠŸ"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âœ— æœåŠ¡å¯åŠ¨å¤±è´¥"
              docker logs ysp-test-${{ matrix.platform.target }}
              exit 1
            fi
            sleep 2
          done
          
          # æµ‹è¯•M3Uåˆ—è¡¨
          echo "æµ‹è¯•M3Uåˆ—è¡¨..."
          if curl -s -f http://localhost:$TEST_PORT/ysp.m3u | grep -q "#EXTM3U"; then
            echo "âœ“ M3Uåˆ—è¡¨æ­£å¸¸"
          else
            echo "âœ— M3Uåˆ—è¡¨èŽ·å–å¤±è´¥"
            exit 1
          fi
          
          # åœæ­¢å¹¶æ¸…ç†æµ‹è¯•å®¹å™¨
          docker stop ysp-test-${{ matrix.platform.target }}
          docker rm ysp-test-${{ matrix.platform.target }}
          
          echo "âœ“ é•œåƒæµ‹è¯•é€šè¿‡"

      - name: Save image to project directory
        run: |
          cd $PROJECT_DIR
          
          # åˆ›å»ºimagesç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
          mkdir -p images
          
          # ç§»åŠ¨é•œåƒæ–‡ä»¶åˆ°imagesç›®å½•
          mv ysp-${{ matrix.platform.target }}.tar images/
          
          # æ˜¾ç¤ºä¿å­˜çš„æ–‡ä»¶
          echo "å·²ä¿å­˜çš„é•œåƒæ–‡ä»¶:"
          ls -lh images/

      - name: Upload platform image
        uses: actions/upload-artifact@v4
        with:
          name: ysp-${{ matrix.platform.target }}-image
          path: $PROJECT_DIR/images/ysp-${{ matrix.platform.target }}.tar
          retention-days: 30

  create-release-package:
    needs: build-multi-platform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all platform images
        run: |
          mkdir -p release-images
          
          # ç”±äºŽartifactsä¸‹è½½æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘ä»¬ç›´æŽ¥ä»Žé¡¹ç›®ç›®å½•å¤åˆ¶
          # è¿™æ­¥ä¾èµ–äºŽä¸Šä¸€æ­¥çš„ä¿å­˜æ“ä½œ
          if [ -d "$PROJECT_DIR/images" ]; then
            cp $PROJECT_DIR/images/*.tar release-images/ 2>/dev/null || true
          fi
          
          echo "å·²ä¸‹è½½çš„é•œåƒæ–‡ä»¶:"
          ls -lh release-images/ || echo "æœªæ‰¾åˆ°é•œåƒæ–‡ä»¶"

      - name: Create README and metadata
        run: |
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          cat > release-images/VERSION.md << EOF
          # YSP Server å¤šå¹³å°é•œåƒ
          
          ç‰ˆæœ¬: ${{ github.event.inputs.version }}
          æž„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          æž„å»ºID: ${{ github.run_id }}
          æäº¤: ${{ github.sha }}
          
          åŒ…å«ä»¥ä¸‹å¹³å°é•œåƒ:
          EOF
          
          # æ·»åŠ å„å¹³å°ä¿¡æ¯
          for file in release-images/*.tar 2>/dev/null; do
            if [ -f "$file" ]; then
              basename=$(basename "$file" .tar)
              echo "- $basename.tar" >> release-images/VERSION.md
            fi
          done
          
          # åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
          cat >> release-images/VERSION.md << 'EOF'
          
          ## ä½¿ç”¨æ–¹æ³•
          
          1. åŠ è½½é•œåƒåˆ° Docker:
             ```bash
             docker load -i ysp-x86_64.tar
             ```
          
          2. è¿è¡Œå®¹å™¨:
             ```bash
             docker run -d -p 9824:9824 --name ysp-server ysp:x86_64
             ```
          
          3. è®¿é—®æœåŠ¡:
             - M3Uæ’­æ”¾åˆ—è¡¨: http://localhost:9824/ysp.m3u
             - Webç•Œé¢: http://localhost:9824/
             - å•ä¸ªé¢‘é“: http://localhost:9824/ysp?id=cctv1
          
          4. åœæ­¢å®¹å™¨:
             ```bash
             docker stop ysp-server
             docker rm ysp-server
             ```
          
          ## æ”¯æŒçš„å‘½ä»¤è¡Œå‚æ•°
          
          ```bash
          # æŒ‡å®šä¸»æœºIP
          docker run -d -p 9824:9824 --name ysp-server ysp:x86_64 --host=0.0.0.0
          
          # é€šè¿‡çŽ¯å¢ƒå˜é‡æŒ‡å®šä¸»æœºIP
          docker run -d -p 9824:9824 -e HOST_IP=0.0.0.0 --name ysp-server ysp:x86_64
          ```
          
          ## é¢‘é“åˆ—è¡¨
          
          åŒ…å«CCTVå…¨å¥—é¢‘é“å’Œå„çœå«è§†ï¼Œå…±60+ä¸ªé¢‘é“ã€‚
          EOF
          
          # åˆ›å»ºç®€å•çš„åŠ è½½è„šæœ¬
          cat > release-images/load-images.sh << 'EOF'
          #!/bin/bash
          # YSPé•œåƒåŠ è½½è„šæœ¬
          
          echo "åŠ è½½YSP Dockeré•œåƒ..."
          
          for img in *.tar; do
            if [ -f "$img" ]; then
              echo "æ­£åœ¨åŠ è½½ $img..."
              docker load -i "$img"
            fi
          done
          
          echo "æ‰€æœ‰é•œåƒåŠ è½½å®Œæˆ!"
          echo "å¯ç”¨é•œåƒæ ‡ç­¾:"
          docker images | grep ysp
          
          echo ""
          echo "è¿è¡Œç¤ºä¾‹:"
          echo "  docker run -d -p 9824:9824 --name ysp-server ysp:x86_64"
          EOF
          
          chmod +x release-images/load-images.sh
          
          # æ˜¾ç¤ºæœ€ç»ˆå†…å®¹
          echo "å‘å¸ƒåŒ…å†…å®¹:"
          ls -la release-images/

      - name: Upload final release package
        uses: actions/upload-artifact@v4
        with:
          name: ysp-release-${{ github.event.inputs.version }}
          path: release-images/
          retention-days: 90

  summary:
    needs: [create-release-package, build-multi-platform]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate build summary
        run: |
          echo "## ðŸŽ‰ YSPå¤šå¹³å°é•œåƒæž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**æž„å»ºæ—¶é—´:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **å®Œæ•´å‘å¸ƒåŒ…** (ysp-release-${{ github.event.inputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "   - åŒ…å«æ‰€æœ‰å¹³å°é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "   - ä½¿ç”¨è¯´æ˜Žæ–‡æ¡£" >> $GITHUB_STEP_SUMMARY
          echo "   - ä¸€é”®åŠ è½½è„šæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **å„å¹³å°ç‹¬ç«‹é•œåƒ**" >> $GITHUB_STEP_SUMMARY
          echo "   - ysp-x86_64-image (Linux AMD64)" >> $GITHUB_STEP_SUMMARY
          echo "   - ysp-aarch64-image (Linux ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "   - ysp-armv7-image (Linux ARMv7)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Goæ¨¡å—æ–‡ä»¶** (go-modules)" >> $GITHUB_STEP_SUMMARY
          echo "   - æ•´ç†åŽçš„go.modå’Œgo.sum" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ é•œåƒä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# 1. ä¸‹è½½å‘å¸ƒåŒ…å¹¶è§£åŽ‹" >> $GITHUB_STEP_SUMMARY
          echo "# 2. åŠ è½½é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "docker load -i ysp-x86_64.tar" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 3. è¿è¡Œå®¹å™¨" >> $GITHUB_STEP_SUMMARY
          echo "docker run -d -p 9824:9824 --name ysp-server ysp:x86_64" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ é•œåƒä½ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "é•œåƒæ–‡ä»¶å·²ä¿å­˜åœ¨: **$PROJECT_DIR/images/**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ æž„å»ºé…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- é¡¹ç›®ç›®å½•: $PROJECT_DIR" >> $GITHUB_STEP_SUMMARY
          echo "- è·³è¿‡æµ‹è¯•: ${{ github.event.inputs.skip_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "- é•œåƒæ•°é‡: 3 (x86_64, aarch64, armv7)" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºçŠ¶æ€
          if [ "${{ job.status }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… æ‰€æœ‰æž„å»ºä»»åŠ¡æˆåŠŸå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ æž„å»ºè¿‡ç¨‹å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi
