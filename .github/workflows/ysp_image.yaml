name: Build YSP Multi-Platform Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: '镜像版本标签'
        required: true
        default: 'latest'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Initialize Go module
        run: |
          cd ysp
          
          # 创建go.mod
          if [ ! -f "go.mod" ]; then
            echo "module ysp" > go.mod
            echo "go 1.21" >> go.mod
            echo "" >> go.mod
            echo "require (" >> go.mod
            echo "    github.com/gorilla/mux v1.8.1" >> go.mod
            echo "    golang.org/x/crypto v0.17.0" >> go.mod
            echo "    github.com/stretchr/testify v1.8.4" >> go.mod
            echo ")" >> go.mod
          fi
          
          # 创建go.sum（如果不存在）
          if [ ! -f "go.sum" ]; then
            touch go.sum
          fi
          
          # 下载依赖
          go mod download 2>/dev/null || true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd ysp
          
          # 构建参数
          BUILD_ARGS=""
          if [ "${{ matrix.platform.govariant }}" != "" ]; then
            BUILD_ARGS="--build-arg TARGETVARIANT=${{ matrix.platform.govariant }}"
          fi
          
          echo "正在构建 ${{ matrix.platform.name }} 镜像..."
          
          # 构建镜像（不使用缓存以加速）
          docker buildx build \
            --platform ${{ matrix.platform.name }} \
            --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar \
            -t ysp:${{ matrix.platform.target }} \
            --build-arg TARGETARCH=${{ matrix.platform.goarch }} \
            --no-cache \
            $BUILD_ARGS \
            .
          
          echo "镜像构建完成"
          ls -lh ysp-${{ matrix.platform.target }}.tar

      - name: Save images
        run: |
          cd ysp
          
          # 创建images目录
          mkdir -p images
          
          # 复制镜像文件
          cp ysp-${{ matrix.platform.target }}.tar images/
          
          # 创建SHA256校验和
          sha256sum images/ysp-${{ matrix.platform.target }}.tar > images/ysp-${{ matrix.platform.target }}.tar.sha256
          
          echo "镜像已保存到 ysp/images/"
          ls -lh images/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ysp-${{ matrix.platform.target }}
          path: ysp/images/ysp-${{ matrix.platform.target }}.tar
          retention-days: 30