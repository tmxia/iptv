name: Build YSP Multi-Platform Images

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾'
        required: true
        default: 'latest'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      project_exists: ${{ steps.check.outputs.project_exists }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: source

      - name: Check project structure
        id: check
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ç›®å½•ç»“æž„:"
          ls -la
          
          echo "æ£€æŸ¥sourceç›®å½•:"
          ls -la source/
          
          # æ£€æŸ¥yspç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "source/ysp" ]; then
            echo "æ‰¾åˆ°yspç›®å½•"
            echo "é¡¹ç›®ç›®å½•å†…å®¹:"
            ls -la source/ysp/
            
            # æ£€æŸ¥å¿…è¦æ–‡ä»¶ï¼Œåªæ£€æŸ¥main.goå’ŒDockerfile
            if [ -f "source/ysp/main.go" ] && [ -f "source/ysp/Dockerfile" ]; then
              echo "âœ“ ä¸»è¦æ–‡ä»¶éƒ½å­˜åœ¨"
              echo "project_exists=true" >> $GITHUB_OUTPUT
            else
              echo "é”™è¯¯ï¼šç¼ºå°‘å¿…è¦æ–‡ä»¶"
              echo "main.go å­˜åœ¨: $([ -f "source/ysp/main.go" ] && echo "æ˜¯" || echo "å¦")"
              echo "Dockerfile å­˜åœ¨: $([ -f "source/ysp/Dockerfile" ] && echo "æ˜¯" || echo "å¦")"
              echo "project_exists=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°yspç›®å½•"
            echo "project_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  init-go-module:
    needs: setup
    if: needs.setup.outputs.project_exists == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: source

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Initialize Go module
        run: |
          cd source/ysp
          echo "åˆå§‹åŒ–Goæ¨¡å—..."
          
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰go.mod
          if [ ! -f "go.mod" ]; then
            echo "go.modä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            
            # ä»Žmain.goä¸­æå–æ¨¡å—åï¼ˆä½¿ç”¨é»˜è®¤çš„yspï¼‰
            MODULE_NAME="ysp"
            
            # åˆ›å»ºgo.modæ–‡ä»¶
            echo "module $MODULE_NAME" > go.mod
            echo "" >> go.mod
            echo "go 1.21" >> go.mod
            echo "" >> go.mod
            echo "require (" >> go.mod
            echo ")" >> go.mod
            
            echo "åˆ›å»ºçš„go.modå†…å®¹:"
            cat go.mod
            
            # æ£€æŸ¥main.goä¸­çš„importï¼Œå°è¯•æ·»åŠ ä¾èµ–
            echo "åˆ†æžmain.goä¸­çš„å¯¼å…¥..."
            IMPORTS=$(grep -E '^\s*import' main.go | grep -o '\"[^\"]*\"' | tr -d '"' || true)
            
            if [ ! -z "$IMPORTS" ]; then
              echo "æ‰¾åˆ°å¯¼å…¥:"
              echo "$IMPORTS"
              
              # æ·»åŠ å¸¸è§ä¾èµ–
              echo "æ·»åŠ å¿…è¦ä¾èµ–..."
              go get github.com/gorilla/mux 2>/dev/null || true
              go get golang.org/x/crypto 2>/dev/null || true
              go get github.com/stretchr/testify 2>/dev/null || true
            fi
            
            # è¿è¡Œgo mod tidy
            echo "è¿è¡Œgo mod tidy..."
            go mod tidy || echo "go mod tidyå¯èƒ½æœ‰ä¸€äº›è­¦å‘Š"
          else
            echo "go.modå·²å­˜åœ¨ï¼Œå†…å®¹:"
            cat go.mod
          fi
          
          echo "æœ€ç»ˆgo.mod:"
          cat go.mod
          echo ""
          echo "go.sumçŠ¶æ€:"
          ls -la go.sum 2>/dev/null || echo "go.sumä¸å­˜åœ¨"

      - name: Upload Go module files
        uses: actions/upload-artifact@v4
        with:
          name: go-module-files
          path: source/ysp/go.*
          retention-days: 7

  build:
    needs: [setup, init-go-module]
    if: needs.setup.outputs.project_exists == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: source

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Navigate to project directory
        run: |
          echo "åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•..."
          cd source/ysp
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "é¡¹ç›®æ–‡ä»¶åˆ—è¡¨:"
          ls -la

      - name: Ensure Go module is ready
        run: |
          cd source/ysp
          
          # ç¡®ä¿go.modå­˜åœ¨
          if [ ! -f "go.mod" ]; then
            echo "é”™è¯¯ï¼šgo.modæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "go.modå†…å®¹:"
          cat go.mod
          
          echo "è¿è¡Œgo mod tidyç¡®ä¿ä¾èµ–æ­£ç¡®..."
          go mod tidy
          
          echo "ä¾èµ–åˆ—è¡¨:"
          go list -m all 2>/dev/null | head -20

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd source/ysp
          
          echo "æž„å»º ${{ matrix.platform.name }} é•œåƒ..."
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          
          # æž„å»ºå‚æ•°
          BUILD_ARGS=""
          if [ "${{ matrix.platform.govariant }}" != "" ]; then
            BUILD_ARGS="--build-arg TARGETVARIANT=${{ matrix.platform.govariant }}"
          fi
          
          echo "æž„å»ºå‘½ä»¤:"
          echo "docker buildx build --platform ${{ matrix.platform.name }} --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar -t ysp:${{ matrix.platform.target }} --build-arg TARGETARCH=${{ matrix.platform.goarch }} $BUILD_ARGS ."
          
          # æž„å»ºé•œåƒå¹¶å¯¼å‡ºä¸ºtaræ–‡ä»¶
          docker buildx build \
            --platform ${{ matrix.platform.name }} \
            --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar \
            -t ysp:${{ matrix.platform.target }} \
            -t ysp:${{ github.event.inputs.version }}-${{ matrix.platform.target }} \
            --build-arg TARGETARCH=${{ matrix.platform.goarch }} \
            $BUILD_ARGS \
            .
          
          echo "é•œåƒæž„å»ºå®Œæˆ:"
          ls -lh ysp-${{ matrix.platform.target }}.tar

      - name: Test Docker image
        run: |
          cd source/ysp
          
          echo "æµ‹è¯• ${{ matrix.platform.name }} é•œåƒ..."
          
          # åŠ è½½é•œåƒ
          docker load -i ysp-${{ matrix.platform.target }}.tar
          
          # ç”Ÿæˆéšæœºç«¯å£é¿å…å†²çª
          TEST_PORT=$((9824 + RANDOM % 5000 + 1000))
          echo "ä½¿ç”¨ç«¯å£ $TEST_PORT è¿›è¡Œæµ‹è¯•"
          
          # å¯åŠ¨å®¹å™¨
          docker run -d \
            --name ysp-test-${{ matrix.platform.target }} \
            -p $TEST_PORT:9824 \
            -e HOST_IP=0.0.0.0 \
            ysp:${{ matrix.platform.target }}
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          MAX_WAIT=30
          for i in $(seq 1 $MAX_WAIT); do
            if curl -s -f http://localhost:$TEST_PORT/ > /dev/null 2>&1; then
              echo "âœ“ æœåŠ¡åœ¨ç¬¬ $i ç§’å¯åŠ¨æˆåŠŸ"
              break
            fi
            if [ $i -eq $MAX_WAIT ]; then
              echo "âœ— æœåŠ¡å¯åŠ¨è¶…æ—¶"
              echo "å®¹å™¨æ—¥å¿—:"
              docker logs ysp-test-${{ matrix.platform.target }}
              exit 1
            fi
            sleep 1
          done
          
          # æµ‹è¯•M3Uç«¯ç‚¹
          echo "æµ‹è¯•M3Uç«¯ç‚¹..."
          M3U_CONTENT=$(curl -s http://localhost:$TEST_PORT/ysp.m3u | head -3)
          if echo "$M3U_CONTENT" | grep -q "#EXTM3U"; then
            echo "âœ“ M3Uç«¯ç‚¹æ­£å¸¸"
            echo "M3Uå‰3è¡Œ:"
            echo "$M3U_CONTENT"
          else
            echo "âœ— M3Uç«¯ç‚¹å¼‚å¸¸ï¼Œè¿”å›žå†…å®¹:"
            echo "$M3U_CONTENT"
            exit 1
          fi
          
          # æµ‹è¯•æ ¹ç«¯ç‚¹
          echo "æµ‹è¯•æ ¹ç«¯ç‚¹..."
          ROOT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$TEST_PORT/)
          if [ "$ROOT_STATUS" = "200" ]; then
            echo "âœ“ æ ¹ç«¯ç‚¹æ­£å¸¸ï¼ŒçŠ¶æ€ç : $ROOT_STATUS"
          else
            echo "âœ— æ ¹ç«¯ç‚¹å¼‚å¸¸ï¼ŒçŠ¶æ€ç : $ROOT_STATUS"
          fi
          
          # åœæ­¢å¹¶æ¸…ç†æµ‹è¯•å®¹å™¨
          docker stop ysp-test-${{ matrix.platform.target }}
          docker rm ysp-test-${{ matrix.platform.target }}
          
          echo "âœ“ æµ‹è¯•é€šè¿‡"

      - name: Save image locally
        run: |
          cd source/ysp
          
          # åˆ›å»ºimagesç›®å½•
          mkdir -p images
          
          # å¤åˆ¶é•œåƒæ–‡ä»¶åˆ°imagesç›®å½•
          cp ysp-${{ matrix.platform.target }}.tar images/
          
          # åˆ›å»ºSHA256æ ¡éªŒå’Œ
          sha256sum images/ysp-${{ matrix.platform.target }}.tar > images/ysp-${{ matrix.platform.target }}.tar.sha256
          
          echo "é•œåƒæ–‡ä»¶å·²ä¿å­˜:"
          ls -lh images/

      - name: Upload platform image
        uses: actions/upload-artifact@v4
        with:
          name: ysp-${{ matrix.platform.target }}-image
          path: source/ysp/images/ysp-${{ matrix.platform.target }}.tar
          retention-days: 30

  package:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Create release package
        run: |
          mkdir -p release-package
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          cat > release-package/README.md << "DOC_EOF"
# YSP Server å¤šå¹³å°Dockeré•œåƒ

ç‰ˆæœ¬: ${{ github.event.inputs.version }}
æž„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
æž„å»ºID: ${{ github.run_id }}
æäº¤: ${{ github.sha }}

## åŒ…å«çš„é•œåƒæ–‡ä»¶

1. **ysp-x86_64.tar** - Linux amd64/x86_64 å¹³å°
2. **ysp-aarch64.tar** - Linux arm64/aarch64 å¹³å°  
3. **ysp-armv7.tar** - Linux arm/v7 å¹³å°

æ¯ä¸ªé•œåƒæ–‡ä»¶éƒ½åŒ…å«å¯¹åº”çš„SHA256æ ¡éªŒå’Œæ–‡ä»¶ã€‚

## ä¸‹è½½åœ°å€

è¯·è®¿é—®GitHub Actionsçš„Artifactséƒ¨åˆ†ä¸‹è½½ï¼š

1. å‰å¾€æ­¤å·¥ä½œæµçš„è¿è¡Œé¡µé¢
2. åœ¨"Artifacts"éƒ¨åˆ†æ‰¾åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š
   - ysp-x86_64-image
   - ysp-aarch64-image  
   - ysp-armv7-image

## ä½¿ç”¨æ–¹æ³•

### 1. åŠ è½½é•œåƒ
\`\`\`bash
# åŠ è½½amd64é•œåƒ
docker load -i ysp-x86_64.tar
\`\`\`

### 2. è¿è¡Œå®¹å™¨
\`\`\`bash
# è¿è¡ŒæœåŠ¡
docker run -d \
  -p 9824:9824 \
  --name ysp-server \
  ysp:x86_64

# æŒ‡å®šä¸»æœºIP
docker run -d \
  -p 9824:9824 \
  -e HOST_IP=0.0.0.0 \
  --name ysp-server \
  ysp:x86_64
\`\`\`

### 3. è®¿é—®æœåŠ¡

- **æ’­æ”¾åˆ—è¡¨**: http://localhost:9824/ysp.m3u
- **Webç•Œé¢**: http://localhost:9824/
- **å•ä¸ªé¢‘é“**: http://localhost:9824/ysp?id=cctv1

### 4. åœæ­¢æœåŠ¡
\`\`\`bash
docker stop ysp-server
docker rm ysp-server
\`\`\`

## é¢‘é“åˆ—è¡¨

åŒ…å«CCTVå…¨å¥—é¢‘é“å’Œå„çœå«è§†ï¼Œå…±60+ä¸ªé¢‘é“ã€‚
DOC_EOF
          
          # åˆ›å»ºåŠ è½½è„šæœ¬
          cat > release-package/load-all.sh << "SCRIPT_EOF"
#!/bin/bash
# YSP Server Dockeré•œåƒæ‰¹é‡åŠ è½½è„šæœ¬

set -e

echo "=== YSP Server é•œåƒåŠ è½½å·¥å…· ==="
echo ""

# æ£€æŸ¥Dockeræ˜¯å¦è¿è¡Œ
if ! docker info > /dev/null 2>&1; then
  echo "é”™è¯¯: Dockerå®ˆæŠ¤è¿›ç¨‹æœªè¿è¡Œ"
  exit 1
fi

echo "å¼€å§‹åŠ è½½é•œåƒ..."
echo ""

# åŠ è½½æ‰€æœ‰æ‰¾åˆ°çš„taræ–‡ä»¶
for img in *.tar; do
  if [ -f "$img" ]; then
    echo "åŠ è½½ $img..."
    docker load -i "$img"
    echo "âœ“ $img åŠ è½½å®Œæˆ"
    echo ""
  fi
done

echo "=== åŠ è½½å®Œæˆ ==="
echo ""
echo "å¯ç”¨é•œåƒ:"
docker images | grep "ysp" | sort

echo ""
echo "è¿è¡Œç¤ºä¾‹:"
echo "  docker run -d -p 9824:9824 --name ysp-server ysp:x86_64"
echo ""
SCRIPT_EOF
          
          chmod +x release-package/load-all.sh
          
          echo "å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ:"
          ls -la release-package/

      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: ysp-release-package-${{ github.event.inputs.version }}
          path: release-package/
          retention-days: 30

  summary:
    needs: [setup, init-go-module, build, package]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate build summary
        run: |
          echo "# ðŸ³ YSP Server å¤šå¹³å°é•œåƒæž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“‹ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡ŒID**: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ–¥ï¸ æž„å»ºå¹³å°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux amd64/x86_64 | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux arm64/aarch64 | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux arm/v7 | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "åœ¨æœ¬æ¬¡å·¥ä½œæµçš„ **Artifacts** éƒ¨åˆ†å¯ä»¥ä¸‹è½½ä»¥ä¸‹æ–‡ä»¶ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **å„å¹³å°é•œåƒæ–‡ä»¶**: " >> $GITHUB_STEP_SUMMARY
          echo "   - \`ysp-x86_64-image\` - AMD64å¹³å°é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "   - \`ysp-aarch64-image\` - ARM64å¹³å°é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "   - \`ysp-armv7-image\` - ARMv7å¹³å°é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **æ ¡éªŒå’Œæ–‡ä»¶**: " >> $GITHUB_STEP_SUMMARY
          echo "   - æ¯ä¸ªé•œåƒéƒ½åŒ…å«å¯¹åº”çš„SHA256æ ¡éªŒæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **å‘å¸ƒåŒ…**: " >> $GITHUB_STEP_SUMMARY
          echo "   - \`ysp-release-package-${{ github.event.inputs.version }}\` - åŒ…å«ä½¿ç”¨è¯´æ˜Žå’Œå·¥å…·çš„å®Œæ•´åŒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "4. **Goæ¨¡å—æ–‡ä»¶**: " >> $GITHUB_STEP_SUMMARY
          echo "   - \`go-module-files\` - è‡ªåŠ¨ç”Ÿæˆçš„go.modå’Œgo.sum" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸš€ å¿«é€Ÿå¼€å§‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# 1. ä¸‹è½½å¹¶è§£åŽ‹é•œåƒæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "# 2. åŠ è½½é•œåƒåˆ°Docker" >> $GITHUB_STEP_SUMMARY
          echo "docker load -i ysp-x86_64.tar" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 3. è¿è¡ŒæœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "docker run -d -p 9824:9824 --name ysp-server ysp:x86_64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 4. è®¿é—®æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "curl http://localhost:9824/ysp.m3u" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "## âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰å¹³å°çš„Dockeré•œåƒå·²æˆåŠŸæž„å»ºå¹¶é€šè¿‡æµ‹è¯•ï¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "é•œåƒæ–‡ä»¶å·²ä¿å­˜åˆ°é¡¹ç›®ç›®å½•: **ysp/images/**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ æž„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æž„å»ºè¿‡ç¨‹ä¸­å‡ºçŽ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
