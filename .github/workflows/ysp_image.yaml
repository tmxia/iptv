name: Build YSP Multi-Platform Images

on:
  workflow_dispatch:  # 仅手动触发
    inputs:
      version:
        description: '镜像版本标签'
        required: true
        default: 'latest'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      project_exists: ${{ steps.check.outputs.project_exists }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: source

      - name: Check project structure
        id: check
        run: |
          echo "当前工作目录: $(pwd)"
          echo "目录结构:"
          ls -la
          
          echo "检查source目录:"
          ls -la source/
          
          # 检查ysp目录是否存在
          if [ -d "source/ysp" ]; then
            echo "找到ysp目录"
            echo "项目目录内容:"
            ls -la source/ysp/
            
            # 检查必要文件，只检查main.go和Dockerfile
            if [ -f "source/ysp/main.go" ] && [ -f "source/ysp/Dockerfile" ]; then
              echo "✓ 主要文件都存在"
              echo "project_exists=true" >> $GITHUB_OUTPUT
            else
              echo "错误：缺少必要文件"
              echo "main.go 存在: $([ -f "source/ysp/main.go" ] && echo "是" || echo "否")"
              echo "Dockerfile 存在: $([ -f "source/ysp/Dockerfile" ] && echo "是" || echo "否")"
              echo "project_exists=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "错误：未找到ysp目录"
            echo "project_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  init-go-module:
    needs: setup
    if: needs.setup.outputs.project_exists == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: source

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Initialize Go module
        run: |
          cd source/ysp
          echo "初始化Go模块..."
          
          # 检查是否已有go.mod
          if [ ! -f "go.mod" ]; then
            echo "go.mod不存在，正在创建..."
            
            # 从main.go中提取模块名（使用默认的ysp）
            MODULE_NAME="ysp"
            
            # 创建go.mod文件
            echo "module $MODULE_NAME" > go.mod
            echo "" >> go.mod
            echo "go 1.21" >> go.mod
            echo "" >> go.mod
            echo "require (" >> go.mod
            echo ")" >> go.mod
            
            echo "创建的go.mod内容:"
            cat go.mod
            
            # 检查main.go中的import，尝试添加依赖
            echo "分析main.go中的导入..."
            IMPORTS=$(grep -E '^\s*import' main.go | grep -o '\"[^\"]*\"' | tr -d '"' || true)
            
            if [ ! -z "$IMPORTS" ]; then
              echo "找到导入:"
              echo "$IMPORTS"
              
              # 添加常见依赖
              echo "添加必要依赖..."
              go get github.com/gorilla/mux 2>/dev/null || true
              go get golang.org/x/crypto 2>/dev/null || true
              go get github.com/stretchr/testify 2>/dev/null || true
            fi
            
            # 运行go mod tidy
            echo "运行go mod tidy..."
            go mod tidy || echo "go mod tidy可能有一些警告"
          else
            echo "go.mod已存在，内容:"
            cat go.mod
          fi
          
          echo "最终go.mod:"
          cat go.mod
          echo ""
          echo "go.sum状态:"
          ls -la go.sum 2>/dev/null || echo "go.sum不存在"

      - name: Upload Go module files
        uses: actions/upload-artifact@v4
        with:
          name: go-module-files
          path: source/ysp/go.*
          retention-days: 7

  build:
    needs: [setup, init-go-module]
    if: needs.setup.outputs.project_exists == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - name: linux/amd64
            target: x86_64
            goarch: amd64
          - name: linux/arm64
            target: aarch64
            goarch: arm64
          - name: linux/arm/v7
            target: armv7
            goarch: arm
            govariant: v7
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: source

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Navigate to project directory
        run: |
          echo "切换到项目目录..."
          cd source/ysp
          echo "当前目录: $(pwd)"
          echo "项目文件列表:"
          ls -la

      - name: Ensure Go module is ready
        run: |
          cd source/ysp
          
          # 确保go.mod存在
          if [ ! -f "go.mod" ]; then
            echo "错误：go.mod文件不存在"
            exit 1
          fi
          
          echo "go.mod内容:"
          cat go.mod
          
          echo "运行go mod tidy确保依赖正确..."
          go mod tidy
          
          echo "依赖列表:"
          go list -m all 2>/dev/null | head -20

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd source/ysp
          
          echo "构建 ${{ matrix.platform.name }} 镜像..."
          echo "当前目录内容:"
          ls -la
          
          # 构建参数
          BUILD_ARGS=""
          if [ "${{ matrix.platform.govariant }}" != "" ]; then
            BUILD_ARGS="--build-arg TARGETVARIANT=${{ matrix.platform.govariant }}"
          fi
          
          echo "构建命令:"
          echo "docker buildx build --platform ${{ matrix.platform.name }} --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar -t ysp:${{ matrix.platform.target }} --build-arg TARGETARCH=${{ matrix.platform.goarch }} $BUILD_ARGS ."
          
          # 构建镜像并导出为tar文件
          docker buildx build \
            --platform ${{ matrix.platform.name }} \
            --output type=docker,dest=./ysp-${{ matrix.platform.target }}.tar \
            -t ysp:${{ matrix.platform.target }} \
            -t ysp:${{ github.event.inputs.version }}-${{ matrix.platform.target }} \
            --build-arg TARGETARCH=${{ matrix.platform.goarch }} \
            $BUILD_ARGS \
            .
          
          echo "镜像构建完成:"
          ls -lh ysp-${{ matrix.platform.target }}.tar

      - name: Test Docker image
        run: |
          cd source/ysp
          
          echo "测试 ${{ matrix.platform.name }} 镜像..."
          
          # 加载镜像
          docker load -i ysp-${{ matrix.platform.target }}.tar
          
          # 生成随机端口避免冲突
          TEST_PORT=$((9824 + RANDOM % 5000 + 1000))
          echo "使用端口 $TEST_PORT 进行测试"
          
          # 启动容器
          docker run -d \
            --name ysp-test-${{ matrix.platform.target }} \
            -p $TEST_PORT:9824 \
            -e HOST_IP=0.0.0.0 \
            ysp:${{ matrix.platform.target }}
          
          # 等待服务启动
          echo "等待服务启动..."
          MAX_WAIT=30
          for i in $(seq 1 $MAX_WAIT); do
            if curl -s -f http://localhost:$TEST_PORT/ > /dev/null 2>&1; then
              echo "✓ 服务在第 $i 秒启动成功"
              break
            fi
            if [ $i -eq $MAX_WAIT ]; then
              echo "✗ 服务启动超时"
              echo "容器日志:"
              docker logs ysp-test-${{ matrix.platform.target }}
              exit 1
            fi
            sleep 1
          done
          
          # 测试M3U端点
          echo "测试M3U端点..."
          M3U_CONTENT=$(curl -s http://localhost:$TEST_PORT/ysp.m3u | head -3)
          if echo "$M3U_CONTENT" | grep -q "#EXTM3U"; then
            echo "✓ M3U端点正常"
            echo "M3U前3行:"
            echo "$M3U_CONTENT"
          else
            echo "✗ M3U端点异常，返回内容:"
            echo "$M3U_CONTENT"
            exit 1
          fi
          
          # 测试根端点
          echo "测试根端点..."
          ROOT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$TEST_PORT/)
          if [ "$ROOT_STATUS" = "200" ]; then
            echo "✓ 根端点正常，状态码: $ROOT_STATUS"
          else
            echo "✗ 根端点异常，状态码: $ROOT_STATUS"
          fi
          
          # 停止并清理测试容器
          docker stop ysp-test-${{ matrix.platform.target }}
          docker rm ysp-test-${{ matrix.platform.target }}
          
          echo "✓ 测试通过"

      - name: Save image locally
        run: |
          cd source/ysp
          
          # 创建images目录
          mkdir -p images
          
          # 复制镜像文件到images目录
          cp ysp-${{ matrix.platform.target }}.tar images/
          
          # 创建SHA256校验和
          sha256sum images/ysp-${{ matrix.platform.target }}.tar > images/ysp-${{ matrix.platform.target }}.tar.sha256
          
          echo "镜像文件已保存:"
          ls -lh images/

      - name: Upload platform image
        uses: actions/upload-artifact@v4
        with:
          name: ysp-${{ matrix.platform.target }}-image
          path: source/ysp/images/ysp-${{ matrix.platform.target }}.tar
          retention-days: 30

  package:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Create release package
        run: |
          mkdir -p release-package
          
          # 创建版本信息文件
          cat > release-package/README.md << 'EOF'
# YSP Server 多平台Docker镜像

版本: ${{ github.event.inputs.version }}
构建时间: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
构建ID: ${{ github.run_id }}
提交: ${{ github.sha }}

## 包含的镜像文件

1. **ysp-x86_64.tar** - Linux amd64/x86_64 平台
2. **ysp-aarch64.tar** - Linux arm64/aarch64 平台  
3. **ysp-armv7.tar** - Linux arm/v7 平台

每个镜像文件都包含对应的SHA256校验和文件。

## 下载地址

请访问GitHub Actions的Artifacts部分下载：

1. 前往此工作流的运行页面
2. 在"Artifacts"部分找到以下文件：
   - ysp-x86_64-image
   - ysp-aarch64-image  
   - ysp-armv7-image

## 使用方法

### 1. 加载镜像
```bash
# 加载amd64镜像
docker load -i ysp-x86_64.tar
