name: Simple_live APK Sync from Source Repository

# ä½¿ç”¨åŸç”Ÿå¹¶å‘æ§åˆ¶
concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # åŸºäºç¼“å­˜çš„é”æœºåˆ¶
    - name: Acquire Repository Lock ğŸ”’
      uses: softprops/turnstyle@v1
      with:
        same-branch-only: true
        poll-interval-seconds: 30
        abort-after-seconds: 600
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        
    - name: Run APK sync script
      env:
        SOURCE_REPO: "xiaoyaocz/dart_simple_live"
        TARGET_REPO: "${{ github.repository }}"
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
        STABLE_APK_PATTERN: "app-arm64-v8a-release"
        PRE_RELEASE_APK_PATTERN: "app-armeabi-v7a-release"
        STABLE_KEY_NAME: "simple_live.apk"
        PRE_RELEASE_KEY_NAME: "simple_live-tv.apk"
      run: |
        #!/bin/bash
        set -euo pipefail
        
        # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
        WORK_DIR=$(mktemp -d)
        trap 'rm -rf "$WORK_DIR"; echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."' EXIT
        
        # 1. ç›®æ ‡æ–‡ä»¶å­˜åœ¨æ€§æ£€æµ‹
        echo "æ£€æŸ¥ç›®æ ‡æ–‡ä»¶å­˜åœ¨æ€§..."
        STABLE_TARGET_PATH="apk/$STABLE_KEY_NAME"
        PRE_TARGET_PATH="apk/$PRE_RELEASE_KEY_NAME"
        
        # æ£€æŸ¥ç¨³å®šç‰ˆæ–‡ä»¶
        if curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $TOKEN" \
          "https://api.github.com/repos/$TARGET_REPO/contents/$STABLE_TARGET_PATH" | grep -q 200; then
          echo "ç¨³å®šç‰ˆç›®æ ‡æ–‡ä»¶å­˜åœ¨: $STABLE_TARGET_PATH"
          STABLE_EXISTS=1
        else
          echo "ç¨³å®šç‰ˆç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $STABLE_TARGET_PATH"
          STABLE_EXISTS=0
        fi
        
        # æ£€æŸ¥é¢„å‘è¡Œç‰ˆæ–‡ä»¶
        if curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $TOKEN" \
          "https://api.github.com/repos/$TARGET_REPO/contents/$PRE_TARGET_PATH" | grep -q 200; then
          echo "é¢„å‘è¡Œç‰ˆç›®æ ‡æ–‡ä»¶å­˜åœ¨: $PRE_TARGET_PATH"
          PRE_EXISTS=1
        else
          echo "é¢„å‘è¡Œç‰ˆç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $PRE_TARGET_PATH"
          PRE_EXISTS=0
        fi
        
        # 2. è·å–æºä»“åº“å‘å¸ƒä¿¡æ¯
        echo "è·å–æºä»“åº“å‘å¸ƒä¿¡æ¯..."
        releases=$(curl -sL "https://api.github.com/repos/$SOURCE_REPO/releases")
        
        # ä¿®å¤jqé”™è¯¯ï¼šç¡®ä¿å¤„ç†çš„æ˜¯æ•°ç»„
        if ! jq -e 'type == "array"' <<< "$releases" &>/dev/null; then
          echo "é”™è¯¯: æ— æ³•è·å–æœ‰æ•ˆçš„å‘å¸ƒä¿¡æ¯"
          echo "APIå“åº”: $releases"
          exit 1
        fi
        
        # æå–æœ€æ–°ç¨³å®šç‰ˆ
        stable_release=$(echo "$releases" | jq -r '[.[] | select(.prerelease == false)] | sort_by(.published_at) | reverse | .[0]')
        if [ "$stable_release" = "null" ]; then
          echo "é”™è¯¯: æ— æ³•æå–ç¨³å®šç‰ˆå‘å¸ƒä¿¡æ¯"
          exit 1
        fi
        stable_version=$(echo "$stable_release" | jq -r '.tag_name')
        stable_date=$(echo "$stable_release" | jq -r '.published_at' | TZ=UTC date -f - +'%Y-%m-%d')
        echo "ç¨³å®šç‰ˆ: $stable_version ($stable_date)"
        
        # æå–æœ€æ–°é¢„å‘è¡Œç‰ˆ
        pre_release=$(echo "$releases" | jq -r '[.[] | select(.prerelease == true)] | sort_by(.published_at) | reverse | .[0]')
        if [ "$pre_release" = "null" ]; then
          echo "æ— é¢„å‘è¡Œç‰ˆå¯ç”¨"
          sync_pre_release=false
        else
          pre_version=$(echo "$pre_release" | jq -r '.tag_name' | sed 's/^tv_//')
          pre_date=$(echo "$pre_release" | jq -r '.published_at' | TZ=UTC date -f - +'%Y-%m-%d')
          echo "é¢„å‘è¡Œç‰ˆ: $pre_version ($pre_date)"
          sync_pre_release=true
        fi
        
        # 3. è·å–ç›®æ ‡ä»“åº“ç‰ˆæœ¬æ–‡ä»¶
        echo "è·å–ç›®æ ‡ä»“åº“ç‰ˆæœ¬ä¿¡æ¯..."
        version_response=$(curl -s -H "Authorization: token $TOKEN" \
          "https://api.github.com/repos/$TARGET_REPO/contents/version.txt")
        
        # åˆå§‹åŒ–ç‰ˆæœ¬æ•°æ®
        if [ "$(echo "$version_response" | jq -r '.message')" != "Not Found" ]; then
          current_versions=$(echo "$version_response" | jq -r '.content' | base64 -d | jq -c .)
          echo "å½“å‰å…³å¿ƒçš„ç‰ˆæœ¬ä¿¡æ¯:"
          # åªæ˜¾ç¤ºå…³å¿ƒçš„é”®å€¼
          echo "$current_versions" | jq -r ".\"$STABLE_KEY_NAME\" // \"(æœªè®¾ç½®)\"" | awk -v key="$STABLE_KEY_NAME" '{print key ": " $0}'
          if [ "$sync_pre_release" = true ]; then
            echo "$current_versions" | jq -r ".\"$PRE_RELEASE_KEY_NAME\" // \"(æœªè®¾ç½®)\"" | awk -v key="$PRE_RELEASE_KEY_NAME" '{print key ": " $0}'
          fi
        else
          current_versions="{}"
          echo "æ— ç‰ˆæœ¬æ–‡ä»¶"
          echo "$STABLE_KEY_NAME: (æœªè®¾ç½®)"
          if [ "$sync_pre_release" = true ]; then
            echo "$PRE_RELEASE_KEY_NAME: (æœªè®¾ç½®)"
          fi
        fi
        
        # 4. æ›´æ–°ç‰ˆæœ¬æ•°æ®å‡½æ•°
        update_version_data() {
          local key=$1
          local version=$2
          local date=$3
          
          # ä»…æ›´æ–°æŒ‡å®šé”®å€¼
          current_versions=$(echo "$current_versions" | jq \
            --arg key "$key" \
            --arg value "$version,$date" \
            '.[$key] = $value')
        }
        
        # 5. æ£€æŸ¥å¹¶ä¸‹è½½APK
        check_and_download() {
          local release_json=$1
          local key_name=$2
          local apk_pattern=$3
          
          # è·å–ç›®æ ‡æ–‡ä»¶å
          local target_filename="apk/$key_name"
          
          # æ£€æŸ¥å½“å‰ç‰ˆæœ¬
          local current_value=$(echo "$current_versions" | jq -r ".\"$key_name\"")
          
          # è·å–æœ€æ–°ç‰ˆæœ¬å’Œæ—¥æœŸ
          local latest_version=$(echo "$release_json" | jq -r '.tag_name')
          local latest_date=$(echo "$release_json" | jq -r '.published_at' | TZ=UTC date -f - +'%Y-%m-%d')
          
          # å¦‚æœæ˜¯é¢„å‘è¡Œç‰ˆï¼Œå¤„ç†ç‰ˆæœ¬å·
          if [ "$key_name" = "$PRE_RELEASE_KEY_NAME" ]; then
            latest_version=$(echo "$latest_version" | sed 's/^tv_//')
          fi
          
          # è§¦å‘æ›´æ–°æ¡ä»¶
          local need_update=0
          
          # æ¡ä»¶1: ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨
          if [[ "$key_name" = "$STABLE_KEY_NAME" && "$STABLE_EXISTS" -eq 0 ]] || 
             [[ "$key_name" = "$PRE_RELEASE_KEY_NAME" && "$PRE_EXISTS" -eq 0 ]]; then
            echo "ç›®æ ‡æ–‡ä»¶ç¼ºå¤±ï¼Œéœ€è¦æ›´æ–°: $key_name"
            need_update=1
          # æ¡ä»¶2: ç‰ˆæœ¬é”®å€¼ä¸å­˜åœ¨
          elif ! echo "$current_versions" | jq -e ".\"$key_name\"" >/dev/null; then
            echo "ç‰ˆæœ¬é”®å€¼ç¼ºå¤±ï¼Œéœ€è¦æ›´æ–°: $key_name"
            need_update=1
          # æ¡ä»¶3: ç‰ˆæœ¬æˆ–æ—¥æœŸå˜åŒ–
          elif [[ "$current_value" != "$latest_version,$latest_date" ]]; then
            echo "ç‰ˆæœ¬å˜åŒ–: $key_name ($current_value â†’ $latest_version,$latest_date)"
            need_update=1
          else
            echo "æ— éœ€æ›´æ–°: $key_name ($current_value)"
            return 1
          fi
          
          if [ "$need_update" -eq 1 ]; then
            # ä¸‹è½½APK
            download_url=$(echo "$release_json" | jq -r \
              ".assets[] | select(.name | contains(\"$apk_pattern\")) | .browser_download_url" | head -1)
            
            if [ -z "$download_url" ]; then
              echo "é”™è¯¯: æœªæ‰¾åˆ°åŒ¹é…çš„APKæ–‡ä»¶ (æ¨¡å¼: $apk_pattern)"
              return 2
            fi
            
            echo "ä¸‹è½½: $download_url"
            curl -sL "$download_url" -o "$WORK_DIR/$key_name"
            
            # éªŒè¯ä¸‹è½½æˆåŠŸ
            if [ ! -f "$WORK_DIR/$key_name" ]; then
              echo "é”™è¯¯: APKä¸‹è½½å¤±è´¥"
              return 3
            fi
            
            # æ›´æ–°ç‰ˆæœ¬æ•°æ®
            update_version_data "$key_name" "$latest_version" "$latest_date"
            return 0
          fi
          
          return 1
        }
        
        # 6. ä¸Šä¼ æ–‡ä»¶å‡½æ•°
        upload_file() {
          local file_path=$1
          local target_path=$2
          
          # è·å–SHAï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          sha=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$TARGET_REPO/contents/$target_path" | jq -r '.sha // empty')
          
          # å‡†å¤‡ä¸Šä¼ æ•°æ®
          content_base64=$(base64 -w0 "$file_path")
          json_data=$(jq -n \
            --arg msg "æ›´æ–°: $target_path" \
            --arg content "$content_base64" \
            --arg sha "$sha" \
            '{message: $msg, content: $content, sha: $sha}')
          
          # ä¸Šä¼ æ–‡ä»¶
          echo "ä¸Šä¼ : $target_path"
          response=$(curl -s -X PUT \
            -H "Authorization: token $TOKEN" \
            -H "Content-Type: application/json" \
            -d "$json_data" \
            "https://api.github.com/repos/$TARGET_REPO/contents/$target_path")
          
          # éªŒè¯ä¸Šä¼ æˆåŠŸ
          if ! echo "$response" | jq -e '.content' >/dev/null; then
            echo "é”™è¯¯: æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
            echo "å“åº”: $response"
            return 1
          fi
          
          return 0
        }
        
        # 7. å¤„ç†ç¨³å®šç‰ˆ
        echo "å¤„ç†ç¨³å®šç‰ˆ..."
        if check_and_download "$stable_release" "$STABLE_KEY_NAME" "$STABLE_APK_PATTERN"; then
          upload_file "$WORK_DIR/$STABLE_KEY_NAME" "apk/$STABLE_KEY_NAME" || exit 1
          echo "ç¨³å®šç‰ˆåŒæ­¥æˆåŠŸ"
        fi
        
        # 8. å¤„ç†é¢„å‘è¡Œç‰ˆ
        if [ "$sync_pre_release" = true ]; then
          echo "å¤„ç†é¢„å‘è¡Œç‰ˆ..."
          if check_and_download "$pre_release" "$PRE_RELEASE_KEY_NAME" "$PRE_RELEASE_APK_PATTERN"; then
            upload_file "$WORK_DIR/$PRE_RELEASE_KEY_NAME" "apk/$PRE_RELEASE_KEY_NAME" || exit 1
            echo "é¢„å‘è¡Œç‰ˆåŒæ­¥æˆåŠŸ"
          fi
        fi
        
        # 9. æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        echo "æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶..."
        version_sha=$(echo "$version_response" | jq -r '.sha // empty')
        version_content=$(echo "$current_versions" | jq -c .)
        version_base64=$(echo -n "$version_content" | base64 -w0)
        
        version_json=$(jq -n \
          --arg msg "æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯" \
          --arg content "$version_base64" \
          --arg sha "$version_sha" \
          '{message: $msg, content: $content, sha: $sha}')
        
        # ä¸Šä¼ ç‰ˆæœ¬æ–‡ä»¶
        version_response=$(curl -s -X PUT \
          -H "Authorization: token $TOKEN" \
          -H "Content-Type: application/json" \
          -d "$version_json" \
          "https://api.github.com/repos/$TARGET_REPO/contents/version.txt")
        
        # éªŒè¯ç‰ˆæœ¬æ–‡ä»¶æ›´æ–°
        if ! echo "$version_response" | jq -e '.content' >/dev/null; then
          echo "é”™è¯¯: ç‰ˆæœ¬æ–‡ä»¶æ›´æ–°å¤±è´¥"
          echo "å“åº”: $version_response"
          exit 1
        fi
        
        # 10. æœ€ç»ˆéªŒè¯
        echo "éªŒè¯åŒæ­¥ç»“æœ..."
        # éªŒè¯ç¨³å®šç‰ˆæ–‡ä»¶
        if [ "$STABLE_EXISTS" -eq 0 ] || check_and_download "$stable_release" "$STABLE_KEY_NAME" "$STABLE_APK_PATTERN"; then
          if ! curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$TARGET_REPO/contents/apk/$STABLE_KEY_NAME" | grep -q 200; then
            echo "é”™è¯¯: ç¨³å®šç‰ˆæ–‡ä»¶åŒæ­¥éªŒè¯å¤±è´¥"
            exit 1
          else
            echo "ç¨³å®šç‰ˆæ–‡ä»¶éªŒè¯æˆåŠŸ"
          fi
        fi
        
        # éªŒè¯é¢„å‘è¡Œç‰ˆæ–‡ä»¶
        if [ "$sync_pre_release" = true ] && { [ "$PRE_EXISTS" -eq 0 ] || 
           check_and_download "$pre_release" "$PRE_RELEASE_KEY_NAME" "$PRE_RELEASE_APK_PATTERN"; }; then
          if ! curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$TARGET_REPO/contents/apk/$PRE_RELEASE_KEY_NAME" | grep -q 200; then
            echo "é”™è¯¯: é¢„å‘è¡Œç‰ˆæ–‡ä»¶åŒæ­¥éªŒè¯å¤±è´¥"
            exit 1
          else
            echo "é¢„å‘è¡Œç‰ˆæ–‡ä»¶éªŒè¯æˆåŠŸ"
          fi
        fi
        
        # 11. æ˜¾ç¤ºæœ€ç»ˆå…³å¿ƒçš„ç‰ˆæœ¬ä¿¡æ¯
        echo "åŒæ­¥å®Œæˆ! å…³å¿ƒçš„ç‰ˆæœ¬ä¿¡æ¯:"
        # åªæ˜¾ç¤ºå…³å¿ƒçš„é”®å€¼
        echo "$current_versions" | jq -r ".\"$STABLE_KEY_NAME\" // \"(æœªè®¾ç½®)\"" | awk -v key="$STABLE_KEY_NAME" '{print key ": " $0}'
        if [ "$sync_pre_release" = true ]; then
          echo "$current_versions" | jq -r ".\"$PRE_RELEASE_KEY_NAME\" // \"(æœªè®¾ç½®)\"" | awk -v key="$PRE_RELEASE_KEY_NAME" '{print key ": " $0}'
        fi

    - name: Release Repository Lock ğŸ”“
      if: always()
      uses: softprops/turnstyle@v1
      with:
        continue-on-error: true
        action: unlock
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup_self:
    name: Cleanup Self Workflow History
    runs-on: ubuntu-latest
    needs: sync
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "Simple_live APK Sync from Source Repository"
          repository: ${{ github.repository }}