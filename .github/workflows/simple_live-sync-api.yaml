name: Simple_live APK Sync from Source Repository

concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: Acquire Repository Lock ğŸ”’
      uses: softprops/turnstyle@v1
      with:
        same-branch-only: true
        poll-interval-seconds: 30
        abort-after-seconds: 600
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        
    - name: Run APK sync script
      env:
        SOURCE_REPO: "xiaoyaocz/dart_simple_live"
        TARGET_REPO: "${{ github.repository }}"
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
        STABLE_APK_PATTERN: "app-arm64-v8a-release"
        PRE_RELEASE_APK_PATTERN: "app-armeabi-v7a-release"
        STABLE_KEY_NAME: "simple_live.apk"
        PRE_RELEASE_KEY_NAME: "simple_live-tv.apk"
      run: |
        #!/bin/bash
        set -euo pipefail
        
        WORK_DIR=$(mktemp -d)
        trap 'rm -rf "$WORK_DIR"; echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."' EXIT
        
        # 1. ç›®æ ‡æ–‡ä»¶å­˜åœ¨æ€§æ£€æµ‹
        echo "æ£€æŸ¥ç›®æ ‡æ–‡ä»¶å­˜åœ¨æ€§..."
        STABLE_TARGET_PATH="apk/$STABLE_KEY_NAME"
        PRE_TARGET_PATH="apk/$PRE_RELEASE_KEY_NAME"
        
        # æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§çš„å‡½æ•°
        check_file_exists() {
          local path=$1
          http_status=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$TARGET_REPO/contents/$path")
          [ "$http_status" -eq 200 ]
        }
        
        STABLE_EXISTS=$(check_file_exists "$STABLE_TARGET_PATH" && echo 1 || echo 0)
        PRE_EXISTS=$(check_file_exists "$PRE_TARGET_PATH" && echo 1 || echo 0)
        echo "ç¨³å®šç‰ˆå­˜åœ¨: $STABLE_EXISTS, é¢„å‘è¡Œç‰ˆå­˜åœ¨: $PRE_EXISTS"
        
        # 2. è·å–æºä»“åº“å‘å¸ƒä¿¡æ¯
        echo "è·å–æºä»“åº“å‘å¸ƒä¿¡æ¯..."
        releases=$(curl -sL "https://api.github.com/repos/$SOURCE_REPO/releases")
        
        # æå–æœ€æ–°ç¨³å®šç‰ˆ
        stable_release=$(echo "$releases" | jq -c '[.[] | select(.prerelease == false)] | sort_by(.published_at) | reverse | .[0]')
        stable_version=$(echo "$stable_release" | jq -r '.tag_name')
        stable_date=$(echo "$stable_release" | jq -r '.published_at' | TZ=UTC date -f - +'%Y-%m-%d')
        echo "ç¨³å®šç‰ˆ: $stable_version ($stable_date)"
        
        # æå–æœ€æ–°é¢„å‘è¡Œç‰ˆ
        pre_release=$(echo "$releases" | jq -c '[.[] | select(.prerelease == true)] | sort_by(.published_at) | reverse | .[0]')
        if [ "$pre_release" != "null" ]; then
          pre_version=$(echo "$pre_release" | jq -r '.tag_name' | sed 's/^tv_//')
          pre_date=$(echo "$pre_release" | jq -r '.published_at' | TZ=UTC date -f - +'%Y-%m-%d')
          echo "é¢„å‘è¡Œç‰ˆ: $pre_version ($pre_date)"
          sync_pre_release=true
        else
          echo "æ— é¢„å‘è¡Œç‰ˆå¯ç”¨"
          sync_pre_release=false
        fi
        
        # 3. ä½¿ç”¨Pythonå¤„ç†å¤§å‹JSONæ•°æ®ï¼ˆé¿å…jqé™åˆ¶ï¼‰
        cat > "$WORK_DIR/version_handler.py" << 'EOF'
import os
import json
import sys
import base64

def main():
    action = sys.argv[1]
    key = sys.argv[2] if len(sys.argv) > 2 else None
    value = sys.argv[3] if len(sys.argv) > 3 else None
    
    version_file = os.environ.get('VERSION_FILE')
    if not version_file:
        print("é”™è¯¯: æœªè®¾ç½®VERSION_FILEç¯å¢ƒå˜é‡")
        sys.exit(1)
    
    try:
        # è¯»å–ç‰ˆæœ¬æ–‡ä»¶
        if os.path.exists(version_file):
            with open(version_file, 'r') as f:
                version_data = json.load(f)
        else:
            version_data = {}
        
        if action == "get":
            # è·å–å€¼
            print(version_data.get(key, ""))
        elif action == "update":
            # æ›´æ–°å€¼
            version_data[key] = value
            with open(version_file, 'w') as f:
                json.dump(version_data, f, separators=(',', ':'))
        elif action == "show":
            # æ˜¾ç¤ºæ‰€æœ‰å€¼
            print(json.dumps(version_data, indent=2))
    except Exception as e:
        print(f"é”™è¯¯: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()
EOF
        
        # 4. è·å–ç›®æ ‡ä»“åº“ç‰ˆæœ¬æ–‡ä»¶
        echo "è·å–ç›®æ ‡ä»“åº“ç‰ˆæœ¬ä¿¡æ¯..."
        version_response=$(curl -s -H "Authorization: token $TOKEN" \
          "https://api.github.com/repos/$TARGET_REPO/contents/version.txt")
        
        # åˆ›å»ºä¸´æ—¶ç‰ˆæœ¬æ–‡ä»¶
        VERSION_FILE="$WORK_DIR/version.json"
        export VERSION_FILE
        
        if [ "$(echo "$version_response" | jq -r '.message')" != "Not Found" ]; then
            content_base64=$(echo "$version_response" | jq -r '.content')
            if [ "$content_base64" != "null" ]; then
                echo "$content_base64" | base64 -d > "$VERSION_FILE"
                echo "ç‰ˆæœ¬æ–‡ä»¶å·²ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶"
            else
                echo "{}" > "$VERSION_FILE"
                echo "ç‰ˆæœ¬æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
            fi
        else
            echo "{}" > "$VERSION_FILE"
            echo "æ— ç‰ˆæœ¬æ–‡ä»¶ï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
        fi
        
        # 5. è¾…åŠ©å‡½æ•°
        get_current_value() {
            python3 "$WORK_DIR/version_handler.py" get "$1"
        }
        
        update_version_data() {
            local key=$1
            local version=$2
            local date=$3
            python3 "$WORK_DIR/version_handler.py" update "$key" "$version,$date"
        }
        
        show_version_data() {
            python3 "$WORK_DIR/version_handler.py" show
        }
        
        # 6. æ£€æŸ¥å¹¶ä¸‹è½½APK
        check_and_download() {
            local release_json=$1
            local key_name=$2
            local apk_pattern=$3
            
            local target_filename="apk/$key_name"
            local current_value=$(get_current_value "$key_name")
            
            local latest_version=$(echo "$release_json" | jq -r '.tag_name')
            local latest_date=$(echo "$release_json" | jq -r '.published_at' | TZ=UTC date -f - +'%Y-%m-%d')
            
            if [ "$key_name" = "$PRE_RELEASE_KEY_NAME" ]; then
                latest_version=$(echo "$latest_version" | sed 's/^tv_//')
            fi
            
            local latest_value="$latest_version,$latest_date"
            
            need_update=false
            if [ "$key_name" = "$STABLE_KEY_NAME" ] && [ "$STABLE_EXISTS" -eq 0 ]; then
                need_update=true
            elif [ "$key_name" = "$PRE_RELEASE_KEY_NAME" ] && [ "$PRE_EXISTS" -eq 0 ]; then
                need_update=true
            elif [ -z "$current_value" ]; then
                need_update=true
            elif [ "$current_value" != "$latest_value" ]; then
                need_update=true
            fi
            
            if $need_update; then
                echo "éœ€è¦æ›´æ–°: $key_name (å½“å‰: ${current_value:-æ— }, æœ€æ–°: $latest_value)"
                
                # ä¸‹è½½APK
                download_url=$(echo "$release_json" | jq -r \
                  ".assets[] | select(.name | contains(\"$apk_pattern\")) | .browser_download_url" | head -1)
                
                if [ -z "$download_url" ]; then
                    echo "é”™è¯¯: æœªæ‰¾åˆ°åŒ¹é…çš„APKæ–‡ä»¶ (æ¨¡å¼: $apk_pattern)"
                    return 1
                fi
                
                echo "ä¸‹è½½: $download_url"
                curl -sL "$download_url" -o "$WORK_DIR/$key_name"
                
                if [ ! -f "$WORK_DIR/$key_name" ]; then
                    echo "é”™è¯¯: APKä¸‹è½½å¤±è´¥"
                    return 1
                fi
                
                # æ›´æ–°ç‰ˆæœ¬æ•°æ®
                update_version_data "$key_name" "$latest_version" "$latest_date"
                return 0
            else
                echo "æ— éœ€æ›´æ–°: $key_name ($current_value)"
                return 1
            fi
        }
        
        # 7. ä¿®å¤å¤§æ–‡ä»¶ä¸Šä¼ å‡½æ•°
        upload_file() {
            local file_path=$1
            local target_path=$2
            
            # è·å–æ–‡ä»¶SHAï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            file_info=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$TARGET_REPO/contents/$target_path")
            sha=$(echo "$file_info" | jq -r '.sha // empty')
            
            # åˆ›å»ºä¸´æ—¶JSONæ–‡ä»¶
            json_file=$(mktemp)
            
            # ä½¿ç”¨base64ç¼–ç å†…å®¹
            content_base64=$(base64 -w0 "$file_path")
            
            # ä½¿ç”¨jqç”ŸæˆJSONï¼ˆå†…å®¹å·²ç¼–ç ä¸ºbase64ï¼Œä¸ä¼šå¤ªå¤§ï¼‰
            jq -n \
              --arg msg "æ›´æ–°: $target_path" \
              --arg content "$content_base64" \
              --arg sha "$sha" \
              '{message: $msg, content: $content, sha: $sha}' > "$json_file"
            
            echo "ä¸Šä¼ : $target_path"
            response=$(curl -s -X PUT \
              -H "Authorization: token $TOKEN" \
              -H "Content-Type: application/json" \
              -d "@$json_file" \
              "https://api.github.com/repos/$TARGET_REPO/contents/$target_path")
            
            rm -f "$json_file"
            
            if ! echo "$response" | jq -e '.content' >/dev/null; then
                echo "é”™è¯¯: æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
                echo "å“åº”: $response"
                return 1
            fi
            
            return 0
        }
        
        # 8. å¤„ç†ç¨³å®šç‰ˆ
        echo "å¤„ç†ç¨³å®šç‰ˆ..."
        if check_and_download "$stable_release" "$STABLE_KEY_NAME" "$STABLE_APK_PATTERN"; then
            upload_file "$WORK_DIR/$STABLE_KEY_NAME" "apk/$STABLE_KEY_NAME"
            echo "ç¨³å®šç‰ˆåŒæ­¥æˆåŠŸ"
        fi
        
        # 9. å¤„ç†é¢„å‘è¡Œç‰ˆ
        if [ "$sync_pre_release" = true ]; then
            echo "å¤„ç†é¢„å‘è¡Œç‰ˆ..."
            if check_and_download "$pre_release" "$PRE_RELEASE_KEY_NAME" "$PRE_RELEASE_APK_PATTERN"; then
                upload_file "$WORK_DIR/$PRE_RELEASE_KEY_NAME" "apk/$PRE_RELEASE_KEY_NAME"
                echo "é¢„å‘è¡Œç‰ˆåŒæ­¥æˆåŠŸ"
            fi
        fi
        
        # 10. æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        echo "æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶..."
        version_sha=$(echo "$version_response" | jq -r '.sha // empty')
        
        # ä½¿ç”¨ä¸Šä¼ å‡½æ•°æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        upload_file "$VERSION_FILE" "version.txt"
        
        echo "åŒæ­¥å®Œæˆ! æœ€ç»ˆç‰ˆæœ¬ä¿¡æ¯:"
        show_version_data

    - name: Release Repository Lock ğŸ”“
      if: always()
      uses: softprops/turnstyle@v1
      with:
        continue-on-error: true
        action: unlock
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup_self:
    name: Cleanup Self Workflow History
    runs-on: ubuntu-latest
    needs: sync
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "Simple_live APK Sync from Source Repository"
          repository: ${{ github.repository }}