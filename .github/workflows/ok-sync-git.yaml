name: OK APK Sync from Multiple Sources

# ä½¿ç”¨åŸç”Ÿå¹¶å‘æ§åˆ¶
concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */4 * * *'  # æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # åŸºäºç¼“å­˜çš„é”æœºåˆ¶
    - name: Acquire Repository Lock ğŸ”’
      uses: softprops/turnstyle@v1
      with:
        same-branch-only: true
        poll-interval-seconds: 30
        abort-after-seconds: 600
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        token: ${{ secrets.GITHUB_TOKEN }}
        path: target-repo
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl unzip
        
    - name: Install Android SDK for aapt2
      run: |
        SDK_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip"
        curl -sL "$SDK_TOOLS_URL" -o sdk-tools.zip
        unzip -q sdk-tools.zip -d android-sdk
        
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        echo "$GITHUB_WORKSPACE/android-sdk/cmdline-tools/bin" >> $GITHUB_PATH
        
        yes | android-sdk/cmdline-tools/bin/sdkmanager --sdk_root=$GITHUB_WORKSPACE/android-sdk "build-tools;34.0.0"
        echo "aapt2è·¯å¾„: $GITHUB_WORKSPACE/android-sdk/build-tools/34.0.0/aapt2"
        
    - name: Set up Python for Telegram sync
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install Python dependencies
      run: |
        pip install telethon requests pytz

    - name: Run APK sync script
      env:
        SOURCE_REPO: "FongMi/Release"
        SOURCE_BRANCH: "okjack"
        APK_DIR: "apk/release"
        TARGET_REPO: "${{ github.repository }}"
        TV_APK_NAME: "leanback-armeabi_v7a.apk"
        MOBILE_APK_NAME: "mobile-arm64_v8a.apk"
        TV_TARGET_NAME: "leanback.apk"
        MOBILE_TARGET_NAME: "mobile.apk"
        # Telegram ç›¸å…³ç¯å¢ƒå˜é‡
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
        TELEGRAM_CHANNEL: "tvboxjk"  # æŒ‡å®šTelegramé¢‘é“
      run: |
        # ç›®æ ‡æ–‡ä»¶è·¯å¾„
        TV_TARGET_PATH="apk/$TV_TARGET_NAME"
        MOBILE_TARGET_PATH="apk/$MOBILE_TARGET_NAME"
        
        # å·¥ä½œç›®å½•
        WORK_DIR=$(mktemp -d)
        echo "åˆ›å»ºä¸´æ—¶ç›®å½•: $WORK_DIR"
        trap 'rm -rf "$WORK_DIR"; echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."' EXIT

        # ç›®æ ‡ä»“åº“ç›®å½•
        TARGET_DIR="$GITHUB_WORKSPACE/target-repo"
        VERSION_FILE="$TARGET_DIR/version.txt"
        
        # 1. ç›®æ ‡æ–‡ä»¶å­˜åœ¨æ€§æ£€æµ‹
        echo "æ£€æŸ¥ç›®æ ‡æ–‡ä»¶å­˜åœ¨æ€§..."
        TV_EXISTS=0
        MOBILE_EXISTS=0
        
        if [ -f "$TARGET_DIR/$TV_TARGET_PATH" ]; then
          echo "ç”µè§†TVç‰ˆç›®æ ‡æ–‡ä»¶å­˜åœ¨: $TARGET_DIR/$TV_TARGET_PATH"
          TV_EXISTS=1
        else
          echo "ç”µè§†TVç‰ˆç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $TARGET_DIR/$TV_TARGET_PATH"
        fi
        
        if [ -f "$TARGET_DIR/$MOBILE_TARGET_PATH" ]; then
          echo "æ‰‹æœºç‰ˆç›®æ ‡æ–‡ä»¶å­˜åœ¨: $TARGET_DIR/$MOBILE_TARGET_PATH"
          MOBILE_EXISTS=1
        else
          echo "æ‰‹æœºç‰ˆç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $TARGET_DIR/$MOBILE_TARGET_PATH"
        fi
        
        # 2. ç‰ˆæœ¬æ–‡ä»¶é”®å€¼å­˜åœ¨æ€§æ£€æµ‹
        echo "æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨æ€§..."
        if [ -f "$VERSION_FILE" ]; then
          echo "ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨: $VERSION_FILE"
          CURRENT_VERSION_DATA=$(cat "$VERSION_FILE")
        else
          echo "ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºç‰ˆæœ¬æ–‡ä»¶"
          echo "{}" > "$VERSION_FILE"
          CURRENT_VERSION_DATA="{}"
        fi
        
        # 3. è§¦å‘æ›´æ–°ä¸‹è½½é€»è¾‘
        NEED_UPDATE_TV=0
        NEED_UPDATE_MOBILE=0
        
        # æå–ç‰ˆæœ¬å·å‡½æ•°
        extract_apk_version() {
          local apk_path="$1"
          echo "ä»APKæå–ç‰ˆæœ¬å·: $apk_path" >&2
          
          VERSION_INFO=$("$GITHUB_WORKSPACE/android-sdk/build-tools/34.0.0/aapt2" dump badging "$apk_path" 2>/dev/null | grep "versionName")
          VERSION=$(echo "$VERSION_INFO" | sed -n "s/.*versionName='\([^']*\)'.*/\1/p")
          
          if [ -z "$VERSION" ]; then
            echo "è­¦å‘Š: æ— æ³•æå–ç‰ˆæœ¬å·, ä½¿ç”¨æäº¤å“ˆå¸Œ" >&2
            COMMIT_JSON=$(curl -sL "https://api.github.com/repos/$SOURCE_REPO/commits?path=$APK_DIR/$TV_APK_NAME&sha=$SOURCE_BRANCH&per_page=1")
            VERSION=$(echo "$COMMIT_JSON" | jq -r '.[0].commit.message' | grep -oP 'v\d+\.\d+\.\d+' | head -1)
            if [ -z "$VERSION" ]; then
              VERSION="unknown"
            fi
          fi
          
          if [[ ! "$VERSION" =~ ^v ]]; then
            VERSION="v$VERSION"
          fi
          
          echo "æå–çš„ç‰ˆæœ¬å·: $VERSION" >&2
          echo "$VERSION"
        }

        # è·å–æ–‡ä»¶æäº¤æ—¥æœŸ
        get_file_commit_date() {
          local file_name="$1"
          
          COMMIT_JSON=$(curl -sL "https://api.github.com/repos/$SOURCE_REPO/commits?path=$APK_DIR/$file_name&sha=$SOURCE_BRANCH&per_page=1")
          if [ $? -ne 0 ] || [ -z "$COMMIT_JSON" ]; then
            echo "é”™è¯¯: æ— æ³•è·å–æ–‡ä»¶æäº¤å†å²" >&2
            exit 1
          fi
          
          COMMIT_DATE=$(echo "$COMMIT_JSON" | jq -r '.[0].commit.committer.date')
          COMMIT_DATE_UTC8=$(TZ=Asia/Shanghai date -d "$COMMIT_DATE" +'%Y-%m-%d')
          
          echo "æ–‡ä»¶æäº¤æ—¥æœŸ: $COMMIT_DATE_UTC8" >&2
          echo "$COMMIT_DATE_UTC8"
        }
        
        # ä»Telegramè·å–APKçš„å‡½æ•°
        get_apk_from_telegram() {
          local apk_type="$1"  # tv æˆ– mobile
          local target_filename="$2"
          
          echo "å°è¯•ä»Telegramé¢‘é“è·å–APK: $apk_type -> $target_filename"
          
          # åˆ›å»ºPythonè„šæœ¬ä»Telegramè·å–APK
          cat > "$WORK_DIR/telegram_sync.py" << 'EOF'
import os
import sys
import re
from telethon import TelegramClient
from telethon.sessions import StringSession
from telethon.tl.types import DocumentAttributeFilename

# é…ç½®å‚æ•°
TELEGRAM_CHANNEL = os.environ.get('TELEGRAM_CHANNEL', 'tvboxjk')
APK_TYPE = sys.argv[1]
TARGET_FILENAME = sys.argv[2]
WORK_DIR = sys.argv[3]

# æ ¹æ®APKç±»å‹ç¡®å®šè¦æœç´¢çš„æ–‡ä»¶åæ¨¡å¼
if APK_TYPE == "tv":
    # ç”µè§†TVç‰ˆæ–‡ä»¶åæ¨¡å¼
    FILE_PATTERNS = [
        r"OKç”µè§†ç‰ˆ.*32ä½.*\.apk",
        r"OKç”µè§†ç‰ˆ.*\.apk",
        r"leanback.*\.apk"
    ]
else:  # mobile
    # æ‰‹æœºç‰ˆæ–‡ä»¶åæ¨¡å¼
    FILE_PATTERNS = [
        r"OKæ‰‹æœºç‰ˆ.*64ä½.*\.apk",
        r"OKæ‰‹æœºç‰ˆ.*\.apk",
        r"mobile.*\.apk"
    ]

async def main():
    # åˆå§‹åŒ–Telegramå®¢æˆ·ç«¯
    client = TelegramClient(
        StringSession(os.environ['TELEGRAM_SESSION']),
        int(os.environ['TELEGRAM_API_ID']),
        os.environ['TELEGRAM_API_HASH']
    )
    
    await client.start()
    
    # è·å–é¢‘é“å®ä½“
    entity = await client.get_entity(TELEGRAM_CHANNEL)
    
    # æœç´¢æœ€æ–°çš„APKæ–‡ä»¶
    target_file = None
    async for message in client.iter_messages(entity, limit=50):
        if not message.media:
            continue
            
        # æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡æ¡£
        if hasattr(message.media, 'document'):
            for attr in message.media.document.attributes:
                if isinstance(attr, DocumentAttributeFilename):
                    filename = attr.file_name
                    
                    # æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦ç¬¦åˆæ¨¡å¼
                    for pattern in FILE_PATTERNS:
                        if re.search(pattern, filename, re.IGNORECASE):
                            # æ’é™¤æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬
                            if "æ¨¡æ‹Ÿå™¨" not in filename:
                                target_file = {
                                    'message': message,
                                    'filename': filename
                                }
                                break
                    if target_file:
                        break
            if target_file:
                break
    
    if not target_file:
        print(f"åœ¨Telegramé¢‘é“ {TELEGRAM_CHANNEL} ä¸­æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„APKæ–‡ä»¶")
        return False
    
    print(f"æ‰¾åˆ°APKæ–‡ä»¶: {target_file['filename']}")
    
    # ä¸‹è½½æ–‡ä»¶
    download_path = os.path.join(WORK_DIR, TARGET_FILENAME)
    await client.download_media(target_file['message'], file=download_path)
    
    print(f"æ–‡ä»¶å·²ä¸‹è½½åˆ°: {download_path}")
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸‹è½½
    if os.path.exists(download_path) and os.path.getsize(download_path) > 0:
        print("ä¸‹è½½æˆåŠŸ")
        return True
    else:
        print("ä¸‹è½½å¤±è´¥")
        return False

if __name__ == "__main__":
    import asyncio
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
EOF

          # è¿è¡ŒPythonè„šæœ¬
          python "$WORK_DIR/telegram_sync.py" "$apk_type" "$target_filename" "$WORK_DIR"
          return $?
        }
        
        # å°è¯•ä»GitHubæºä¸‹è½½APK
        echo "å°è¯•ä»GitHubæºä¸‹è½½APK..."
        
        # ä¸‹è½½ç”µè§†TVç‰ˆAPK
        echo "ä¸‹è½½ç”µè§†TVç‰ˆAPK..."
        TV_DOWNLOAD_URL="https://raw.githubusercontent.com/$SOURCE_REPO/$SOURCE_BRANCH/$APK_DIR/$TV_APK_NAME"
        curl -sL "$TV_DOWNLOAD_URL" -o "$WORK_DIR/$TV_APK_NAME"
        
        # ä¸‹è½½æ‰‹æœºç‰ˆAPK
        echo "ä¸‹è½½æ‰‹æœºç‰ˆAPK..."
        MOBILE_DOWNLOAD_URL="https://raw.githubusercontent.com/$SOURCE_REPO/$SOURCE_BRANCH/$APK_DIR/$MOBILE_APK_NAME"
        curl -sL "$MOBILE_DOWNLOAD_URL" -o "$WORK_DIR/$MOBILE_APK_NAME"
        
        # å¦‚æœGitHubä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä»Telegramè·å–
        if [ ! -f "$WORK_DIR/$TV_APK_NAME" ]; then
          echo "GitHubç”µè§†TVç‰ˆAPKä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä»Telegramè·å–..."
          if get_apk_from_telegram "tv" "$TV_APK_NAME"; then
            echo "ä»TelegramæˆåŠŸè·å–ç”µè§†TVç‰ˆAPK"
          else
            echo "é”™è¯¯: ç”µè§†TVç‰ˆAPKä¸‹è½½å¤±è´¥"
            exit 1
          fi
        fi
        
        if [ ! -f "$WORK_DIR/$MOBILE_APK_NAME" ]; then
          echo "GitHubæ‰‹æœºç‰ˆAPKä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä»Telegramè·å–..."
          if get_apk_from_telegram "mobile" "$MOBILE_APK_NAME"; then
            echo "ä»TelegramæˆåŠŸè·å–æ‰‹æœºç‰ˆAPK"
          else
            echo "é”™è¯¯: æ‰‹æœºç‰ˆAPKä¸‹è½½å¤±è´¥"
            exit 1
          fi
        fi
        
        # æå–ç‰ˆæœ¬ä¿¡æ¯
        TV_VERSION=$(extract_apk_version "$WORK_DIR/$TV_APK_NAME")
        MOBILE_VERSION=$(extract_apk_version "$WORK_DIR/$MOBILE_APK_NAME")
        TV_COMMIT_DATE=$(get_file_commit_date "$TV_APK_NAME")
        MOBILE_COMMIT_DATE=$(get_file_commit_date "$MOBILE_APK_NAME")
        
        echo "ç”µè§†TVç‰ˆç‰ˆæœ¬: $TV_VERSION, æ—¥æœŸ: $TV_COMMIT_DATE"
        echo "æ‰‹æœºç‰ˆç‰ˆæœ¬: $MOBILE_VERSION, æ—¥æœŸ: $MOBILE_COMMIT_DATE"
        
        # 4. å¯¹æ¯”æ›´æ–°é€»è¾‘
        CURRENT_TV=$(echo "$CURRENT_VERSION_DATA" | jq -r ".$TV_TARGET_NAME")
        CURRENT_MOBILE=$(echo "$CURRENT_VERSION_DATA" | jq -r ".$MOBILE_TARGET_NAME")
        
        NEW_TV_VALUE="$TV_VERSION,$TV_COMMIT_DATE"
        NEW_MOBILE_VALUE="$MOBILE_VERSION,$MOBILE_COMMIT_DATE"
        
        # ç”µè§†TVç‰ˆæ›´æ–°æ£€æµ‹
        if [ "$TV_EXISTS" -eq 0 ]; then
          echo "ç”µè§†TVç‰ˆç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦æ›´æ–°"
          NEED_UPDATE_TV=1
        elif [ "$CURRENT_TV" != "$NEW_TV_VALUE" ]; then
          echo "ç”µè§†TVç‰ˆç‰ˆæœ¬å˜åŒ–ï¼š$CURRENT_TV -> $NEW_TV_VALUEï¼Œéœ€è¦æ›´æ–°"
          NEED_UPDATE_TV=1
        else
          echo "ç”µè§†TVç‰ˆæ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°"
        fi
        
        # æ‰‹æœºç‰ˆæ›´æ–°æ£€æµ‹
        if [ "$MOBILE_EXISTS" -eq 0 ]; then
          echo "æ‰‹æœºç‰ˆç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦æ›´æ–°"
          NEED_UPDATE_MOBILE=1
        elif [ "$CURRENT_MOBILE" != "$NEW_MOBILE_VALUE" ]; then
          echo "æ‰‹æœºç‰ˆç‰ˆæœ¬å˜åŒ–ï¼š$CURRENT_MOBILE -> $NEW_MOBILE_VALUEï¼Œéœ€è¦æ›´æ–°"
          NEED_UPDATE_MOBILE=1
        else
          echo "æ‰‹æœºç‰ˆæ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°"
        fi
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        if [ "$NEED_UPDATE_TV" -eq 0 ] && [ "$NEED_UPDATE_MOBILE" -eq 0 ]; then
          echo "æ²¡æœ‰éœ€è¦æ›´æ–°çš„APKæ–‡ä»¶"
          exit 0
        fi
        
        # 5. æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        NEW_VERSION_DATA=$(echo "$CURRENT_VERSION_DATA" | jq \
            --arg tv_key "$TV_TARGET_NAME" \
            --arg tv_value "$NEW_TV_VALUE" \
            --arg mobile_key "$MOBILE_TARGET_NAME" \
            --arg mobile_value "$NEW_MOBILE_VALUE" \
            '.[$tv_key] = $tv_value | .[$mobile_key] = $mobile_value')
            
        echo "$NEW_VERSION_DATA" | jq -r . > "$VERSION_FILE"
        echo "ç‰ˆæœ¬æ–‡ä»¶å·²æ›´æ–°"
        
        # 6. å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
        mkdir -p "$TARGET_DIR/apk"
        
        if [ "$NEED_UPDATE_TV" -eq 1 ]; then
          cp "$WORK_DIR/$TV_APK_NAME" "$TARGET_DIR/$TV_TARGET_PATH"
          echo "ç”µè§†TVç‰ˆAPKå·²å¤åˆ¶åˆ°ç›®æ ‡ä»“åº“"
          
          # éªŒè¯å¤åˆ¶æˆåŠŸ
          if [ ! -f "$TARGET_DIR/$TV_TARGET_PATH" ]; then
            echo "é”™è¯¯: ç”µè§†TVç‰ˆAPKå¤åˆ¶å¤±è´¥"
            exit 1
          fi
        fi
        
        if [ "$NEED_UPDATE_MOBILE" -eq 1 ]; then
          cp "$WORK_DIR/$MOBILE_APK_NAME" "$TARGET_DIR/$MOBILE_TARGET_PATH"
          echo "æ‰‹æœºç‰ˆAPKå·²å¤åˆ¶åˆ°ç›®æ ‡ä»“åº“"
          
          # éªŒè¯å¤åˆ¶æˆåŠŸ
          if [ ! -f "$TARGET_DIR/$MOBILE_TARGET_PATH" ]; then
            echo "é”™è¯¯: æ‰‹æœºç‰ˆAPKå¤åˆ¶å¤±è´¥"
            exit 1
          fi
        fi
        
        # 7. æäº¤å’Œæ¨é€
        cd "$TARGET_DIR"
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff-index --quiet HEAD --; then
          echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          exit 0
        fi

        COMMIT_MESSAGE="æ›´æ–°APK: "
        if [ "$NEED_UPDATE_TV" -eq 1 ]; then
          COMMIT_MESSAGE+="$TV_TARGET_NAME ($TV_VERSION) "
        fi
        if [ "$NEED_UPDATE_MOBILE" -eq 1 ]; then
          COMMIT_MESSAGE+="$MOBILE_TARGET_NAME ($MOBILE_VERSION) "
        fi
        
        # æ·»åŠ æ¥æºä¿¡æ¯
        if [ ! -f "$WORK_DIR/$TV_APK_NAME" ] || [ ! -f "$WORK_DIR/$MOBILE_APK_NAME" ]; then
          COMMIT_MESSAGE+="(éƒ¨åˆ†æ¥è‡ªTelegram) "
        fi
        
        git commit -m "$COMMIT_MESSAGE"
        
        # æ¨é€é‡è¯•æœºåˆ¶
        for i in {1..3}; do
          echo "å°è¯• $i/3: æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
          git pull origin main --rebase || {
            echo "æ‹‰å–å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
            sleep 10
            continue
          }
          
          echo "å°è¯• $i/3: æ¨é€æ›´æ”¹..."
          if git push origin main; then
            echo "æ¨é€æˆåŠŸ!"
            break
          else
            echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
            sleep 10
          fi
        done
        
        if [ $i -eq 3 ]; then
          echo "é”™è¯¯: ç»è¿‡3æ¬¡å°è¯•åä»æ— æ³•æ¨é€æ›´æ”¹"
          exit 1
        fi

        # 8. æœ€ç»ˆéªŒè¯
        echo "åŒæ­¥å®Œæˆï¼ŒéªŒè¯ç»“æœ:"
        echo "ç”µè§†TVç‰ˆ: $([ -f "$TARGET_DIR/$TV_TARGET_PATH" ] && echo "å­˜åœ¨" || echo "ç¼ºå¤±")"
        echo "æ‰‹æœºç‰ˆ: $([ -f "$TARGET_DIR/$MOBILE_TARGET_PATH" ] && echo "å­˜åœ¨" || echo "ç¼ºå¤±")"
        
        if [ "$NEED_UPDATE_TV" -eq 1 ] && [ ! -f "$TARGET_DIR/$TV_TARGET_PATH" ]; then
          echo "é”™è¯¯: ç”µè§†TVç‰ˆAPKåŒæ­¥åéªŒè¯å¤±è´¥"
          exit 1
        fi
        
        if [ "$NEED_UPDATE_MOBILE" -eq 1 ] && [ ! -f "$TARGET_DIR/$MOBILE_TARGET_PATH" ]; then
          echo "é”™è¯¯: æ‰‹æœºç‰ˆAPKåŒæ­¥åéªŒè¯å¤±è´¥"
          exit 1
        fi
        
        echo "æ‰€æœ‰ç›®æ ‡æ–‡ä»¶å·²ç¡®è®¤åŒæ­¥è‡³ä»“åº“"
        echo "çŠ¶æ€: æˆåŠŸ"

    - name: Release Repository Lock ğŸ”“
      if: always()
      uses: softprops/turnstyle@v1
      with:
        continue-on-error: true
        action: unlock
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ä¿®å¤é€šçŸ¥å¤±è´¥é—®é¢˜
    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          try {
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ issue number
            if (context.issue && context.issue.number) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ğŸš¨ APKåŒæ­¥å¤±è´¥ï¼å·¥ä½œæµè¿è¡Œ: [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              });
            } else {
              // åˆ›å»ºæ–° issue é€šçŸ¥
              const issueTitle = "APKåŒæ­¥å¤±è´¥é€šçŸ¥";
              const issueBody = `### ğŸš¨ APKåŒæ­¥å¤±è´¥\n\n` +
                               `**å·¥ä½œæµ**: [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n` +
                               `**å¤±è´¥æ—¶é—´**: ${new Date().toISOString()}\n\n` +
                               `è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚`;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody
              });
            }
          } catch (error) {
            console.error('é€šçŸ¥å¤±è´¥:', error);
            // å›é€€åˆ°åŸºæœ¬æ—¥å¿—è¾“å‡º
            core.warning('æ— æ³•å‘é€é€šçŸ¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥å·¥ä½œæµå¤±è´¥æƒ…å†µ');
          }

  cleanup_self:
    name: Cleanup Self Workflow History
    runs-on: ubuntu-latest
    needs: sync
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "OK APK Sync from Multiple Sources"
          repository: ${{ github.repository }}