name: OK APK Sync from Source Repository

# ä½¿ç”¨åŸç”Ÿå¹¶å‘æ§åˆ¶
concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # åŸºäºç¼“å­˜çš„é”æœºåˆ¶
    - name: Acquire Repository Lock ğŸ”’
      uses: softprops/turnstyle@v3
      with:
        same-branch-only: true
        poll-interval-seconds: 30
        abort-after-seconds: 600
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout target repository
      uses: actions/checkout@v5
      with:
        repository: ${{ github.repository }}
        token: ${{ secrets.GITHUB_TOKEN }}
        path: target-repo
        fetch-depth: 1

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl unzip
        
    - name: Install Android SDK for aapt2
      run: |
        SDK_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip"
        curl -sL "$SDK_TOOLS_URL" -o sdk-tools.zip
        unzip -q sdk-tools.zip -d android-sdk
        
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        echo "$GITHUB_WORKSPACE/android-sdk/cmdline-tools/bin" >> $GITHUB_PATH
        
        yes | android-sdk/cmdline-tools/bin/sdkmanager --sdk_root=$GITHUB_WORKSPACE/android-sdk "build-tools;34.0.0"
        echo "aapt2è·¯å¾„: $GITHUB_WORKSPACE/android-sdk/build-tools/34.0.0/aapt2"
        
    - name: Run APK sync script
      env:
        SOURCE_REPO: "lystv/fmapp"
        SOURCE_BRANCH: "ok"
        APK_DIR: "apk/release"
        TARGET_REPO: "${{ github.repository }}"
        STABLE_APK_NAME: "leanback-armeabi_v7a.apk"
        PRE_RELEASE_APK_NAME: "mobile-arm64_v8a.apk"
        STABLE_TARGET_NAME: "leanback.apk"
        PRE_RELEASE_TARGET_NAME: "mobile.apk"
      run: |
        # ç›®æ ‡æ–‡ä»¶è·¯å¾„
        STABLE_TARGET_PATH="apk/$STABLE_TARGET_NAME"
        PRE_RELEASE_TARGET_PATH="apk/$PRE_RELEASE_TARGET_NAME"
        
        # å·¥ä½œç›®å½•
        WORK_DIR=$(mktemp -d)
        echo "åˆ›å»ºä¸´æ—¶ç›®å½•: $WORK_DIR"
        trap 'rm -rf "$WORK_DIR"; echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."' EXIT

        # ç›®æ ‡ä»“åº“ç›®å½•
        TARGET_DIR="$GITHUB_WORKSPACE/target-repo"
        VERSION_FILE="$TARGET_DIR/version.txt"
        
        # 1. æ£€æŸ¥å½“å‰ç‰ˆæœ¬æ–‡ä»¶çŠ¶æ€
        echo "æ£€æŸ¥å½“å‰ç‰ˆæœ¬æ–‡ä»¶çŠ¶æ€..."
        if [ -f "$VERSION_FILE" ]; then
          echo "ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨: $VERSION_FILE"
          CURRENT_VERSION_DATA=$(cat "$VERSION_FILE")
          echo "å½“å‰ç‰ˆæœ¬æ•°æ®: $CURRENT_VERSION_DATA"
        else
          echo "ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºç‰ˆæœ¬æ–‡ä»¶"
          echo "{}" > "$VERSION_FILE"
          CURRENT_VERSION_DATA="{}"
        fi
        
        # 2. æå–ç‰ˆæœ¬ä¿¡æ¯å‡½æ•°
        extract_apk_version() {
          local apk_path="$1"
          local apk_type="$2"
          echo "ä»$apk_type APKæå–ç‰ˆæœ¬å·: $apk_path" >&2
          
          # é¦–å…ˆå°è¯•ä½¿ç”¨aapt2æå–ç‰ˆæœ¬
          VERSION_INFO=$("$GITHUB_WORKSPACE/android-sdk/build-tools/34.0.0/aapt2" dump badging "$apk_path" 2>/dev/null | grep "versionName" || true)
          VERSION=$(echo "$VERSION_INFO" | sed -n "s/.*versionName='\([^']*\)'.*/\1/p")
          
          if [ -z "$VERSION" ]; then
            echo "è­¦å‘Š: æ— æ³•ä½¿ç”¨aapt2æå–$apk_typeç‰ˆæœ¬å·, å°è¯•ä½¿ç”¨æäº¤ä¿¡æ¯" >&2
            # ä½¿ç”¨æäº¤ä¿¡æ¯ä¸­çš„ç‰ˆæœ¬å·
            COMMIT_JSON=$(curl -sL "https://api.github.com/repos/$SOURCE_REPO/commits?path=$APK_DIR/$apk_type&sha=$SOURCE_BRANCH&per_page=1")
            VERSION=$(echo "$COMMIT_JSON" | jq -r '.[0].commit.message' | grep -oP 'v\d+\.\d+\.\d+' | head -1)
            if [ -z "$VERSION" ]; then
              VERSION="unknown-$(date +%Y%m%d)"
            fi
          fi
          
          # ç¡®ä¿ç‰ˆæœ¬å·ä»¥vå¼€å¤´
          if [[ ! "$VERSION" =~ ^v ]] && [[ "$VERSION" != "unknown"* ]]; then
            VERSION="v$VERSION"
          fi
          
          echo "$apk_typeç‰ˆæœ¬å·: $VERSION" >&2
          echo "$VERSION"
        }

        # è·å–æ–‡ä»¶æäº¤æ—¥æœŸå’Œå“ˆå¸Œ
        get_file_commit_info() {
          local file_name="$1"
          local apk_type="$2"
          
          echo "è·å–$apk_typeæäº¤ä¿¡æ¯..." >&2
          COMMIT_JSON=$(curl -sL "https://api.github.com/repos/$SOURCE_REPO/commits?path=$APK_DIR/$file_name&sha=$SOURCE_BRANCH&per_page=1")
          if [ $? -ne 0 ] || [ -z "$COMMIT_JSON" ] || [ "$COMMIT_JSON" = "[]" ]; then
            echo "é”™è¯¯: æ— æ³•è·å–$apk_typeæ–‡ä»¶æäº¤å†å²" >&2
            return 1
          fi
          
          COMMIT_DATE=$(echo "$COMMIT_JSON" | jq -r '.[0].commit.committer.date')
          COMMIT_SHA=$(echo "$COMMIT_JSON" | jq -r '.[0].sha')
          COMMIT_DATE_UTC8=$(TZ=Asia/Shanghai date -d "$COMMIT_DATE" +'%Y-%m-%d %H:%M:%S')
          
          echo "$apk_typeæäº¤æ—¥æœŸ: $COMMIT_DATE_UTC8, æäº¤å“ˆå¸Œ: ${COMMIT_SHA:0:8}" >&2
          echo "$COMMIT_DATE_UTC8|${COMMIT_SHA:0:8}"
        }
        
        # 3. ä¸‹è½½æºAPKæ–‡ä»¶å¹¶æå–ä¿¡æ¯
        echo "å¼€å§‹ä¸‹è½½æºAPKæ–‡ä»¶..."
        
        # ç”µè§†ç‰ˆAPK
        STABLE_DOWNLOAD_URL="https://raw.githubusercontent.com/$SOURCE_REPO/$SOURCE_BRANCH/$APK_DIR/$STABLE_APK_NAME"
        echo "ä¸‹è½½ç”µè§†ç‰ˆAPK: $STABLE_DOWNLOAD_URL"
        curl -sL "$STABLE_DOWNLOAD_URL" -o "$WORK_DIR/$STABLE_APK_NAME"
        if [ ! -f "$WORK_DIR/$STABLE_APK_NAME" ]; then
          echo "é”™è¯¯: ç”µè§†ç‰ˆAPKä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        # æ‰‹æœºç‰ˆAPK
        PRE_RELEASE_DOWNLOAD_URL="https://raw.githubusercontent.com/$SOURCE_REPO/$SOURCE_BRANCH/$APK_DIR/$PRE_RELEASE_APK_NAME"
        echo "ä¸‹è½½æ‰‹æœºç‰ˆAPK: $PRE_RELEASE_DOWNLOAD_URL"
        curl -sL "$PRE_RELEASE_DOWNLOAD_URL" -o "$WORK_DIR/$PRE_RELEASE_APK_NAME"
        if [ ! -f "$WORK_DIR/$PRE_RELEASE_APK_NAME" ]; then
          echo "é”™è¯¯: æ‰‹æœºç‰ˆAPKä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        # æå–ç‰ˆæœ¬å’Œæäº¤ä¿¡æ¯
        STABLE_VERSION=$(extract_apk_version "$WORK_DIR/$STABLE_APK_NAME" "ç”µè§†ç‰ˆ")
        PRE_RELEASE_VERSION=$(extract_apk_version "$WORK_DIR/$PRE_RELEASE_APK_NAME" "æ‰‹æœºç‰ˆ")
        
        STABLE_COMMIT_INFO=$(get_file_commit_info "$STABLE_APK_NAME" "ç”µè§†ç‰ˆ")
        PRE_RELEASE_COMMIT_INFO=$(get_file_commit_info "$PRE_RELEASE_APK_NAME" "æ‰‹æœºç‰ˆ")
        
        echo "=== æºAPKä¿¡æ¯ ==="
        echo "ç”µè§†ç‰ˆ: ç‰ˆæœ¬=$STABLE_VERSION, æäº¤ä¿¡æ¯=$STABLE_COMMIT_INFO"
        echo "æ‰‹æœºç‰ˆ: ç‰ˆæœ¬=$PRE_RELEASE_VERSION, æäº¤ä¿¡æ¯=$PRE_RELEASE_COMMIT_INFO"
        
        # 4. æ„å»ºæ–°çš„ç‰ˆæœ¬æ•°æ®
        NEW_STABLE_VALUE="$STABLE_VERSION|$STABLE_COMMIT_INFO"
        NEW_PRE_VALUE="$PRE_RELEASE_VERSION|$PRE_RELEASE_COMMIT_INFO"
        
        # 5. å¯¹æ¯”ç‰ˆæœ¬æ•°æ®ï¼Œå†³å®šæ˜¯å¦éœ€è¦æ›´æ–°
        NEED_UPDATE_STABLE=0
        NEED_UPDATE_PRE=0
        
        CURRENT_STABLE=$(echo "$CURRENT_VERSION_DATA" | jq -r ".$STABLE_TARGET_NAME // \"\"")
        CURRENT_PRE=$(echo "$CURRENT_VERSION_DATA" | jq -r ".$PRE_RELEASE_TARGET_NAME // \"\"")
        
        echo "=== å½“å‰ç‰ˆæœ¬æ•°æ® ==="
        echo "ç”µè§†ç‰ˆ: $CURRENT_STABLE"
        echo "æ‰‹æœºç‰ˆ: $CURRENT_PRE"
        
        # ç”µè§†ç‰ˆæ›´æ–°æ£€æµ‹
        if [ -z "$CURRENT_STABLE" ]; then
          echo "ç”µè§†ç‰ˆ: æ— å½“å‰ç‰ˆæœ¬è®°å½•ï¼Œéœ€è¦é¦–æ¬¡åŒæ­¥"
          NEED_UPDATE_STABLE=1
        elif [ "$CURRENT_STABLE" != "$NEW_STABLE_VALUE" ]; then
          echo "ç”µè§†ç‰ˆ: ç‰ˆæœ¬å˜åŒ–ï¼Œéœ€è¦æ›´æ–°"
          echo "  æ—§: $CURRENT_STABLE"
          echo "  æ–°: $NEW_STABLE_VALUE"
          NEED_UPDATE_STABLE=1
        else
          echo "ç”µè§†ç‰ˆ: ç‰ˆæœ¬æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°"
        fi
        
        # æ‰‹æœºç‰ˆæ›´æ–°æ£€æµ‹
        if [ -z "$CURRENT_PRE" ]; then
          echo "æ‰‹æœºç‰ˆ: æ— å½“å‰ç‰ˆæœ¬è®°å½•ï¼Œéœ€è¦é¦–æ¬¡åŒæ­¥"
          NEED_UPDATE_PRE=1
        elif [ "$CURRENT_PRE" != "$NEW_PRE_VALUE" ]; then
          echo "æ‰‹æœºç‰ˆ: ç‰ˆæœ¬å˜åŒ–ï¼Œéœ€è¦æ›´æ–°"
          echo "  æ—§: $CURRENT_PRE"
          echo "  æ–°: $NEW_PRE_VALUE"
          NEED_UPDATE_PRE=1
        else
          echo "æ‰‹æœºç‰ˆ: ç‰ˆæœ¬æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°"
        fi
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        if [ "$NEED_UPDATE_STABLE" -eq 0 ] && [ "$NEED_UPDATE_PRE" -eq 0 ]; then
          echo "æ‰€æœ‰APKæ–‡ä»¶å‡ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          exit 0
        fi
        
        # 6. æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        echo "æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶..."
        NEW_VERSION_DATA=$(echo "$CURRENT_VERSION_DATA" | jq \
            --arg stable_key "$STABLE_TARGET_NAME" \
            --arg stable_value "$NEW_STABLE_VALUE" \
            --arg pre_key "$PRE_RELEASE_TARGET_NAME" \
            --arg pre_value "$NEW_PRE_VALUE" \
            '.[$stable_key] = $stable_value | .[$pre_key] = $pre_value')
            
        echo "$NEW_VERSION_DATA" | jq -r . > "$VERSION_FILE"
        echo "ç‰ˆæœ¬æ–‡ä»¶å·²æ›´æ–°: $VERSION_FILE"
        
        # 7. å¤åˆ¶APKæ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
        mkdir -p "$TARGET_DIR/apk"
        
        if [ "$NEED_UPDATE_STABLE" -eq 1 ]; then
          cp "$WORK_DIR/$STABLE_APK_NAME" "$TARGET_DIR/$STABLE_TARGET_PATH"
          echo "ç”µè§†ç‰ˆAPKå·²å¤åˆ¶åˆ°: $TARGET_DIR/$STABLE_TARGET_PATH"
        fi
        
        if [ "$NEED_UPDATE_PRE" -eq 1 ]; then
          cp "$WORK_DIR/$PRE_RELEASE_APK_NAME" "$TARGET_DIR/$PRE_RELEASE_TARGET_PATH"
          echo "æ‰‹æœºç‰ˆAPKå·²å¤åˆ¶åˆ°: $TARGET_DIR/$PRE_RELEASE_TARGET_PATH"
        fi
        
        # 8. æäº¤å’Œæ¨é€æ›´æ”¹
        cd "$TARGET_DIR"
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

        # æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶
        git add "$VERSION_FILE"
        if [ "$NEED_UPDATE_STABLE" -eq 1 ]; then
          git add "$STABLE_TARGET_PATH"
        fi
        if [ "$NEED_UPDATE_PRE" -eq 1 ]; then
          git add "$PRE_RELEASE_TARGET_PATH"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff-index --quiet HEAD --; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          exit 0
        fi

        # æ„å»ºæäº¤ä¿¡æ¯
        COMMIT_MESSAGE="ğŸ”„ APKåŒæ­¥æ›´æ–°"
        if [ "$NEED_UPDATE_STABLE" -eq 1 ]; then
          COMMIT_MESSAGE+=" | ç”µè§†ç‰ˆ:$STABLE_VERSION"
        fi
        if [ "$NEED_UPDATE_PRE" -eq 1 ]; then
          COMMIT_MESSAGE+=" | æ‰‹æœºç‰ˆ:$PRE_RELEASE_VERSION"
        fi
        COMMIT_MESSAGE+=" [è‡ªåŠ¨åŒæ­¥]"
        
        echo "æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"
        git commit -m "$COMMIT_MESSAGE"
        
        # æ¨é€æ›´æ”¹ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        echo "æ¨é€æ›´æ”¹åˆ°ä»“åº“..."
        for i in {1..3}; do
          echo "å°è¯• $i/3: æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
          if git pull --rebase origin main; then
            echo "æ‹‰å–æˆåŠŸï¼Œå°è¯•æ¨é€..."
            if git push origin main; then
              echo "æ¨é€æˆåŠŸ!"
              break
            else
              echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
              sleep 10
            fi
          else
            echo "æ‹‰å–å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
            sleep 10
          fi
        done
        
        if [ $? -ne 0 ]; then
          echo "é”™è¯¯: ç»è¿‡3æ¬¡å°è¯•åä»æ— æ³•æ¨é€æ›´æ”¹"
          exit 1
        fi

        # 9. æœ€ç»ˆéªŒè¯
        echo "=== åŒæ­¥å®ŒæˆéªŒè¯ ==="
        if [ "$NEED_UPDATE_STABLE" -eq 1 ]; then
          if [ -f "$TARGET_DIR/$STABLE_TARGET_PATH" ]; then
            echo "âœ… ç”µè§†ç‰ˆAPKåŒæ­¥æˆåŠŸ"
          else
            echo "âŒ ç”µè§†ç‰ˆAPKåŒæ­¥åéªŒè¯å¤±è´¥"
            exit 1
          fi
        fi
        
        if [ "$NEED_UPDATE_PRE" -eq 1 ]; then
          if [ -f "$TARGET_DIR/$PRE_RELEASE_TARGET_PATH" ]; then
            echo "âœ… æ‰‹æœºç‰ˆAPKåŒæ­¥æˆåŠŸ"
          else
            echo "âŒ æ‰‹æœºç‰ˆAPKåŒæ­¥åéªŒè¯å¤±è´¥"
            exit 1
          fi
        fi
        
        echo "ğŸ‰ APKåŒæ­¥ä»»åŠ¡å®Œæˆ"

    - name: Release Repository Lock ğŸ”“
      if: always()
      uses: softprops/turnstyle@v3
      with:
        continue-on-error: true
        action: unlock
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          try {
            if (context.issue && context.issue.number) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ğŸš¨ APKåŒæ­¥å¤±è´¥ï¼å·¥ä½œæµè¿è¡Œ: [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              });
            } else {
              const issueTitle = "APKåŒæ­¥å¤±è´¥é€šçŸ¥";
              const issueBody = `### ğŸš¨ APKåŒæ­¥å¤±è´¥\n\n` +
                               `**å·¥ä½œæµ**: [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n` +
                               `**å¤±è´¥æ—¶é—´**: ${new Date().toISOString()}\n\n` +
                               `è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚`;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody
              });
            }
          } catch (error) {
            console.error('é€šçŸ¥å¤±è´¥:', error);
            core.warning('æ— æ³•å‘é€é€šçŸ¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥å·¥ä½œæµå¤±è´¥æƒ…å†µ');
          }

  cleanup_self:
    name: Cleanup Self Workflow History
    runs-on: ubuntu-latest
    needs: sync
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2.0.6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "OK APK Sync from Source Repository"
          repository: ${{ github.repository }}