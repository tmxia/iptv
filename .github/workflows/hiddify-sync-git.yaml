name: Hiddify APK Sync from Source Repository

# ä½¿ç”¨åŸç”Ÿå¹¶å‘æ§åˆ¶
concurrency:
  group: sync-apk-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */48 * * *'  # æ¯48å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    # åŸºäºç¼“å­˜çš„é”æœºåˆ¶
    - name: Acquire Repository Lock
      uses: softprops/turnstyle@v1
      with:
        same-branch-only: true
        poll-interval-seconds: 30
        abort-after-seconds: 300  # 5åˆ†é’Ÿè¶…æ—¶
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Git identity
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git pull origin main --rebase
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        
    - name: Run APK sync script
      env:
        SOURCE_REPO: "hiddify/hiddify-app"
        APK_PATTERN: "Android-arm64.apk"
        STABLE_KEY_NAME: "hiddify.apk"
        PRE_RELEASE_KEY_NAME: "hiddify-beta.apk"
      run: |
        #!/bin/bash
        set -euo pipefail
        
        STABLE_TARGET_FILENAME="apk/$STABLE_KEY_NAME"
        PRE_RELEASE_TARGET_FILENAME="apk/$PRE_RELEASE_KEY_NAME"
        
        WORK_DIR=$(mktemp -d)
        echo "åˆ›å»ºä¸´æ—¶ç›®å½•: $WORK_DIR"
        trap 'rm -rf "$WORK_DIR"; echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."' EXIT

        mkdir -p apk

        echo "è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬ä¿¡æ¯..."
        # å¢åŠ APIè¯·æ±‚é‡è¯•å’Œé”™è¯¯å¤„ç†
        for i in {1..5}; do
          RELEASES_JSON=$(curl -sfL "https://api.github.com/repos/$SOURCE_REPO/releases")
          if [ $? -eq 0 ]; then
            break
          else
            echo "APIè¯·æ±‚å¤±è´¥ï¼Œé‡è¯• ($i/5)..."
            sleep 10
          fi
        done
        
        if [ -z "$RELEASES_JSON" ]; then
          echo "é”™è¯¯: æ— æ³•è·å–å‘å¸ƒä¿¡æ¯"
          exit 1
        fi
        
        # æ£€æŸ¥è¿”å›çš„æ˜¯å¦æ˜¯æ•°ç»„ï¼ˆè€Œä¸æ˜¯é”™è¯¯æ¶ˆæ¯ï¼‰
        if ! echo "$RELEASES_JSON" | jq -e 'if type == "array" then true else false end' >/dev/null; then
          echo "é”™è¯¯: GitHub APIè¿”å›æ— æ•ˆæ•°æ®:"
          echo "$RELEASES_JSON" | head -c 200
          exit 1
        fi

        # å®‰å…¨æå–ç¨³å®šç‰ˆ
        LATEST_STABLE_RELEASE=$(echo "$RELEASES_JSON" | jq -r '[.[] | select(.prerelease == false)] | sort_by(.published_at) | reverse | .[0]')
        if [ -z "$LATEST_STABLE_RELEASE" ] || [ "$LATEST_STABLE_RELEASE" = "null" ]; then
          echo "é”™è¯¯: æ— æ³•æå–ç¨³å®šç‰ˆå‘å¸ƒä¿¡æ¯"
          exit 1
        fi
        STABLE_VERSION=$(echo "$LATEST_STABLE_RELEASE" | jq -r '.tag_name')
        STABLE_PUBLISHED_AT=$(echo "$LATEST_STABLE_RELEASE" | jq -r '.published_at')
        STABLE_DATE=$(TZ=UTC date -d "$STABLE_PUBLISHED_AT" +'%Y-%m-%d')
        echo "æºä»“åº“æœ€æ–°ç¨³å®šç‰ˆ: $STABLE_VERSION (å‘å¸ƒäº: $STABLE_DATE)"

        # å®‰å…¨æå–é¢„å‘è¡Œç‰ˆ
        LATEST_PRE_RELEASE=$(echo "$RELEASES_JSON" | jq -r '[.[] | select(.prerelease == true)] | sort_by(.published_at) | reverse | .[0]')
        if [ -z "$LATEST_PRE_RELEASE" ] || [ "$LATEST_PRE_RELEASE" = "null" ]; then
          echo "è­¦å‘Š: æ— æ³•æå–é¢„å‘è¡Œç‰ˆå‘å¸ƒä¿¡æ¯ï¼Œè·³è¿‡é¢„å‘è¡Œç‰ˆåŒæ­¥"
          SYNC_PRE_RELEASE=false
        else
          PRE_RELEASE_VERSION=$(echo "$LATEST_PRE_RELEASE" | jq -r '.tag_name')
          PRE_RELEASE_PUBLISHED_AT=$(echo "$LATEST_PRE_RELEASE" | jq -r '.published_at')
          PRE_RELEASE_DATE=$(TZ=UTC date -d "$PRE_RELEASE_PUBLISHED_AT" +'%Y-%m-%d')
          echo "æºä»“åº“æœ€æ–°é¢„å‘è¡Œç‰ˆ: $PRE_RELEASE_VERSION (å‘å¸ƒäº: $PRE_RELEASE_DATE)"
          SYNC_PRE_RELEASE=true
        fi

        VERSION_FILE="version.txt"
        CURRENT_VERSION_DATA="{}"
        if [ -f "$VERSION_FILE" ]; then
          echo "æ‰¾åˆ°æœ¬åœ°ç‰ˆæœ¬æ–‡ä»¶"
          CURRENT_VERSION_DATA=$(cat "$VERSION_FILE" | jq . 2>/dev/null || echo "{}")
        else
          echo "åˆ›å»ºæ–°çš„ç‰ˆæœ¬æ–‡ä»¶"
          echo "{}" > "$VERSION_FILE"
          CURRENT_VERSION_DATA="{}"
        fi

        # æå–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
        CURRENT_STABLE_VALUE=$(echo "$CURRENT_VERSION_DATA" | jq -r ".\"$STABLE_KEY_NAME\" // \"\"")
        CURRENT_STABLE_VERSION=$(echo "$CURRENT_STABLE_VALUE" | cut -d, -f1)
        CURRENT_STABLE_DATE=$(echo "$CURRENT_STABLE_VALUE" | cut -d, -f2)
        
        CURRENT_PRE_RELEASE_VALUE=$(echo "$CURRENT_VERSION_DATA" | jq -r ".\"$PRE_RELEASE_KEY_NAME\" // \"\"")
        CURRENT_PRE_RELEASE_VERSION=$(echo "$CURRENT_PRE_RELEASE_VALUE" | cut -d, -f1)
        CURRENT_PRE_RELEASE_DATE=$(echo "$CURRENT_PRE_RELEASE_VALUE" | cut -d, -f2)

        echo "å½“å‰ç¨³å®šç‰ˆç‰ˆæœ¬: $CURRENT_STABLE_VERSION (æ—¥æœŸ: $CURRENT_STABLE_DATE)"
        echo "å½“å‰é¢„å‘è¡Œç‰ˆç‰ˆæœ¬: $CURRENT_PRE_RELEASE_VERSION (æ—¥æœŸ: $CURRENT_PRE_RELEASE_DATE)"

        # æ–‡ä»¶å­˜åœ¨æ€§æ£€æµ‹å‡½æ•°
        check_file_exists() {
          local target_filename=$1
          local key_name=$2
          
          if [ -f "$target_filename" ]; then
            echo "æ–‡ä»¶å­˜åœ¨: $target_filename"
            return 0
          else
            echo "æ–‡ä»¶ç¼ºå¤±: $target_filename"
            return 1
          fi
        }

        # ç‰ˆæœ¬é”®å€¼å­˜åœ¨æ€§æ£€æµ‹å‡½æ•°
        check_key_exists() {
          local key_name=$1
          
          if echo "$CURRENT_VERSION_DATA" | jq -e "has(\"$key_name\")" >/dev/null; then
            echo "ç‰ˆæœ¬é”®å€¼å­˜åœ¨: $key_name"
            return 0
          else
            echo "ç‰ˆæœ¬é”®å€¼ç¼ºå¤±: $key_name"
            return 1
          fi
        }

        # æ£€æŸ¥å¹¶ä¸‹è½½APK
        check_and_download_apk() {
          local release_json="$1"
          local target_filename="$2"
          local key_name="$3"
          local current_version="$4"
          local current_date="$5"
          
          # æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§
          check_file_exists "$target_filename" "$key_name"
          file_exists=$?
          
          # æ£€æŸ¥é”®å€¼å­˜åœ¨æ€§
          check_key_exists "$key_name"
          key_exists=$?
          
          # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
          local latest_version=$(echo "$release_json" | jq -r '.tag_name')
          local latest_date=$(echo "$release_json" | jq -r '.published_at' | TZ=UTC date -f - +'%Y-%m-%d')
          
          echo "æ£€æµ‹æ›´æ–°: $key_name (å½“å‰: $current_version/$current_date, æœ€æ–°: $latest_version/$latest_date)"
          
          # ç¡®å®šæ˜¯å¦éœ€è¦æ›´æ–°
          need_update=false
          
          # æ–‡ä»¶ç¼ºå¤±æˆ–é”®å€¼ç¼ºå¤±å¿…é¡»æ›´æ–°
          if [ $file_exists -ne 0 ] || [ $key_exists -ne 0 ]; then
            echo "æ–‡ä»¶æˆ–é”®å€¼ç¼ºå¤±ï¼Œå¿…é¡»æ›´æ–°"
            need_update=true
          # ç‰ˆæœ¬ä¸åŒå¿…é¡»æ›´æ–°
          elif [ "$latest_version" != "$current_version" ]; then
            echo "å‘ç°æ–°ç‰ˆæœ¬: $latest_version (å½“å‰: $current_version)"
            need_update=true
          # ç‰ˆæœ¬ç›¸åŒä½†æ—¥æœŸæ›´æ–°ä¹Ÿåº”è¯¥æ›´æ–°
          elif [ "$latest_date" \> "$current_date" ]; then
            echo "ç‰ˆæœ¬ç›¸åŒä½†å‘å¸ƒæ—¥æœŸæ›´æ–°: $latest_date > $current_date"
            need_update=true
          else
            echo "ç‰ˆæœ¬ç›¸åŒä¸”å‘å¸ƒæ—¥æœŸç›¸åŒï¼Œæ— éœ€æ›´æ–°"
          fi
          
          if [ "$need_update" = true ]; then
            local download_url=$(echo "$release_json" | jq -r '.assets[] | select(.name | contains("'$APK_PATTERN'")) | .browser_download_url' | head -1)
            
            if [ -z "$download_url" ]; then
              echo "é”™è¯¯: æœªæ‰¾åˆ°åŒ¹é…çš„APKæ–‡ä»¶"
              return 2
            fi
            
            echo "ä¸‹è½½APK: $download_url"
            
            # å¢åŠ ä¸‹è½½é‡è¯•æœºåˆ¶
            for i in {1..3}; do
              curl -sfL "$download_url" -o "$target_filename"
              if [ $? -eq 0 ] && [ -s "$target_filename" ]; then
                echo "ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "ä¸‹è½½å¤±è´¥ï¼Œé‡è¯• ($i/3)..."
                sleep 5
                rm -f "$target_filename"
              fi
            done
            
            if [ ! -f "$target_filename" ]; then
              echo "é”™è¯¯: APKä¸‹è½½å¤±è´¥ - æ–‡ä»¶æœªåˆ›å»º"
              return 2
            fi
            
            if [ ! -s "$target_filename" ]; then
              echo "é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º"
              rm -f "$target_filename"
              return 2
            fi
            
            # æ·»åŠ æ–‡ä»¶å¤§å°æ£€æŸ¥
            FILESIZE=$(stat -c%s "$target_filename")
            if [ "$FILESIZE" -lt 1000000 ]; then
              echo "é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶å¤ªå°(å¯èƒ½ä¸å®Œæ•´)"
              rm -f "$target_filename"
              return 2
            fi
            
            return 0  # æˆåŠŸä¸‹è½½
          else
            return 0  # æ— éœ€æ›´æ–°
          fi
        }

        # å¤„ç†ç¨³å®šç‰ˆ
        STABLE_NEED_UPDATE=false
        echo "===== å¤„ç†ç¨³å®šç‰ˆ ====="
        check_and_download_apk "$LATEST_STABLE_RELEASE" "$STABLE_TARGET_FILENAME" "$STABLE_KEY_NAME" "$CURRENT_STABLE_VERSION" "$CURRENT_STABLE_DATE"
        STABLE_RESULT=$?
        if [ $STABLE_RESULT -eq 0 ]; then
          if [ -f "$STABLE_TARGET_FILENAME" ]; then
            STABLE_NEED_UPDATE=true
            NEW_STABLE_VERSION="$STABLE_VERSION"
            NEW_STABLE_DATE="$STABLE_DATE"
            echo "ç¨³å®šç‰ˆéœ€è¦æ›´æ–°"
          else
            NEW_STABLE_VERSION="$CURRENT_STABLE_VERSION"
            NEW_STABLE_DATE="$CURRENT_STABLE_DATE"
            echo "ç¨³å®šç‰ˆæ— éœ€æ›´æ–°"
          fi
        else
          echo "é”™è¯¯: ç¨³å®šç‰ˆå¤„ç†å¤±è´¥"
          exit 1
        fi

        # å¤„ç†é¢„å‘è¡Œç‰ˆ
        PRE_RELEASE_NEED_UPDATE=false
        if [ "$SYNC_PRE_RELEASE" = true ]; then
          echo "===== å¤„ç†é¢„å‘è¡Œç‰ˆ ====="
          check_and_download_apk "$LATEST_PRE_RELEASE" "$PRE_RELEASE_TARGET_FILENAME" "$PRE_RELEASE_KEY_NAME" "$CURRENT_PRE_RELEASE_VERSION" "$CURRENT_PRE_RELEASE_DATE"
          PRE_RELEASE_RESULT=$?
          if [ $PRE_RELEASE_RESULT -eq 0 ]; then
            if [ -f "$PRE_RELEASE_TARGET_FILENAME" ]; then
              PRE_RELEASE_NEED_UPDATE=true
              NEW_PRE_RELEASE_VERSION="$PRE_RELEASE_VERSION"
              NEW_PRE_RELEASE_DATE="$PRE_RELEASE_DATE"
              echo "é¢„å‘è¡Œç‰ˆéœ€è¦æ›´æ–°"
            else
              NEW_PRE_RELEASE_VERSION="$CURRENT_PRE_RELEASE_VERSION"
              NEW_PRE_RELEASE_DATE="$CURRENT_PRE_RELEASE_DATE"
              echo "é¢„å‘è¡Œç‰ˆæ— éœ€æ›´æ–°"
            fi
          else
            echo "é”™è¯¯: é¢„å‘è¡Œç‰ˆå¤„ç†å¤±è´¥"
            exit 1
          fi
        else
          NEW_PRE_RELEASE_VERSION="$CURRENT_PRE_RELEASE_VERSION"
          NEW_PRE_RELEASE_DATE="$CURRENT_PRE_RELEASE_DATE"
          echo "è·³è¿‡é¢„å‘è¡Œç‰ˆå¤„ç†"
        fi

        # æ›´æ–°ç‰ˆæœ¬æ•°æ®
        NEW_VERSION_DATA=$(echo "$CURRENT_VERSION_DATA" | jq \
            --arg stable_key "$STABLE_KEY_NAME" \
            --arg stable_value "$NEW_STABLE_VERSION,$NEW_STABLE_DATE" \
            --arg pre_key "$PRE_RELEASE_KEY_NAME" \
            --arg pre_value "$NEW_PRE_RELEASE_VERSION,$NEW_PRE_RELEASE_DATE" \
            '.[$stable_key] = $stable_value | .[$pre_key] = $pre_value')
            
        NEW_VERSION_CONTENT=$(echo "$NEW_VERSION_DATA" | jq -r .)

        echo "æ›´æ–°åçš„ç‰ˆæœ¬æ–‡ä»¶å†…å®¹:"
        echo "$NEW_VERSION_CONTENT"
        
        # æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        VERSION_CHANGED=true
        if [ -f "$VERSION_FILE" ]; then
          CURRENT_VERSION_CONTENT=$(cat "$VERSION_FILE" | jq -c . 2>/dev/null || echo "{}")
          if [ "$(echo "$NEW_VERSION_DATA" | jq -c .)" = "$CURRENT_VERSION_CONTENT" ]; then
            echo "ç‰ˆæœ¬æ–‡ä»¶å†…å®¹æœªå˜åŒ–"
            VERSION_CHANGED=false
          fi
        fi
        
        # ä¿å­˜ç‰ˆæœ¬æ–‡ä»¶
        if $VERSION_CHANGED; then
          echo "$NEW_VERSION_CONTENT" > version.txt
          echo "ç‰ˆæœ¬æ–‡ä»¶å·²æ›´æ–°"
        fi

        # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ›´æ”¹éœ€è¦æäº¤
        CHANGES_DETECTED=false
        if [ "$STABLE_NEED_UPDATE" = true ] || [ "$PRE_RELEASE_NEED_UPDATE" = true ] || [ "$VERSION_CHANGED" = true ]; then
          CHANGES_DETECTED=true
        fi

        if [ "$CHANGES_DETECTED" = true ]; then
          echo "æäº¤æ›´æ”¹åˆ°Gitä»“åº“..."
          git add apk/ version.txt
          
          commit_msg="æ›´æ–°APK: "
          if [ "$STABLE_NEED_UPDATE" = true ]; then
            commit_msg+="ç¨³å®šç‰ˆ=$NEW_STABLE_VERSION "
          fi
          if [ "$PRE_RELEASE_NEED_UPDATE" = true ]; then
            commit_msg+="é¢„å‘è¡Œç‰ˆ=$NEW_PRE_RELEASE_VERSION "
          fi
          if [ "$VERSION_CHANGED" = true ]; then
            commit_msg+="ç‰ˆæœ¬æ–‡ä»¶æ›´æ–°"
          fi
          
          git commit -m "$commit_msg"
          
          MAX_RETRIES=3
          RETRY_DELAY=10
          for i in $(seq 1 $MAX_RETRIES); do
            echo "æ¨é€æ›´æ”¹ (å°è¯• $i/$MAX_RETRIES)..."
            git pull --rebase origin main
            if git push origin main; then
              echo "æ¨é€æˆåŠŸ"
              break
            else
              echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
              sleep $RETRY_DELAY
            fi
            if [ $i -eq $MAX_RETRIES ]; then
              echo "é”™è¯¯: æ¨é€å¤±è´¥ï¼Œè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            fi
          done
        else
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
        fi

        echo "åŒæ­¥å®Œæˆ! çŠ¶æ€: æˆåŠŸ"
        echo "ç¨³å®šç‰ˆ: $STABLE_TARGET_FILENAME ($NEW_STABLE_VERSION, $NEW_STABLE_DATE)"
        if [ "$SYNC_PRE_RELEASE" = true ]; then
          echo "é¢„å‘è¡Œç‰ˆ: $PRE_RELEASE_TARGET_FILENAME ($NEW_PRE_RELEASE_VERSION, $NEW_PRE_RELEASE_DATE)"
        fi
        
        exit 0

    # é‡Šæ”¾ä»“åº“é”
    - name: Release Repository Lock
      if: always()
      uses: softprops/turnstyle@v1
      with:
        continue-on-error: true
        action: unlock
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const message = `ğŸš¨ Hiddify APKåŒæ­¥å¤±è´¥ï¼å·¥ä½œæµè¿è¡Œ: [${{ github.workflow }} #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          })

  cleanup_self:
    name: Cleanup Self Workflow History
    runs-on: ubuntu-latest
    needs: sync
    if: ${{ always() }}
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          keep_minimum_runs: 0
          retain_days: 0
          delete_workflow_pattern: "Hiddify APK Sync from Source Repository"
          repository: ${{ github.repository }}